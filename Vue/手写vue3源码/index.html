<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>手写Vue3核心源码 | SZX的开发笔记</title><meta name="keywords" content="vue"><meta name="author" content="SZX"><meta name="copyright" content="SZX"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Monorepo介绍Monorepo 是管理项目代码的一种方式，只在一个仓库中管理多个模块&#x2F;包  一个仓库可以维护多个模块，不用到处找仓库 方便版本管理和依赖管理，模块之间的引用和调用都非常方便   缺点：仓库的体积变大，打包和安装依赖都会变慢  例如Vue3源码、element-plus 等都已经采用这种方式来管理项目 了解更多可以查看这个文档：https:&#x2F;&#x2F;www.modb.pro&#x2F;db&#x2F;6">
<meta property="og:type" content="article">
<meta property="og:title" content="手写Vue3核心源码">
<meta property="og:url" content="https://songzx0106.github.io/Vue/%E6%89%8B%E5%86%99vue3%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="SZX的开发笔记">
<meta property="og:description" content="Monorepo介绍Monorepo 是管理项目代码的一种方式，只在一个仓库中管理多个模块&#x2F;包  一个仓库可以维护多个模块，不用到处找仓库 方便版本管理和依赖管理，模块之间的引用和调用都非常方便   缺点：仓库的体积变大，打包和安装依赖都会变慢  例如Vue3源码、element-plus 等都已经采用这种方式来管理项目 了解更多可以查看这个文档：https:&#x2F;&#x2F;www.modb.pro&#x2F;db&#x2F;6">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://songzx0106.github.io/images/ys03.png">
<meta property="article:published_time" content="2024-03-09T02:40:34.000Z">
<meta property="article:modified_time" content="2024-03-14T01:57:42.297Z">
<meta property="article:author" content="SZX">
<meta property="article:tag" content="vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://songzx0106.github.io/images/ys03.png"><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://songzx0106.github.io/Vue/%E6%89%8B%E5%86%99vue3%E6%BA%90%E7%A0%81/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":5000,"languages":{"author":"作者: SZX","link":"链接: ","source":"来源: SZX的开发笔记","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/jquery.min.js',
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-14 09:57:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2467717_jlvw8717b8.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/images/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">152</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/ys03.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">SZX的开发笔记</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">手写Vue3核心源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-09T02:40:34.000Z" title="发表于 2024-03-09 10:40:34">2024-03-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-14T01:57:42.297Z" title="更新于 2024-03-14 09:57:42">2024-03-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>97分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="手写Vue3核心源码"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Monorepo介绍"><a href="#Monorepo介绍" class="headerlink" title="Monorepo介绍"></a>Monorepo介绍</h2><p><code>Monorepo</code> 是管理项目代码的一种方式，只在一个仓库中管理多个模块/包</p>
<ul>
<li>一个仓库可以维护多个模块，不用到处找仓库</li>
<li>方便版本管理和依赖管理，模块之间的引用和调用都非常方便</li>
</ul>
<blockquote>
<p>缺点：仓库的体积变大，打包和安装依赖都会变慢</p>
</blockquote>
<p>例如Vue3源码、element-plus 等都已经采用这种方式来管理项目</p>
<p>了解更多可以查看这个文档：<a target="_blank" rel="noopener" href="https://www.modb.pro/db/626876">https://www.modb.pro/db/626876</a></p>
<h2 id="Vue3项目结构"><a href="#Vue3项目结构" class="headerlink" title="Vue3项目结构"></a>Vue3项目结构</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">                            +---------------------+</span><br><span class="line">                            |                     |</span><br><span class="line">                            |  @vue/compiler-sfc  |</span><br><span class="line">                            |                     |</span><br><span class="line">                            +-----+--------+------+</span><br><span class="line">                                  |        |</span><br><span class="line">                                  v        v</span><br><span class="line">               +---------------------+    +----------------------+</span><br><span class="line">               |                     |    |                      |</span><br><span class="line">     +--------&gt;|  @vue/compiler-dom  +---&gt;|  @vue/compiler-core  |</span><br><span class="line">     |         |                     |    |                      |</span><br><span class="line">+----+----+    +---------------------+    +----------------------+</span><br><span class="line">|         |</span><br><span class="line">|   vue   |</span><br><span class="line">|         |</span><br><span class="line">+----+----+   +---------------------+    +----------------------+    +-------------------+</span><br><span class="line">    |         |                     |    |                      |    |                   |</span><br><span class="line">    +--------&gt;|  @vue/runtime-dom   +---&gt;|  @vue/runtime-core   +---&gt;|  @vue/reactivity  |</span><br><span class="line">              |                     |    |                      |    |                   |</span><br><span class="line">              +---------------------+    +----------------------+    +-------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><code>reactivity</code>: 响应式系统</li>
<li><code>runtime-core</code>:与平台无关的运行时核心 (可以创建针对特定平台的运行时 - 自定义渲染器)</li>
<li><code>runtime-dom</code>: 针对浏览器的运行时。包括DOM API，属性，事件处理等</li>
<li><code>runtime-test</code>:用于测试</li>
<li><code>server-renderer</code>:用于服务器端渲染</li>
<li><code>compiler-core</code>:与平台无关的编译器核心</li>
<li><code>compiler-dom</code>: 针对浏览器的编译模块</li>
<li><code>compiler-ssr:</code> 针对服务端渲染的编译模块</li>
<li><code>compiler-sfc</code>: 针对单文件解析</li>
<li><code>size-check</code>:用来测试代码体积</li>
<li><code>template-explorer</code>：用于调试编译器输出的开发工具</li>
<li><code>shared</code>：多个包之间共享的内容</li>
<li><code>vue</code>:完整版本,包括运行时和编译器</li>
</ul>
<h2 id="Vue3构建流程搭建"><a href="#Vue3构建流程搭建" class="headerlink" title="Vue3构建流程搭建"></a>Vue3构建流程搭建</h2><p>vue3采用 monorepo 的方式，目前只有 yarn 支持，所以我们需要使用 yarn 来构建项目</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>找一个空文件夹执行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn init -y</span><br></pre></td></tr></table></figure>

<p>然后修改生成的 <code>package.json</code> 文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;private&quot;</span>:<span class="string">&quot;true&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;workspaces&quot;</span>:[</span><br><span class="line">    <span class="string">&quot;packages/*&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zf-vue3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.ts&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@rollup/plugin-json&quot;</span>: <span class="string">&quot;^4.1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@rollup/plugin-node-resolve&quot;</span>: <span class="string">&quot;^13.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;execa&quot;</span>: <span class="string">&quot;^5.1.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rollup&quot;</span>: <span class="string">&quot;^2.52.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rollup-plugin-typescript2&quot;</span>: <span class="string">&quot;^0.30.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span>: <span class="string">&quot;^4.3.4&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>private</code> 表示这是一个私有的</p>
</li>
<li><p><code>workspaces</code> 声明工作区间，将来我们的包都在 packages 这个文件夹下面</p>
</li>
<li><p>修改了一下 name</p>
</li>
</ul>
<p>然后执行安装命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn install</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>依赖</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>typescript</td>
<td>支持typescript</td>
</tr>
<tr>
<td>rollup</td>
<td>打包工具</td>
</tr>
<tr>
<td>rollup-plugin-typescript2</td>
<td>rollup 和 ts的 桥梁</td>
</tr>
<tr>
<td>@rollup/plugin-node-resolve</td>
<td>解析node第三方模块</td>
</tr>
<tr>
<td>@rollup/plugin-json</td>
<td>支持引入json</td>
</tr>
<tr>
<td>execa</td>
<td>开启子进程方便执行命令</td>
</tr>
</tbody></table>
<h3 id="声明子文件"><a href="#声明子文件" class="headerlink" title="声明子文件"></a>声明子文件</h3><h4 id="reactivity"><a href="#reactivity" class="headerlink" title="reactivity"></a>reactivity</h4><p>新建  <code>packages\reactivity\src\index.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Reactivity = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    Reactivity</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>packages\reactivity</code> 位置执行 <code>yarn init -y</code> 初始化 <code>package.json</code> 文件</p>
<p>接着修改 <code>package.json</code> 文件</p>
<p>packages/reactivity/package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;@vue/reactivity&quot;</span>, <span class="comment">// 设置包的名称</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.ts&quot;</span>, <span class="comment">// 在node环境中使用时会找 main 属性对应的地址</span></span><br><span class="line">  <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;dist/reactivity.esm-bundler.js&quot;</span>, <span class="comment">// es6模式下 import @vue/reactivity --&gt; 使用的是这个地址</span></span><br><span class="line">  <span class="attr">&quot;buildOptions&quot;</span>:&#123; <span class="comment">// 自定义打包配置</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;VueReactivity&quot;</span>, <span class="comment">// 全局名称配置，通过 script 标签引入时，全局就会有 VueReactivity 这个名字</span></span><br><span class="line">    <span class="attr">&quot;formats&quot;</span>: [<span class="string">&quot;esm-bundler&quot;</span>,<span class="string">&quot;cjs&quot;</span>,<span class="string">&quot;global&quot;</span>] <span class="comment">// 打包模式，支持三种模式，node、es6、全局模块</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="shared"><a href="#shared" class="headerlink" title="shared"></a>shared</h4><p>新建  <code>packages\shared\src\index.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Shared = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    Shared</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>packages\shared</code> 位置执行 <code>yarn init -y</code> 初始化 <code>package.json</code> 文件</p>
<p>接着修改 <code>package.json</code> 文件</p>
<p>packages/shared/package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;@vue/shared&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.ts&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;dist/shared.esm-bundler.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;buildOptions&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;VueShared&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;formats&quot;</span>: [<span class="string">&quot;esm-bundler&quot;</span>,<span class="string">&quot;cjs&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编译脚本、rollup、ts配置"><a href="#编译脚本、rollup、ts配置" class="headerlink" title="编译脚本、rollup、ts配置"></a>编译脚本、rollup、ts配置</h3><p>package.json 添加脚本配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;dev&quot;:&quot;node scripts/dev.js&quot;,</span><br><span class="line">    &quot;build&quot;:&quot;node scripts/build.js&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>scripts/dev.js</p>
<p>这个文件只做某个包的打包，给 rollup 传入TARGET环境变量，生成 rollup 配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> execa = <span class="built_in">require</span>(<span class="string">&#x27;execa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> target = <span class="string">&quot;reactivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">build(target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 执行rollup命令，并传入参数，其中TARGET:$&#123;target&#125;表示目标环境</span></span><br><span class="line">    <span class="comment">// stdio: &#x27;inherit&#x27; 将子进程的日志输出到主进程</span></span><br><span class="line">    <span class="keyword">await</span> execa(<span class="string">&#x27;rollup&#x27;</span>, [<span class="string">&#x27;-cw&#x27;</span>, <span class="string">`--environment`</span>, <span class="string">`TARGET:<span class="subst">$&#123;target&#125;</span>`</span>], &#123; <span class="attr">stdio</span>: <span class="string">&#x27;inherit&#x27;</span> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>scripts/build.js</p>
<p>这个文件用来打包 packages 文件夹下所有的包</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> execa = <span class="built_in">require</span>(<span class="string">&#x27;execa&#x27;</span>); <span class="comment">// 开启子进程打包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤packages目录下的文件，只要保留文件夹</span></span><br><span class="line"><span class="keyword">const</span> targets = fs.readdirSync(<span class="string">&quot;packages&quot;</span>).filter(<span class="function"><span class="params">f</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// fs.statSync(`packages/reactivity`).isDirectory() 如果是文件则返回true</span></span><br><span class="line">    <span class="keyword">if</span>(!fs.statSync(<span class="string">`packages/<span class="subst">$&#123;f&#125;</span>`</span>).isDirectory())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对不同的包进行依次打包</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params">target</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">await</span> execa(<span class="string">&quot;rollup&quot;</span>,[<span class="string">&quot;-c&quot;</span>,<span class="string">`--environment`</span>,<span class="string">`TARGET:<span class="subst">$&#123;target&#125;</span>`</span>],&#123;</span><br><span class="line">        stdio: <span class="string">&quot;inherit&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历所有的包，调用build方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runParallel</span>(<span class="params">targets,buildFn</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line">    targets.forEach(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">        result.push(buildFn(item))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">runParallel(targets,build).then(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;打包完成&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>rollup.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> json <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> resolvePlugin <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-node-resolve&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> ts <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-typescript2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到packages</span></span><br><span class="line"><span class="keyword">const</span> packagesDir = path.resolve(__dirname, <span class="string">&quot;packages&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据环境变量中的TARGET，找到模块中对应的package.json</span></span><br><span class="line"><span class="keyword">const</span> packageDir = path.resolve(packagesDir, process.env.TARGET);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取到每个模块下面的package.json</span></span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function">(<span class="params">p</span>) =&gt;</span> path.resolve(packageDir, p);</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(resolve(<span class="string">&quot;package.json&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对打包类型做一个映射表，根据每个包的package.json中配置formats来格式化需要打包的内容</span></span><br><span class="line"><span class="keyword">const</span> outputConfig = &#123;</span><br><span class="line">  <span class="string">&quot;esm-bundler&quot;</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;process.env.TARGET&#125;</span>.esm-bundler.js`</span>),</span><br><span class="line">    format: <span class="string">&quot;es&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  cjs: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;process.env.TARGET&#125;</span>.cjs.js`</span>),</span><br><span class="line">    format: <span class="string">&quot;cjs&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">global</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;process.env.TARGET&#125;</span>.global.js`</span>),</span><br><span class="line">    format: <span class="string">&quot;iife&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = pkg.buildOptions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成rollup配置</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createConfig</span>(<span class="params">format, output</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 声明全局名称</span></span><br><span class="line">  output.name = options.name;</span><br><span class="line">  <span class="comment">// 生成sourcemap</span></span><br><span class="line">  output.sourcemap = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    input: resolve(<span class="string">`src/index.ts`</span>),</span><br><span class="line">    output,</span><br><span class="line">    plugins: [</span><br><span class="line">        json(), </span><br><span class="line">        ts(&#123;</span><br><span class="line">            tsconfig:path.resolve(__dirname, <span class="string">&quot;tsconfig.json&quot;</span>),</span><br><span class="line">        &#125;),</span><br><span class="line">        resolvePlugin(),</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历formats生成不同的打包文件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> options.formats.map(<span class="function">(<span class="params">format</span>) =&gt;</span> createConfig(format, outputConfig[format]));</span><br></pre></td></tr></table></figure>

<p>tsconfig.json</p>
<p>在根目录执行 <code>npx tsc --init</code> 先初始化一个 <code>tsconfig.json</code> 文件，然后添加如下内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;ESNEXT&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;ESNEXT&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;paths&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@vue/*&quot;</span>: [<span class="string">&quot;packages/*/src&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此我们就可以来尝试打包一下,输入命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn build</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240108172437702.png" alt="image-20240108172437702"></p>
<p>对比打包后的文件内容可以发现两个包下面生成的打包文件是不一样的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240108172539256.png" alt="image-20240108172539256"></p>
<h3 id="包之间的互相引用"><a href="#包之间的互相引用" class="headerlink" title="包之间的互相引用"></a>包之间的互相引用</h3><p>当我们执行 <code>yarn install</code> 后会自动的再 node_modules 中生成软连接</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240108172840053.png" alt="image-20240108172840053"></p>
<p>后面的箭头表示这是一个软连接。然后我们在代码里使用如下方式引入时</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Shared &#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Reactivity = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    Reactivity</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@vue/shared 指向的就是这个包所在的真实文件地址</p>
<h2 id="reactive-Api实现"><a href="#reactive-Api实现" class="headerlink" title="reactive Api实现"></a>reactive Api实现</h2><h3 id="四个核心的API"><a href="#四个核心的API" class="headerlink" title="四个核心的API"></a>四个核心的API</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive,shallowReactive,<span class="built_in">readonly</span>,shallowReadonly &#125; from <span class="string">&quot;vue&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>reactive：深层次的响应对象</li>
<li>shallowReactive：浅层响应对象，只会吧对象的第一层变成响应式的</li>
<li>readonly：对象是只读的</li>
<li>shallowReadonly：浅层对象只读</li>
</ul>
<h3 id="开启sourceMap"><a href="#开启sourceMap" class="headerlink" title="开启sourceMap"></a>开启sourceMap</h3><p>将 <code>tsconfig.json</code> 文件中的 sourceMap 打开并且设置成true，方便我们调试源码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;ESNEXT&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;ESNEXT&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span>: <span class="string">&quot;.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;paths&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;@vue/*&quot;</span>: [<span class="string">&quot;packages/*/src&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── example</span><br><span class="line">│   └── 1.reactivity-api.html  // 测试文件</span><br><span class="line">├── package.json</span><br><span class="line">├── packages</span><br><span class="line">│   ├── reactivity</span><br><span class="line">│   │   ├── package.json</span><br><span class="line">│   │   └── src</span><br><span class="line">│   │       ├── baseHandlers.ts</span><br><span class="line">│   │       ├── index.ts  // reactive核心方法文件，只做导出操作</span><br><span class="line">│   │       └── reactive.ts</span><br><span class="line">│   └── shared</span><br><span class="line">│       ├── package.json</span><br><span class="line">│       └── src</span><br><span class="line">│           └── index.ts // 公共功能</span><br><span class="line">├── rollup.config.js</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── build.js</span><br><span class="line">│   └── dev.js</span><br><span class="line">└── tsconfig.json</span><br></pre></td></tr></table></figure>

<h3 id="shared-src-index-ts"><a href="#shared-src-index-ts" class="headerlink" title="shared/src/index.ts"></a>shared/src/index.ts</h3><p>这个文件专门放置一些公共的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断一个数据是否是一个对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isObject</span> (<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并两个对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeObjects</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">U</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">obj1: T, obj2: U</span>): <span class="title">T</span> &amp; <span class="title">U</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(obj1, obj2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-index-ts"><a href="#reactivity-src-index-ts" class="headerlink" title="reactivity/src/index.ts"></a>reactivity/src/index.ts</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出四个核心方法</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  reactive,</span><br><span class="line">  shallowReactive,</span><br><span class="line">  readonly,</span><br><span class="line">  shallowReadonly,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-reactive-ts"><a href="#reactivity-src-reactive-ts" class="headerlink" title="reactivity/src/reactive.ts"></a>reactivity/src/reactive.ts</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  mutableHandlers,</span><br><span class="line">  readonlyHandlers,</span><br><span class="line">  shallowReactiveHandlers,</span><br><span class="line">  shallowReadonlyHandlers,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./baseHandlers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(target, <span class="literal">false</span>, mutableHandlers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(target, <span class="literal">false</span>, shallowReactiveHandlers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readonly</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(target, <span class="literal">true</span>, readonlyHandlers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowReadonly</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(target, <span class="literal">true</span>, shallowReadonlyHandlers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建两个映射map，存放已经代理过的数据</span></span><br><span class="line"><span class="comment">// WeakMap 可以自动垃圾回收，不用担心内存泄漏问题。并且key只能是对象类型</span></span><br><span class="line"><span class="keyword">const</span> reactiveMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">const</span> readlonlyMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建代理方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>target 需要被代理的对象 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否是只读的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>baseHandlers get set 方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createReactiveObject</span>(<span class="params">target, isReadonly, baseHandlers</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断这个数据是否是一个对象</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) <span class="keyword">return</span> target;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断这个对象是否被代理过,如果已经被代理过，则从map中获取数据</span></span><br><span class="line">  <span class="keyword">const</span> proxyMap = isReadonly ? readlonlyMap : reactiveMap;</span><br><span class="line">  <span class="keyword">const</span> existProxy = proxyMap.get(target);</span><br><span class="line">  <span class="keyword">if</span> (existProxy) <span class="keyword">return</span> existProxy;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理对象</span></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, baseHandlers);</span><br><span class="line">  proxyMap.set(proxy, target);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最后返回被代理的对象</span></span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-baseHandlers-ts"><a href="#reactivity-src-baseHandlers-ts" class="headerlink" title="reactivity/src/baseHandlers.ts"></a>reactivity/src/baseHandlers.ts</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject, mergeObjects &#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive, readonly &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽离出共用的set方法</span></span><br><span class="line"><span class="keyword">const</span> readonlyObj = &#123;</span><br><span class="line">  set: <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">`key:<span class="subst">$&#123;key&#125;</span> set 失败，因为这个对象是只读的`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截get的方法，柯里化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGetter</span>(<span class="params">isReadonly = <span class="literal">false</span>, isShallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个内部的方法参数来自于读取某个对象是，proxy传递进来的</span></span><br><span class="line"><span class="comment">   * target: 当前对象本身</span></span><br><span class="line"><span class="comment">   * key: 当前读取的key</span></span><br><span class="line"><span class="comment">   * receiver: 当前的代理对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, key, receiver</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 这里使用Reflect.get来获取对象，相当于 target[key]</span></span><br><span class="line">    <span class="comment">// 后续Object上的方法，会被迁移到Reflect上去，Reflect.getProptotypeof()</span></span><br><span class="line">    <span class="comment">// target[key] = value 的方式可能会设置失败，但是并不会返回报错，也没有返回标识来表示是否成功</span></span><br><span class="line">    <span class="comment">// Reflect 方法具备返回值，所以这里要使用 Reflect 来取值和set值</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReadonly) &#123;</span><br><span class="line">      <span class="comment">// 进行依赖收集，只有不是只读的对象才会进行依赖收集</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是shallow则只返回拿到的值，不进行深层次代理</span></span><br><span class="line">    <span class="keyword">if</span> (isShallow) <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果拿到的返回值仍然是一个对象，则进行递归响应式处理</span></span><br><span class="line">    <span class="comment">// 这里和vue2不同，vue2是上来就进行对象的递归响应式处理</span></span><br><span class="line">    <span class="comment">// vue3则是懒代理，只有到读取到这个对象的某个属性时，才会对这个对象进行响应式处理</span></span><br><span class="line">    <span class="keyword">if</span> (isObject(res)) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadonly ? readonly(res) : reactive(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截set的方法，柯里化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetter</span>(<span class="params">isShallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, key, value, receiver</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成不同的get方法</span></span><br><span class="line"><span class="keyword">const</span> get = createGetter();</span><br><span class="line"><span class="keyword">const</span> shallowGet = createGetter(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> readonlyGet = createGetter(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">const</span> shallowReadonlyGet = createGetter(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成不同的set方法</span></span><br><span class="line"><span class="keyword">const</span> set = createSetter();</span><br><span class="line"><span class="keyword">const</span> shallowSet = createSetter(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableHandlers = &#123;</span><br><span class="line">  get,</span><br><span class="line">  set,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shallowReactiveHandlers = &#123;</span><br><span class="line">  get: shallowGet,</span><br><span class="line">  set: shallowSet,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并两个对象，共用一个set方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> readonlyHandlers = mergeObjects(</span><br><span class="line">  &#123;</span><br><span class="line">    get: readonlyGet,</span><br><span class="line">  &#125;,</span><br><span class="line">  readonlyObj</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 合并两个对象，共用一个set方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shallowReadonlyHandlers = mergeObjects(</span><br><span class="line">  &#123;</span><br><span class="line">    get: shallowReadonlyGet,</span><br><span class="line">  &#125;,</span><br><span class="line">  readonlyObj</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="测试reactive-Api"><a href="#测试reactive-Api" class="headerlink" title="测试reactive Api"></a>测试reactive Api</h3><p>example/1.reactive.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/reactivity/dist/reactivity.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> &#123; reactive, shallowReactive, readonly, shallowReadonly &#125; =</span></span><br><span class="line">        VueReactivity;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> state = shallowReadonly(&#123; </span></span><br><span class="line"><span class="javascript">        name:<span class="string">&quot;李四&quot;</span>,</span></span><br><span class="line">        age:&#123;</span><br><span class="line">            n:18</span><br><span class="line">        &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">      state.name = 20</span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(state.age);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Effect依赖收集"><a href="#Effect依赖收集" class="headerlink" title="Effect依赖收集"></a>Effect依赖收集</h2><h3 id="effect-ts"><a href="#effect-ts" class="headerlink" title="effect.ts"></a>effect.ts</h3><p>packages/reactivity/src/effect.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span>, options: any = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effect = createReactiveEffect(fn, options);</span><br><span class="line">  <span class="keyword">if</span> (!options.lazy) &#123;</span><br><span class="line">    effect();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> activeEffect; <span class="comment">// 当前正在操作的effect</span></span><br><span class="line"><span class="keyword">const</span> effectStack = []; <span class="comment">// 使用一个栈来存储effect</span></span><br><span class="line"><span class="comment">// 创建一个响应式的effect，根据不同的属性创建不同的effect方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReactiveEffect</span>(<span class="params">fn, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effect = <span class="function"><span class="keyword">function</span> <span class="title">reactiveEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effect; <span class="comment">// 当前正在操作的effect</span></span><br><span class="line">      fn();</span><br><span class="line">      effectStack.push(effect);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      effectStack.pop();</span><br><span class="line">      activeEffect = effectStack[effectStack.length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effect.id = uid++; <span class="comment">// 制作一个effect标识，用于区分effect</span></span><br><span class="line">  effect._isEffect = <span class="literal">true</span>; <span class="comment">// 用于标识这个是响应式effect</span></span><br><span class="line">  effect.row = fn; <span class="comment">// 保留effect对应的原函数</span></span><br><span class="line">  effect.options = options; <span class="comment">// 保留effect的属性</span></span><br><span class="line">  <span class="keyword">return</span> effect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 依赖收集方法，在 effect 中读取属性时就会触发 get 方法</span></span><br><span class="line"><span class="comment">// 在get方法中将对象本身，以及当前的key传递过来</span></span><br><span class="line"><span class="comment">// 然后和effect进行对应关联</span></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, type, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!activeEffect) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用如下一个结构来进行属性和effect关联</span></span><br><span class="line">    <span class="comment">// new WeakMap( target, new Map( key, [effect1,effect2] ))</span></span><br><span class="line">    <span class="keyword">let</span> depTarget = targetMap.get(target)</span><br><span class="line">    <span class="keyword">if</span>(!depTarget)&#123;</span><br><span class="line">        targetMap.set(target, depTarget = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到的是一个set，存放的是属性对应的多个effect</span></span><br><span class="line">    <span class="keyword">let</span> depMap = depTarget.get(key)</span><br><span class="line">    <span class="keyword">if</span>(!depMap)&#123;</span><br><span class="line">        depTarget.set(key, depMap = <span class="keyword">new</span> <span class="built_in">Set</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    depMap.add(activeEffect)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="baseHandlers-ts"><a href="#baseHandlers-ts" class="headerlink" title="baseHandlers.ts"></a>baseHandlers.ts</h3><p>packages/reactivity/src/baseHandlers.ts</p>
<p>修改 createGetter 方法，在get时调用 effect.js 中的 track 方法，传入 target，type，key 进行响应式依赖收集</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ import &#123; track &#125; from &quot;./effect&quot;;</span></span><br><span class="line"><span class="addition">+ import &#123; TrackOpTypes &#125; from &quot;./operators&quot;;</span></span><br><span class="line"></span><br><span class="line">// 拦截get的方法，柯里化</span><br><span class="line">function createGetter(isReadonly = false, isShallow = false) &#123;</span><br><span class="line">  /**</span><br><span class="line">   * 这个内部的方法参数来自于读取某个对象是，proxy传递进来的</span><br><span class="line">   * target: 当前对象本身</span><br><span class="line">   * key: 当前读取的key</span><br><span class="line">   * receiver: 当前的代理对象</span><br><span class="line">   */</span><br><span class="line">  return function (target, key, receiver) &#123;</span><br><span class="line">    // 这里使用Reflect.get来获取对象，相当于 target[key]</span><br><span class="line">    // 后续Object上的方法，会被迁移到Reflect上去，Reflect.getProptotypeof()</span><br><span class="line">    // target[key] = value 的方式可能会设置失败，但是并不会返回报错，也没有返回标识来表示是否成功</span><br><span class="line">    // Reflect 方法具备返回值，所以这里要使用 Reflect 来取值和set值</span><br><span class="line">    const res = Reflect.get(target, key, receiver);</span><br><span class="line"></span><br><span class="line">    if (!isReadonly) &#123;</span><br><span class="line">      // 进行依赖收集，只有不是只读的对象才会进行依赖收集</span><br><span class="line"><span class="addition">+      track(target,TrackOpTypes.GET,key)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果是shallow则只返回拿到的值，不进行深层次代理</span><br><span class="line">    if (isShallow) return res;</span><br><span class="line"></span><br><span class="line">    // 如果拿到的返回值仍然是一个对象，则进行递归响应式处理</span><br><span class="line">    // 这里和vue2不同，vue2是上来就进行对象的递归响应式处理</span><br><span class="line">    // vue3则是懒代理，只有到读取到这个对象的某个属性时，才会对这个对象进行响应式处理</span><br><span class="line">    if (isObject(res)) &#123;</span><br><span class="line">      return isReadonly ? readonly(res) : reactive(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="operators-ts"><a href="#operators-ts" class="headerlink" title="operators.ts"></a>operators.ts</h3><p>packages/reactivity/src/operators.ts</p>
<p>定义一个枚举，用于区分场景</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置一个枚举</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum TrackOpTypes &#123;</span><br><span class="line">    GET</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="测试effect"><a href="#测试effect" class="headerlink" title="测试effect"></a>测试effect</h3><p>example/2.effect.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/reactivity/dist/reactivity.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123; effect,reactive &#125; = VueReactivity</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> state = reactive(&#123;<span class="attr">name</span>:<span class="string">&#x27;张三&#x27;</span>,<span class="attr">age</span>:<span class="number">18</span>&#125;)</span></span><br><span class="line"><span class="javascript">    effect(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        app.innerText = <span class="string">`<span class="subst">$&#123;state.name&#125;</span> + <span class="subst">$&#123;state.age&#125;</span>`</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最终生成的 targetMap 结构</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240109171018102.png" alt="image-20240109171018102"></p>
<h2 id="触发更新"><a href="#触发更新" class="headerlink" title="触发更新"></a>触发更新</h2><h3 id="修改createSetter方法"><a href="#修改createSetter方法" class="headerlink" title="修改createSetter方法"></a>修改createSetter方法</h3><p>修改 /reactivity/src/baseHandlers.ts 文件中的 createSetter 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  hasChange,</span><br><span class="line">  hasOwn,</span><br><span class="line">  isArray,</span><br><span class="line">  isIntegerKey,</span><br><span class="line">  isObject,</span><br><span class="line">  mergeObjects,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive, readonly &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TrackOpTypes, TriggerOpTypes &#125; <span class="keyword">from</span> <span class="string">&quot;./operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截set的方法，柯里化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetter</span>(<span class="params">isShallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, key, value, receiver</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取旧值</span></span><br><span class="line">    <span class="keyword">const</span> oldValue = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set数据时的时候更新这个key所收集的effect</span></span><br><span class="line">    <span class="comment">// 先判断target是否是一个数组并且key是否是数字字符串</span></span><br><span class="line">    <span class="comment">// 如果是则判断修改的key是否是在数组下标内</span></span><br><span class="line">    <span class="comment">// Number(key) &lt; target.length 表示当前修改的下标在原有数组内，因为此时的target还没有发生修改</span></span><br><span class="line">    <span class="comment">// 否则的话再去判断当前修改的key是否在target身上</span></span><br><span class="line">    <span class="keyword">let</span> hadKey =</span><br><span class="line">      isArray(target) &amp;&amp; isIntegerKey(key)</span><br><span class="line">        ? <span class="built_in">Number</span>(key) &lt; target.length</span><br><span class="line">        : hasOwn(target, key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改值，Reflect.set返回的是一个布尔值，true表示修改成功</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">      <span class="comment">// 新增</span></span><br><span class="line">      trigger(target, TriggerOpTypes.ADD, key, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 判断两个值不相等的情况</span></span><br><span class="line">      <span class="keyword">if</span> (hasChange(oldValue, value)) &#123;</span><br><span class="line">        <span class="comment">// 修改</span></span><br><span class="line">        trigger(target, TriggerOpTypes.SET, key, value, oldValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-operators-ts"><a href="#reactivity-src-operators-ts" class="headerlink" title="reactivity/src/operators.ts"></a>reactivity/src/operators.ts</h3><p>operators 文件中增加了一个枚举类,用于区分时新增一个属性还是修改一个属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set时用于区分时新增一个属性还是修改一个属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum TriggerOpTypes &#123;</span><br><span class="line">  ADD,</span><br><span class="line">  SET,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="shared-src-index-ts-1"><a href="#shared-src-index-ts-1" class="headerlink" title="shared/src/index.ts"></a>shared/src/index.ts</h3><p>公共方法增加了一些方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断一个数据是否是一个对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isObject</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;object&quot;</span> &amp;&amp; value !== <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并两个对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeObjects</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">U</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj1: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  obj2: U</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">T</span> &amp; <span class="title">U</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.assign(obj1, obj2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断数据是否是数组</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isArray</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: unknown</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">T</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断数据是否是函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isFunction</span>(<span class="params">value: unknown</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;function&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断数据是否是数字</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isNumber</span>(<span class="params">value: unknown</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;number&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断数据是否是字符串</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">value: unknown</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;string&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断一个字符串是否是数字字符串</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isIntegerKey</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(key) + <span class="string">&quot;&quot;</span> === key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断对象中是否有某个属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">hasOwn</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断两个数据是否相等</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">hasChange</span>(<span class="params">oldValue, newValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> oldValue !== newValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断数据是否是Symbol类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isSymbol</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&quot;symbol&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-effect-ts"><a href="#reactivity-src-effect-ts" class="headerlink" title="reactivity/src/effect.ts"></a>reactivity/src/effect.ts</h3><p>effect 中去增加一个 tagger 方法，此方法会根据传递进来的key和target，找到对应的 dep 进行更新，也就是会重新触发这个属性对应的 effect，从而实现页面更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isArray, isIntegerKey, isSymbol &#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TriggerOpTypes &#125; <span class="keyword">from</span> <span class="string">&quot;./operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新依赖的方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, type, key?, newValue?, oldValue?</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 得到当前对象对应的map</span></span><br><span class="line">  <span class="keyword">let</span> depMap = targetMap.get(target);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断这个target是否收集过依赖</span></span><br><span class="line">  <span class="keyword">if</span> (!depMap) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将所有的effect放在一个数组中，最终一起执行</span></span><br><span class="line">  <span class="keyword">let</span> effects = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> add = <span class="function">(<span class="params">effectsToAdd</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (effectsToAdd) &#123;</span><br><span class="line">      effectsToAdd.forEach(<span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">        effects.push(effect);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断当前操作的是否是数组</span></span><br><span class="line">  <span class="comment">// 并且修改的key是legth，则需要更新数组所收集到的effect</span></span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">&quot;length&quot;</span> &amp;&amp; <span class="built_in">Array</span>.isArray(target)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(depMap, <span class="string">&quot;depMapdepMap&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Map类型数据进行forEach遍历是，第一个是键值对的值，第二个是键</span></span><br><span class="line">    depMap.forEach(<span class="function">(<span class="params">deps, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// key &gt; newValue</span></span><br><span class="line">      <span class="comment">// 例如我effect中使用了 state.arr[2]，则收集到的依赖就会有一个key是2</span></span><br><span class="line">      <span class="comment">// 如果我更新时 state.arr.length = 1，则也要更新这个数组target所收集的依赖effect</span></span><br><span class="line">      <span class="keyword">if</span> (!isSymbol(key) &amp;&amp; (key === <span class="string">&quot;length&quot;</span> || key &gt; newValue)) &#123;</span><br><span class="line">        add(deps);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 这里可能是对象</span></span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      add(depMap.get(key));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是这种情况: state.arr[100] = 1</span></span><br><span class="line">    <span class="comment">// 这种情况表示更新的是数组的某个索引，此时key就是100</span></span><br><span class="line">    <span class="comment">// 但是100并不在原有数组的属性上，所以type是ADD</span></span><br><span class="line">    <span class="comment">// 去更新这个数组对应的length属性对应的effect</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> TriggerOpTypes.ADD:</span><br><span class="line">        <span class="keyword">if</span> (isArray(target) &amp;&amp; isIntegerKey(key)) &#123;</span><br><span class="line">          add(depMap.get(<span class="string">&quot;length&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  effects.forEach(<span class="function">(<span class="params">effect</span>) =&gt;</span> effect());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试触发更新"><a href="#测试触发更新" class="headerlink" title="测试触发更新"></a>测试触发更新</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/reactivity/dist/reactivity.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123; effect, reactive &#125; = VueReactivity;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> state = reactive(&#123; <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>, <span class="attr">arr</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;);</span></span><br><span class="line"><span class="javascript">    effect(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        app.innerHTML = <span class="string">`<span class="subst">$&#123;state.arr&#125;</span> + <span class="subst">$&#123;state.arr.length&#125;</span>`</span>;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">        state.arr.length = 100;</span><br><span class="line">    &#125;, 1000);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240109231817514.png" alt="image-20240109231817514"></p>
<h2 id="ref-Api实现"><a href="#ref-Api实现" class="headerlink" title="ref Api实现"></a>ref Api实现</h2><h3 id="四个API"><a href="#四个API" class="headerlink" title="四个API"></a>四个API</h3><p>ref 有关的API共有四个</p>
<ul>
<li>ref：将一个普通数据类型转成响应式的，如果穿过来的是一个对象，则会调用 reactive 进行响应式处理</li>
<li>shallowRef：浅层的ref</li>
<li>toRef：用法 <code>let refKey =toRef(object,key)</code> 将某个对象中的某一个属性变成响应式的，此时修改 <code>refKey.value = xxx</code> 相当于修改的就是 <code>object.key = xxx</code></li>
<li>toRefs：用法 <code>let &#123;key1,key2&#125; = toRefs(object)</code> 将某个对象中的所有属性变成响应式的，在对象解构时可以用这个方法，否则解构出来的属性会丢失响应式</li>
</ul>
<h3 id="reactivity-src-ref-ts"><a href="#reactivity-src-ref-ts" class="headerlink" title="reactivity/src/ref.ts"></a>reactivity/src/ref.ts</h3><p>下面是源码实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; hasChange, isArray, isObject &#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TrackOpTypes, TriggerOpTypes &#125; <span class="keyword">from</span> <span class="string">&quot;./operators&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createRef(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowRef</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createRef(value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isObject(value) ? reactive(value) : value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefImpl</span> </span>&#123;</span><br><span class="line">  public _value: any;</span><br><span class="line">  <span class="comment">// 产生的实例会被添加一个__v_isRef标记，表示这是一个ref</span></span><br><span class="line">  public __v_isRef = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 给参数前面加上一个public关键字</span></span><br><span class="line">  <span class="comment">// 会自动的帮我们实现：this.rowValue = rowValue; this.shallow = shallow</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">public rowValue, public shallow</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是shallowRef 则直接返回，否则判断是否是对象，如果是对象，则递归进行深层响应式处理</span></span><br><span class="line">    <span class="built_in">this</span>._value = shallow ? rowValue : convert(rowValue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// es6中的属性访问器，转成es5会转成 Object.defineProperty</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    track(<span class="built_in">this</span>, TrackOpTypes.GET, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasChange(<span class="built_in">this</span>._value, newValue)) &#123;</span><br><span class="line">      <span class="built_in">this</span>.rowValue = newValue;</span><br><span class="line">      <span class="built_in">this</span>._value = newValue;</span><br><span class="line">      trigger(<span class="built_in">this</span>, TriggerOpTypes.SET, <span class="string">&quot;value&quot;</span>, newValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRef</span>(<span class="params">value, shallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RefImpl(value, shallow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toRef返回的实例不再需要收集依赖，如果传过来的target已经被响应式了，则生成的ref还是响应式的</span></span><br><span class="line"><span class="comment">// 在set value时还是会走响应式中的set方法进行依赖更新，所以这里不需要依赖收集</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectRefImpl</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 产生的实例会被添加一个__v_isRef标记，表示这是一个ref</span></span><br><span class="line">  public __v_isRef = <span class="literal">true</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">public target, public key</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.target[<span class="built_in">this</span>.key];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>)&#123;</span><br><span class="line">    <span class="built_in">this</span>.target[<span class="built_in">this</span>.key] = newValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toRef实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRef</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ObjectRefImpl(target, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// toRefs实现</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRefs</span>(<span class="params">object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = isArray(object) ? <span class="keyword">new</span> <span class="built_in">Array</span>(object.length) : &#123;&#125;</span><br><span class="line">  <span class="comment">// 遍历每一个属性。让每一个属性都变成ref</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object) &#123;</span><br><span class="line">    res[key] = toRef(object, key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reactivity-src-index-ts-1"><a href="#reactivity-src-index-ts-1" class="headerlink" title="reactivity/src/index.ts"></a>reactivity/src/index.ts</h3><p>在 index 文件导入四个ref的四个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;ref,shallowRef,toRef,toRefs&#125; <span class="keyword">from</span> <span class="string">&quot;./ref&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试ref"><a href="#测试ref" class="headerlink" title="测试ref"></a>测试ref</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100px;height: 100px;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/reactivity/dist/reactivity.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123; ref,effect,reactive,toRef,toRefs &#125; = VueReactivity;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="comment">// ref测试</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> color = ref(<span class="string">&quot;red&quot;</span>)</span></span><br><span class="line"><span class="javascript">    effect(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line">        app1.style.backgroundColor = color.value</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        color.value = <span class="string">&quot;blue&quot;</span></span></span><br><span class="line">    &#125;,1000)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="comment">// toRefs测试</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> state = reactive(&#123;</span></span><br><span class="line"><span class="javascript">        name:<span class="string">&quot;王五&quot;</span>,</span></span><br><span class="line">        age:12</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;name,age&#125; = toRefs(state)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    effect(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        app.innerHTML = <span class="string">`<span class="subst">$&#123;name.value&#125;</span> - <span class="subst">$&#123;age.value&#125;</span>`</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        name.value = <span class="string">&quot;张三123&quot;</span></span></span><br><span class="line">    &#125;,1000)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240110140402875.png" alt="image-20240110140402875"></p>
<h2 id="computed源码实现"><a href="#computed源码实现" class="headerlink" title="computed源码实现"></a>computed源码实现</h2><p>实现流程</p>
<blockquote>
<ol>
<li>当访问计算属性的value时要把当前计算属性所依赖的effect收集起来</li>
<li>当计算属性中所依赖的属性发生变化时，会走set方法，会遍历所依赖属性收集的effect并执行</li>
<li>执行effect中如果发现effect的属性中存在scheduler方法，则会执行scheduler方法</li>
<li>在计算属性的scheduler方法中会重置_dirty的值，并执行trigger方法_</li>
<li>在trigger方法中会执行当前计算属性收集的effect，从而重新读取value属性触发get方法</li>
<li>执行get方法时因为已经重置了_dirty的值，所以会重新执行getter方法得到最新值并返回</li>
<li>触发get方法后会再次收集依赖等待下次调用</li>
</ol>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算属性实现原理</span></span><br><span class="line"><span class="keyword">import</span> &#123;isFunction&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;effect, track, trigger&#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;TrackOpTypes, TriggerOpTypes&#125; <span class="keyword">from</span> <span class="string">&quot;./operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedRef</span></span>&#123;</span><br><span class="line">    public _dirty = <span class="literal">true</span> <span class="comment">// 标记值是否需要更新，为true时需要重新走getter方法读取最新值</span></span><br><span class="line">    public effect</span><br><span class="line">    public _value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">getter,public setter</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 2.当计算属性中所依赖的属性发生变化时，会走set方法，会遍历所依赖属性收集的effect并执行</span></span><br><span class="line">        <span class="comment">// 3.执行effect中如果发现effect的属性中存在scheduler方法，则会执行scheduler方法</span></span><br><span class="line">        <span class="comment">// 4.在计算属性的scheduler方法中会重置_dirty的值，并执行trigger方法</span></span><br><span class="line">        <span class="comment">// 5.在trigger方法中会执行当前计算属性收集的effect，从而重新读取value属性触发get方法</span></span><br><span class="line">        <span class="comment">// 6.执行get方法时因为已经重置了_dirty的值，所以会重新执行getter方法得到最新值并返回</span></span><br><span class="line">        <span class="comment">// 7.触发get方法后会再次收集依赖等待下次调用</span></span><br><span class="line">        <span class="built_in">this</span>.effect = effect(getter,&#123;</span><br><span class="line">            lazy:<span class="literal">true</span>,</span><br><span class="line">            scheduler:<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">this</span>._dirty)&#123;</span><br><span class="line">                    <span class="built_in">this</span>._dirty = <span class="literal">true</span></span><br><span class="line">                    trigger(<span class="built_in">this</span>,TriggerOpTypes.SET,<span class="string">&quot;value&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>()&#123;</span><br><span class="line">        <span class="comment">// 实现数据缓存，多次获取计算属性的值不会使getter触发多次</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>._dirty)&#123;</span><br><span class="line">            <span class="built_in">this</span>._value = <span class="built_in">this</span>.effect()</span><br><span class="line">            <span class="built_in">this</span>._dirty = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1. 当访问计算属性的value时要把当前计算属性所依赖的effect收集起来</span></span><br><span class="line">        track(<span class="built_in">this</span>,TrackOpTypes.GET,<span class="string">&quot;value&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.setter(newValue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">getterOrOptions</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> getter;</span><br><span class="line">    <span class="keyword">let</span> setter;</span><br><span class="line">    <span class="comment">// 判断计算属性传递进来的值是否是是一个方法，如果是一个方法，则不能再给这个计算属性set值</span></span><br><span class="line">    <span class="keyword">if</span>(isFunction(getterOrOptions))&#123;</span><br><span class="line">        getter = getterOrOptions</span><br><span class="line">        setter = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;computed value must be readonly&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 如果是对象，则取get和set</span></span><br><span class="line">        getter = getterOrOptions.get</span><br><span class="line">        setter = getterOrOptions.set</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ComputedRef(getter,setter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改  packages/reactivity/src/effect.ts</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">import &#123; isArray, isIntegerKey, isSymbol &#125; from &quot;@vue/shared&quot;;</span><br><span class="line">import &#123; TriggerOpTypes &#125; from &quot;./operators&quot;;</span><br><span class="line"></span><br><span class="line">export function effect(fn: Function, options: any = &#123;&#125;) &#123;</span><br><span class="line">  const effect = createReactiveEffect(fn, options);</span><br><span class="line">  if (!options.lazy) &#123;</span><br><span class="line">    effect();</span><br><span class="line">  &#125;</span><br><span class="line">  return effect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let uid = 0;</span><br><span class="line">let activeEffect; // 当前正在操作的effect</span><br><span class="line">const effectStack = []; // 使用一个栈来存储effect</span><br><span class="line">// 创建一个响应式的effect，根据不同的属性创建不同的effect方法</span><br><span class="line">function createReactiveEffect(fn, options) &#123;</span><br><span class="line">  const effect = function reactiveEffect() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      activeEffect = effect; // 当前正在操作的effect</span><br><span class="line">      effectStack.push(effect);</span><br><span class="line"><span class="addition">+      return fn();</span></span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      effectStack.pop();</span><br><span class="line">      activeEffect = effectStack[effectStack.length - 1];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effect.id = uid++; // 制作一个effect标识，用于区分effect</span><br><span class="line">  effect._isEffect = true; // 用于标识这个是响应式effect</span><br><span class="line">  effect.row = fn; // 保留effect对应的原函数</span><br><span class="line">  effect.options = options; // 保留effect的属性</span><br><span class="line">  return effect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 依赖收集方法，在 effect 中读取属性时就会触发 get 方法</span><br><span class="line">// 在get方法中将对象本身，以及当前的key传递过来</span><br><span class="line">// 然后和effect进行对应关联</span><br><span class="line">const targetMap = new WeakMap();</span><br><span class="line">export function track(target, type, key) &#123;</span><br><span class="line">  if (!activeEffect) return;</span><br><span class="line"></span><br><span class="line">  // 使用如下一个结构来进行属性和effect关联</span><br><span class="line">  // new WeakMap( target, new Map( key, [effect1,effect2] ))</span><br><span class="line">  let depTarget = targetMap.get(target);</span><br><span class="line">  if (!depTarget) &#123;</span><br><span class="line">    targetMap.set(target, (depTarget = new Map()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 拿到的是一个set，存放的是属性对应的多个effect</span><br><span class="line">  let depMap = depTarget.get(key);</span><br><span class="line">  if (!depMap) &#123;</span><br><span class="line">    depTarget.set(key, (depMap = new Set()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  depMap.add(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 更新依赖的方法</span><br><span class="line">export function trigger(target, type, key?, newValue?, oldValue?) &#123;</span><br><span class="line">  // 得到当前对象对应的map</span><br><span class="line">  let depMap = targetMap.get(target);</span><br><span class="line"></span><br><span class="line">  // 判断这个target是否收集过依赖</span><br><span class="line">  if (!depMap) return;</span><br><span class="line"></span><br><span class="line">  // 将所有的effect放在一个数组中，最终一起执行</span><br><span class="line">  let effects = [];</span><br><span class="line"></span><br><span class="line">  const add = (effectsToAdd) =&gt; &#123;</span><br><span class="line">    console.log(effectsToAdd,&#x27;effectsToAddeffectsToAdd&#x27;)</span><br><span class="line">    if (effectsToAdd) &#123;</span><br><span class="line">      effectsToAdd.forEach((effect) =&gt; &#123;</span><br><span class="line">        effects.push(effect);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  // 判断当前操作的是否是数组</span><br><span class="line">  // 并且修改的key是legth，则需要更新数组所收集到的effect</span><br><span class="line">  if (key <span class="comment">=== &quot;length&quot; &amp;&amp; Array.isArray(target)) &#123;</span></span><br><span class="line">    // console.log(depMap, &quot;depMapdepMap&quot;);</span><br><span class="line"></span><br><span class="line">    // Map类型数据进行forEach遍历是，第一个是键值对的值，第二个是键</span><br><span class="line">    depMap.forEach((deps, key) =&gt; &#123;</span><br><span class="line">      // key &gt; newValue</span><br><span class="line">      // 例如我effect中使用了 state.arr[2]，则收集到的依赖就会有一个key是2</span><br><span class="line">      // 如果我更新时 state.arr.length = 1，则也要更新这个数组target所收集的依赖effect</span><br><span class="line">      if (!isSymbol(key) &amp;&amp; (key <span class="comment">=== &quot;length&quot; || key &gt; newValue)) &#123;</span></span><br><span class="line">        add(deps);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 这里可能是对象</span><br><span class="line">    if (key !== undefined) &#123;</span><br><span class="line">      add(depMap.get(key));</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果是这种情况: state.arr[100] = 1</span><br><span class="line">    // 这种情况表示更新的是数组的某个索引，此时key就是100</span><br><span class="line">    // 但是100并不在原有数组的属性上，所以type是ADD</span><br><span class="line">    // 去更新这个数组对应的length属性对应的effect</span><br><span class="line">    switch (type) &#123;</span><br><span class="line">      case TriggerOpTypes.ADD:</span><br><span class="line">        if (isArray(target) &amp;&amp; isIntegerKey(key)) &#123;</span><br><span class="line">          add(depMap.get(&quot;length&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+  effects.forEach((effect) =&gt; &#123;</span></span><br><span class="line"><span class="addition">+    if(effect.options.scheduler)&#123;</span></span><br><span class="line"><span class="addition">+      effect.options.scheduler()</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+      effect()</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="runtimeDom和runtimeCore"><a href="#runtimeDom和runtimeCore" class="headerlink" title="runtimeDom和runtimeCore"></a>runtimeDom和runtimeCore</h2><ul>
<li>runtimeDom专门用来用来操作DOM，例如style属性的添加和删除，class类的添加和删除，属性、事件等等</li>
<li>runtimeCore专门用来生成虚拟节点并挂载，会调用runtimeDom中提供的方法</li>
</ul>
<h3 id="新建runtime-dom包"><a href="#新建runtime-dom包" class="headerlink" title="新建runtime-dom包"></a>新建runtime-dom包</h3><p>新建 <code>packages/runtime-dom</code> 文件夹</p>
<p>然后创建 <code>src/index.ts</code> 文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name:<span class="string">&quot;runtime-dom&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个<code>package.json </code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;@vue/runtime-dom&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;dist/runtime-dom.esm-bundler.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;buildOptions&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;VueRuntimeDom&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;formats&quot;</span>: [<span class="string">&quot;esm-bundler&quot;</span>,<span class="string">&quot;cjs&quot;</span>,<span class="string">&quot;global&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="新建runtime-core包"><a href="#新建runtime-core包" class="headerlink" title="新建runtime-core包"></a>新建runtime-core包</h3><p>新建 <code>packages/runtime-core</code> 文件夹</p>
<p>然后创建 <code>src/index.ts</code> 文件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name:<span class="string">&quot;runtime-core&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个<code>package.json </code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;@vue/runtime-core&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;dist/runtime-core.esm-bundler.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;buildOptions&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;VueRuntimeCore&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;formats&quot;</span>: [<span class="string">&quot;esm-bundler&quot;</span>,<span class="string">&quot;cjs&quot;</span>,<span class="string">&quot;global&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>执行 <code>yarn install</code> 将 <code>runtime-dom</code> 和 <code>runtime-core</code> 加入到 <code>node_modules</code> 中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn install</span><br><span class="line"></span><br><span class="line">yarn build</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240128170026833.png" alt="image-20240128170026833"></p>
<p>观察是否生成 dist 文件，有说明包创建成功</p>
<h3 id="patchNode"><a href="#patchNode" class="headerlink" title="patchNode"></a>patchNode</h3><p>新建 <code>runtime-dom/src/nodeOpts.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个文件专门存放用于操作节点的各种方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeOpts = &#123;</span><br><span class="line">    <span class="comment">// 创建一个元素</span></span><br><span class="line">    createElement: <span class="function">(<span class="params">target</span>) =&gt;</span> <span class="built_in">document</span>.createElement(target),</span><br><span class="line">    <span class="comment">// 删除一个元素</span></span><br><span class="line">    remove: <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 1.先找到这个元素的父元素</span></span><br><span class="line">        <span class="keyword">const</span> parent = target.parentNode</span><br><span class="line">        <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">            parent.removeChild(target)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在指定位置插入一个元素</span></span><br><span class="line">    insert: <span class="function">(<span class="params">target, parent, anchor = <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">        parent.insertBefore(target, anchor)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 查找一个元素</span></span><br><span class="line">    querySelector: <span class="function">(<span class="params">selector</span>) =&gt;</span> <span class="built_in">document</span>.querySelector(selector),</span><br><span class="line">    <span class="comment">// 设置一个标签元素的文本内容</span></span><br><span class="line">    setElementText: <span class="function">(<span class="params">el, text</span>) =&gt;</span> el.textContent = text,</span><br><span class="line">    <span class="comment">// 创建一个文本元素</span></span><br><span class="line">    createText: <span class="function">(<span class="params">text</span>) =&gt;</span> <span class="built_in">document</span>.createTextNode(text),</span><br><span class="line">    <span class="comment">// 设置文本元素的内容</span></span><br><span class="line">    setText: <span class="function">(<span class="params">node, text</span>) =&gt;</span> node.nodeValue = text</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="patchProps"><a href="#patchProps" class="headerlink" title="patchProps"></a>patchProps</h3><p>新建 <code>runtime-dom/src/patchProps.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法用于给某个元素添加对应的属性</span></span><br><span class="line"><span class="keyword">import</span> &#123;patchStyle&#125; <span class="keyword">from</span> <span class="string">&quot;./modules/style&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;patchClass&#125; <span class="keyword">from</span> <span class="string">&quot;./modules/class&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;patchEvent&#125; <span class="keyword">from</span> <span class="string">&quot;./modules/event&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;patchAttr&#125; <span class="keyword">from</span> <span class="string">&quot;./modules/attr&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> patchProps = <span class="function">(<span class="params">el, key, prevValue, newValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;style&quot;</span>:</span><br><span class="line">            <span class="comment">// 调用patchStyle方法来更新样式</span></span><br><span class="line">            patchStyle(el,prevValue,newValue)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;class&quot;</span>:</span><br><span class="line">            <span class="comment">// 调用patchClass方法来更新class</span></span><br><span class="line">            <span class="comment">// 注意：这里的prevValue和newValue是字符串类型</span></span><br><span class="line">            patchClass(el,newValue)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 这里区分是事件还是普通属性</span></span><br><span class="line">            <span class="comment">// 这个正则表示匹配以on开头，后面跟着任意字符但不是大写的a-z的字符</span></span><br><span class="line">            <span class="comment">// 例如：onClick、onChange 等</span></span><br><span class="line">            <span class="comment">// 注意：onclick、onchange 这样的属性这个正则表达式不匹配</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="regexp">/on[^a-z]/</span>.test(key))&#123;</span><br><span class="line">                <span class="comment">// 调用patchEvent方法来更新事件</span></span><br><span class="line">                patchEvent(el,key,newValue)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//  调用patchAttr方法来更新属性</span></span><br><span class="line">                patchAttr(el,key,newValue)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime-dom/src/modules/style.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchStyle</span>(<span class="params">el, prev, next</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> style = el.style</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果传递过来新的样式是null，则直接删除标签上的style元素</span></span><br><span class="line">    <span class="keyword">if</span>(next == <span class="literal">null</span>)&#123;</span><br><span class="line">        el.removeAttribute(<span class="string">&quot;style&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(prev)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> prev) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!next[key])&#123;</span><br><span class="line">                style[key] = <span class="string">&#x27;&#x27;</span>  <span class="comment">// 删除样式</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> next) &#123;</span><br><span class="line">        style[key] = next[key]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime-dom/src/modules/class.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchClass</span>(<span class="params">el, value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(value == <span class="literal">null</span>)&#123;</span><br><span class="line">        value = <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    el.classList = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime-dom/src/modules/event.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对事件进行缓存操作的流程</span></span><br><span class="line"><span class="comment">// 1.给元素添加一个用于缓存绑定事件的对象</span></span><br><span class="line"><span class="comment">// 2.如果这个缓存中之前没有缓存过这个事件，但是value有值，则需要绑定方法到缓存列表中</span></span><br><span class="line"><span class="comment">// 3.以前绑定过的需要删除掉，删除缓存</span></span><br><span class="line"><span class="comment">// 4.如果前后都有值，直接改变invoker中value属性指向最新的事件</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchEvent</span>(<span class="params">el, key, value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 在Vue的源码中，事件就是存放在el的_vei身上的</span></span><br><span class="line">    <span class="comment">// 这里拿到之前缓存的事件对象</span></span><br><span class="line">    <span class="keyword">const</span> invokers = el._vei || (el._vei = &#123;&#125;)</span><br><span class="line">    <span class="comment">// 从对象中获取本地调用的方法</span></span><br><span class="line">    <span class="keyword">const</span> exists = invokers[key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(value &amp;&amp; exists)&#123;</span><br><span class="line">        exists.value = value</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 截取掉前面的on，并且将后面的字符串转成小写</span></span><br><span class="line">        <span class="keyword">const</span> eventName = key.slice(<span class="number">2</span>).toLowerCase()</span><br><span class="line">        <span class="keyword">if</span>(value)&#123;</span><br><span class="line">            <span class="comment">// 去缓存一份新的事件名</span></span><br><span class="line">            <span class="keyword">let</span> invoker = invokers[key] = createInvoker(value)</span><br><span class="line">            el.addEventListener(eventName, invoker)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            el.removeEventListener(eventName, exists)</span><br><span class="line">            invokers[key] = <span class="literal">undefined</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createInvoker</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> invoker = <span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">        invoker.value(e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这样每次都支持更新value的值，不会重复添加多个事件</span></span><br><span class="line">    invoker.value = value</span><br><span class="line">    <span class="keyword">return</span> invoker</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime-dom/src/modules/attr.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchAttr</span>(<span class="params">el, key, value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(value == <span class="literal">null</span>)&#123;</span><br><span class="line">        el.removeAttribute(key)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    el.setAttribute(key,value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-dom导出createApp方法"><a href="#runtime-dom导出createApp方法" class="headerlink" title="runtime-dom导出createApp方法"></a>runtime-dom导出createApp方法</h3><p>我们最终要使用 createApp 这个方法来挂载页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> &#123;createApp&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="title">render</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;render&quot;</span>)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> app = createApp(App)</span></span><br><span class="line"><span class="javascript">        app.mount(<span class="string">&quot;#el&quot;</span>)</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>runtime-dom/src/index.ts</code> 创建createApp方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;patchProps&#125; <span class="keyword">from</span> <span class="string">&quot;./patchProps&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;nodeOpts&#125; <span class="keyword">from</span> <span class="string">&quot;./nodeOpts&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;mergeObjects&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createRender&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/runtime-core&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将patchProps和nodeOpts合并为一个对象并导出</span></span><br><span class="line"><span class="keyword">const</span> renderOptions = mergeObjects(&#123;patchProps&#125;, nodeOpts)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出 createApp 方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent, rootProps = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> app: <span class="built_in">any</span> = createRender(renderOptions).createApp(rootComponent, rootProps)</span><br><span class="line">    <span class="keyword">const</span> &#123; mount &#125; = app</span><br><span class="line">    app.mount = <span class="function">(<span class="params">container</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="comment">// 先清空容器内容</span></span><br><span class="line">        <span class="keyword">const</span> contain = nodeOpts.querySelector(container)</span><br><span class="line">        contain.innerHTML = <span class="string">&quot;&quot;</span></span><br><span class="line">        mount(contain)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core实现createRender方法"><a href="#runtime-core实现createRender方法" class="headerlink" title="runtime-core实现createRender方法"></a>runtime-core实现createRender方法</h3><p>新建 <code>runtime-core/src/renderer.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createAppApi&#125; <span class="keyword">from</span> <span class="string">&quot;./apiCreateApp&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRender</span>(<span class="params">renderOptions</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// vue核心方法，拿到一个虚拟节点和一个容器，将虚拟节点渲染到容器中</span></span><br><span class="line">    <span class="keyword">const</span> render = <span class="function">(<span class="params">vnode,container</span>)=&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        createApp:createAppApi(render)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建 <code>runtime-core/src/apiCreateApp.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppApi</span>(<span class="params">render</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent, rootProps</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="function"><span class="title">mount</span>(<span class="params">container</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// mount方法做的事情</span></span><br><span class="line">                <span class="comment">// 1.根据组件创建虚拟节点</span></span><br><span class="line">                <span class="comment">// 2.将虚拟节点和容器获取到后调用render方法进行页面渲染</span></span><br><span class="line">                <span class="keyword">let</span> vnode = &#123;&#125;</span><br><span class="line">                render(vnode,container)</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">console</span>.log(container)</span><br><span class="line">                <span class="built_in">console</span>.log(rootComponent)</span><br><span class="line">                <span class="built_in">console</span>.log(rootProps)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导出 <code>createRender</code> 方法</p>
<p><code>runtime-core/src/index.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRender&#125; <span class="keyword">from</span> <span class="string">&quot;./renderer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createRender</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后测试一下看看 mount 方法的打印是否成功</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240128183955906.png" alt="image-20240128183955906"></p>
<p>接下来我们专注实现如何创建虚拟节点</p>
<h2 id="组件创建流程"><a href="#组件创建流程" class="headerlink" title="组件创建流程"></a>组件创建流程</h2><h3 id="runtime-core-src-apiCreateApp-ts"><a href="#runtime-core-src-apiCreateApp-ts" class="headerlink" title="runtime-core/src/apiCreateApp.ts"></a>runtime-core/src/apiCreateApp.ts</h3><p>此方法返回mount方法，</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createVNode&#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppApi</span>(<span class="params">render</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent, rootProps</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> app = &#123;</span><br><span class="line">            _props: rootProps, <span class="comment">// 组件的属性</span></span><br><span class="line">            _component: rootComponent, <span class="comment">// createApp传入的组件</span></span><br><span class="line">            _container: <span class="literal">null</span>, <span class="comment">// 需要挂载的容器</span></span><br><span class="line">            <span class="function"><span class="title">mount</span>(<span class="params">container</span>)</span> &#123;</span><br><span class="line">                <span class="comment">// mount方法做的事情</span></span><br><span class="line">                <span class="comment">// 1.根据组件创建虚拟节点</span></span><br><span class="line">                <span class="keyword">let</span> vnode = createVNode(rootComponent, rootProps)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2.将虚拟节点和容器获取到后调用render方法进行页面渲染</span></span><br><span class="line">                render(vnode, container)</span><br><span class="line"></span><br><span class="line">                app._container = container</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core-src-vnode-ts"><a href="#runtime-core-src-vnode-ts" class="headerlink" title="runtime-core/src/vnode.ts"></a>runtime-core/src/vnode.ts</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法用来创建虚拟组件，是Vue3的核心方法之一</span></span><br><span class="line"><span class="keyword">import</span> &#123;isArray, isObject, isString&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createVNode = <span class="function">(<span class="params"><span class="keyword">type</span>, props, children = <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 根据type判断区分是组件还是普通元素</span></span><br><span class="line">    <span class="comment">// type是对象的就是组件，如果是字符串就是普通元素</span></span><br><span class="line">    <span class="comment">// 例如：createApp(&#123; render()&#123; return `&lt;h1&gt;&lt;h1&gt;` &#125;&#125;,&#123;name:&quot;lisi&quot;,age:18&#125;)，这种的就是组件</span></span><br><span class="line">    <span class="comment">// 例如：createApp(&quot;div&quot;,&#123; style:&#123; color:&quot;red&quot; &#125;&#125;)，这种的就是普通元素</span></span><br><span class="line">    <span class="comment">// 但是不管是组件还是普通元素，第二个参数都是各自的属性</span></span><br><span class="line">    <span class="comment">// 第三个参数是儿子节点，可能是空，如果是空的话就默认是null</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>) ? ShapeFlags.ELEMENT : (isObject(<span class="keyword">type</span>) ? ShapeFlags.STATEFUL_COMPONENT : <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">        __v_isVnode: <span class="literal">true</span>,<span class="comment">// 标识是否是一个虚拟节点</span></span><br><span class="line">        <span class="keyword">type</span>,</span><br><span class="line">        props,</span><br><span class="line">        children,</span><br><span class="line">        el: <span class="literal">null</span>,<span class="comment">// 这个虚拟节点对应的真实dom元素</span></span><br><span class="line">        key: props &amp;&amp; props.key,<span class="comment">// 每个组件对应的唯一标识，在diff算法中会用到</span></span><br><span class="line">        shapeFlag,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断当前组件儿子的类型</span></span><br><span class="line">    normalizeChildren(vnode, children)</span><br><span class="line">    <span class="comment">// 返回描述页面的对象，称为虚拟节点，具有跨平台的能力</span></span><br><span class="line">    <span class="comment">// 可以根据不同的平台生成不同的虚拟节点</span></span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">vnode, children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">type</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (children === <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(children)) &#123;</span><br><span class="line">        <span class="keyword">type</span> = ShapeFlags.ARRAY_CHILDREN</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">type</span> = ShapeFlags.TEXT_CHILDREN</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据儿子的状态来判断父亲的状态</span></span><br><span class="line">    vnode.shapeFlag |= <span class="keyword">type</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="shared-src-shapeFlags-ts"><a href="#shared-src-shapeFlags-ts" class="headerlink" title="shared/src/shapeFlags.ts"></a>shared/src/shapeFlags.ts</h3><p>使用位运算符来判断组件的类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="built_in">enum</span> ShapeFlags &#123;</span><br><span class="line">    ELEMENT = <span class="number">1</span>,</span><br><span class="line">    FUNCTIONAL_COMPONENT = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">    STATEFUL_COMPONENT = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line">    TEXT_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">    ARRAY_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line">    SLOTS_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</span><br><span class="line">    TELEPORT = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</span><br><span class="line">    SUSPENSE = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,</span><br><span class="line">    COMPONENT_SHOULD_KEEP_ALIVE = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,</span><br><span class="line">    COMPONENT_KEPT_ALIVE = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</span><br><span class="line">    COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// | 运算符，两边有一个是1，结果就是1，否则为0</span></span><br><span class="line"><span class="comment">// console.log(ShapeFlags.TEXT_CHILDREN | ShapeFlags.ARRAY_CHILDREN)</span></span><br></pre></td></tr></table></figure>

<p>然后再 <code>shared/src/index.ts</code> 文件中导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import * as shapeFlags from &quot;.&#x2F;shapeFlags&quot;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core-src-renderer-ts"><a href="#runtime-core-src-renderer-ts" class="headerlink" title="runtime-core/src/renderer.ts"></a>runtime-core/src/renderer.ts</h3><p>在mount函数中会调用下面的render方法，并传递过来vnode虚拟节点，拿到不同的虚拟节点，创建对应的真实节点，然后将真实节点渲染到容器中</p>
<p>然后判断是元素还是组件，进行组件挂载</p>
<p>判断有没有上一次的虚拟节点，如果没有，则就是初始化，否则是更新</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createAppApi&#125; <span class="keyword">from</span> <span class="string">&quot;./apiCreateApp&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createComponentInstance, setupComponent&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRender</span>(<span class="params">renderOptions</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> setupRenderEffect = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载组件</span></span><br><span class="line">    <span class="keyword">const</span> mountComponent = <span class="function">(<span class="params">initialVNode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 组件的渲染方法，这个方法的核心功能是调用setup拿到返回值，获取render函数返回的结果来进行渲染</span></span><br><span class="line">        <span class="comment">// 1.拿到实例,根据initialVNode来创建实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = (initialVNode.component = createComponentInstance(initialVNode))</span><br><span class="line">        <span class="comment">// 2.需要的数据解析到实例上</span></span><br><span class="line">        setupComponent(instance)</span><br><span class="line">        <span class="comment">// 3.创建一个effect让render函数执行</span></span><br><span class="line">        setupRenderEffect()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> processComponent = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 判断有没有上一次的虚拟节点，如果没有，则就是初始化，否则是更新</span></span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化挂载组件</span></span><br><span class="line">            mountComponent(n2, container)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> patch = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;shapeFlag&#125; = n2 <span class="comment">// 拿到虚拟节点的类型</span></span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">            <span class="comment">// 元素</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">            <span class="comment">// 组件</span></span><br><span class="line">            processComponent(n1, n2, container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vue核心方法，拿到一个虚拟节点和一个容器，将虚拟节点渲染到容器中</span></span><br><span class="line">    <span class="keyword">const</span> render = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里拿到不同的虚拟节点，创建对应的真实节点，然后将真实节点渲染到容器中</span></span><br><span class="line">        <span class="comment">// 第一次调用时，可能是初始化，没有上一个虚拟节点</span></span><br><span class="line">        patch(<span class="literal">null</span>, vnode, container)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        createApp: createAppApi(render)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core-src-component-ts"><a href="#runtime-core-src-component-ts" class="headerlink" title="runtime-core/src/component.ts"></a>runtime-core/src/component.ts</h3><p>在挂载组件是创建实例，并且调用组件的setup方法和render方法，都在此文件中进行</p>
<p>调用setup函数时，会传递两个参数：</p>
<ol>
<li>定义的props属性数据</li>
<li>context上下文对象，包含：attrs、slots、emit、expose</li>
</ol>
<p>调用render函数时，会传递一个proxy代理对象，通过这个代理对象，可以同时访问setupState、data、props上的属性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建实例方法</span></span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;PublicInstanceProxyHandlers&#125; <span class="keyword">from</span> <span class="string">&quot;./PublicInstanceProxyHandlers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createComponentInstance = <span class="function">(<span class="params">vnode</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = &#123;</span><br><span class="line">        vnode,</span><br><span class="line">        <span class="keyword">type</span>: vnode.type,</span><br><span class="line">        props: &#123;&#125;,</span><br><span class="line">        attrs: &#123;&#125;,</span><br><span class="line">        slots: &#123;&#125;,</span><br><span class="line">        ctx: &#123;&#125;,</span><br><span class="line">        data: &#123;</span><br><span class="line">            b: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        render: <span class="literal">null</span>,</span><br><span class="line">        setupState: &#123;</span><br><span class="line">            c: <span class="number">3</span></span><br><span class="line">        &#125;,</span><br><span class="line">        isMounted: <span class="literal">false</span> <span class="comment">// 标识组件是否挂载过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    instance.ctx = &#123;<span class="attr">_</span>: instance&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setupComponent = <span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将vnode上的props和children放在实例instance上</span></span><br><span class="line">    <span class="keyword">let</span> &#123;props, children, shapeFlag&#125; = instance.vnode</span><br><span class="line">    instance.props = props</span><br><span class="line">    instance.children = children</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前组件是不是有状态的组件</span></span><br><span class="line">    <span class="keyword">let</span> isStateful = shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line">    <span class="keyword">if</span> (isStateful) &#123;</span><br><span class="line">        setupStatefulComponent(instance)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupStatefulComponent</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> Component = instance.type</span><br><span class="line">    <span class="keyword">let</span> &#123;setup&#125; = Component</span><br><span class="line">    <span class="comment">// 组件中定义的setup函数，同时传递参数</span></span><br><span class="line">    <span class="comment">// 第一个参数是定义的props属性数据</span></span><br><span class="line">    <span class="comment">// 第二个是定义的context上下文对象</span></span><br><span class="line">    <span class="comment">// 上下文对象中包含：attrs、props、slots、emit、expose</span></span><br><span class="line">    <span class="keyword">let</span> setupContext = createSetupContext(instance)</span><br><span class="line">    setup(instance.props, setupContext)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用组件的render函数</span></span><br><span class="line">    instance.proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(instance.ctx, PublicInstanceProxyHandlers <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">    Component.render(instance.proxy)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupContext</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        attrs: instance.attrs,</span><br><span class="line">        slots: instance.slots,</span><br><span class="line">        emit: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        expose: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core-src-PublicInstanceProxyHandlers-ts"><a href="#runtime-core-src-PublicInstanceProxyHandlers-ts" class="headerlink" title="runtime-core/src/PublicInstanceProxyHandlers.ts"></a>runtime-core/src/PublicInstanceProxyHandlers.ts</h3><p>对render函数的参数进行代理，访问一个属性时，可以从props,setupState,data中获取任意一个只要存在的值</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;hasOwn&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="comment">// 对render函数的参数进行代理，访问一个属性时，可以从props,setupState,data中获取任意一个只要存在的值</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PublicInstanceProxyHandlers = &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">&#123;_: instance&#125;, key</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// vue源码中规定了如果访问的key是以$开头的，则不能访问</span></span><br><span class="line">        <span class="keyword">if</span> (key[<span class="number">0</span>] === <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// setupState存放的是setup函数返回的数据</span></span><br><span class="line">        <span class="comment">// 取值的顺序为：setupState、data、props</span></span><br><span class="line">        <span class="keyword">let</span> &#123;props, data, setupState&#125; = instance</span><br><span class="line">        <span class="keyword">if</span> (hasOwn(setupState, key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> setupState[key]</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasOwn(data, key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> data[key]</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasOwn(props, key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> props[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">&#123;_: instance&#125;, key, value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123;props, data, setupState&#125; = instance</span><br><span class="line">        <span class="keyword">if</span> (hasOwn(props, key)) &#123;</span><br><span class="line">            props[key] = value</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasOwn(data, key)) &#123;</span><br><span class="line">            data[key] = value</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasOwn(setupState, key)) &#123;</span><br><span class="line">            setupState[key] = value</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试setup函数和render函数"><a href="#测试setup函数和render函数" class="headerlink" title="测试setup函数和render函数"></a>测试setup函数和render函数</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;createApp&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">setup</span>(<span class="params">props, context</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&quot;setup&quot;</span>)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(props, context)</span></span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">render</span>(<span class="params">proxy</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.name)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.b)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.c)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = createApp(App, &#123;<span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;)</span></span><br><span class="line"><span class="javascript">    app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240201151222285.png" alt="image-20240201151222285"></p>
<p>通过结果分析</p>
<ul>
<li>李四 是从调用createApp函数时，传递的参数中获取的</li>
<li>2 是从data中获取的</li>
<li>3 是从setupState中获取的</li>
</ul>
<blockquote>
<p>setupState是setup函数的返回值，目前我们还没有处理，只是暂时写死的，后面我们会处理</p>
</blockquote>
<h2 id="处理setup的返回值"><a href="#处理setup的返回值" class="headerlink" title="处理setup的返回值"></a>处理setup的返回值</h2><h3 id="runtime-core-src-component-ts-1"><a href="#runtime-core-src-component-ts-1" class="headerlink" title="runtime-core/src/component.ts"></a>runtime-core/src/component.ts</h3><p>修改 <code>setupStatefulComponent</code> 方法，增加判断是否存在setup，如果存在，则获取setup的返回值，交给 <code>handleSetupResult</code> 方法处理，最终调用 <code>finishComponentSetup</code> 方法处理render</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建实例方法</span></span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;PublicInstanceProxyHandlers&#125; <span class="keyword">from</span> <span class="string">&quot;./PublicInstanceProxyHandlers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;isFunction, isObject&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createComponentInstance = <span class="function">(<span class="params">vnode</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = &#123;</span><br><span class="line">        vnode,</span><br><span class="line">        <span class="keyword">type</span>: vnode.type,</span><br><span class="line">        props: &#123;&#125;,</span><br><span class="line">        attrs: &#123;&#125;,</span><br><span class="line">        slots: &#123;&#125;,</span><br><span class="line">        ctx: &#123;&#125;,</span><br><span class="line">        data: &#123;&#125;,</span><br><span class="line">        render: <span class="literal">null</span>,</span><br><span class="line">        setupState: &#123;&#125;,</span><br><span class="line">        isMounted: <span class="literal">false</span> <span class="comment">// 标识组件是否挂载过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    instance.ctx = &#123;<span class="attr">_</span>: instance&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setupComponent = <span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将vnode上的props和children放在实例instance上</span></span><br><span class="line">    <span class="keyword">let</span> &#123;props, children, shapeFlag&#125; = instance.vnode</span><br><span class="line">    instance.props = props</span><br><span class="line">    instance.children = children</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前组件是不是有状态的组件</span></span><br><span class="line">    <span class="keyword">let</span> isStateful = shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line">    <span class="keyword">if</span> (isStateful) &#123;</span><br><span class="line">        setupStatefulComponent(instance)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupStatefulComponent</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> Component = instance.type</span><br><span class="line">    <span class="keyword">let</span> &#123;setup&#125; = Component</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断组件上是否有setup函数</span></span><br><span class="line">    <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">        <span class="comment">// 组件中定义的setup函数，同时传递参数</span></span><br><span class="line">        <span class="comment">// 第一个参数是定义的props属性数据</span></span><br><span class="line">        <span class="comment">// 第二个是定义的context上下文对象</span></span><br><span class="line">        <span class="comment">// 上下文对象中包含：attrs、props、slots、emit、expose</span></span><br><span class="line">        <span class="keyword">let</span> setupContext = createSetupContext(instance)</span><br><span class="line">        <span class="comment">// 拿到setup函数的返回值进行不同的处理</span></span><br><span class="line">        <span class="keyword">let</span> setupResult = setup(instance.props, setupContext)</span><br><span class="line">        handleSetupResult(instance, setupResult)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 组件中没有定义setup函数，则直接获取render函数</span></span><br><span class="line">        finishComponentSetup(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理setup函数的返回</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleSetupResult</span>(<span class="params">instance, setupResult</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 如果setup函数的返回值是一个函数，则这个函数作为render放在instance实例上</span></span><br><span class="line">    <span class="comment">// 所以这里如果setup函数的返回值是一个函数，则不会再执行定义的render函数</span></span><br><span class="line">    <span class="keyword">if</span> (isFunction(setupResult)) &#123;</span><br><span class="line">        instance.render = setupResult</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(setupResult)) &#123;</span><br><span class="line">        <span class="comment">// 如果setup函数的返回值是一个对象，则这个对象作为setupState放在instance实例上</span></span><br><span class="line">        instance.setupState = setupResult</span><br><span class="line">    &#125;</span><br><span class="line">    finishComponentSetup(instance)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理render函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishComponentSetup</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> Component = instance.type</span><br><span class="line">    <span class="comment">// 如果实例上没有render，这里表示setup返回值不是一个方法，而是一个对象</span></span><br><span class="line">    <span class="keyword">if</span> (!instance.render) &#123;</span><br><span class="line">        <span class="comment">// 继续判断组件上也没有render，意思是createApp方法接收的对象没有传递render函数</span></span><br><span class="line">        <span class="comment">// 并且有template模板，则将模板编译成render函数</span></span><br><span class="line">        <span class="keyword">if</span> (!Component.render &amp;&amp; Component.template) &#123;</span><br><span class="line">            <span class="comment">// Component.render = 将模板编译成render函数的方法</span></span><br><span class="line">        &#125;</span><br><span class="line">        instance.render = Component.render</span><br><span class="line">        <span class="comment">// 创建render函数的代理参数</span></span><br><span class="line">        instance.proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(instance.ctx, PublicInstanceProxyHandlers <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetupContext</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        attrs: instance.attrs,</span><br><span class="line">        slots: instance.slots,</span><br><span class="line">        emit: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        expose: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runtime-core-src-renderer-ts-1"><a href="#runtime-core-src-renderer-ts-1" class="headerlink" title="runtime-core/src/renderer.ts"></a>runtime-core/src/renderer.ts</h3><p>修改 <code>renderer</code> 文件的 <code>setupRenderEffect</code> 方法。接收 instance</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createAppApi&#125; <span class="keyword">from</span> <span class="string">&quot;./apiCreateApp&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createComponentInstance, setupComponent&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRender</span>(<span class="params">renderOptions</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line">    <span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance,container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 调用组件的render函数</span></span><br><span class="line">        instance.render()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载组件</span></span><br><span class="line">    <span class="keyword">const</span> mountComponent = <span class="function">(<span class="params">initialVNode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 组件的渲染方法，这个方法的核心功能是调用setup拿到返回值，获取render函数返回的结果来进行渲染</span></span><br><span class="line">        <span class="comment">// 1.拿到实例,根据initialVNode来创建实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = (initialVNode.component = createComponentInstance(initialVNode))</span><br><span class="line">        <span class="comment">// 2.需要的数据解析到实例上</span></span><br><span class="line">        setupComponent(instance)</span><br><span class="line">        <span class="comment">// 3.创建一个effect让render函数执行</span></span><br><span class="line">        setupRenderEffect(instance,container)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> processComponent = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 判断有没有上一次的虚拟节点，如果没有，则就是初始化，否则是更新</span></span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化挂载组件</span></span><br><span class="line">            mountComponent(n2, container)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> patch = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;shapeFlag&#125; = n2 <span class="comment">// 拿到虚拟节点的类型</span></span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">            <span class="comment">// 元素</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">            <span class="comment">// 组件</span></span><br><span class="line">            processComponent(n1, n2, container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vue核心方法，拿到一个虚拟节点和一个容器，将虚拟节点渲染到容器中</span></span><br><span class="line">    <span class="keyword">const</span> render = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里拿到不同的虚拟节点，创建对应的真实节点，然后将真实节点渲染到容器中</span></span><br><span class="line">        <span class="comment">// 第一次调用时，可能是初始化，没有上一个虚拟节点</span></span><br><span class="line">        patch(<span class="literal">null</span>, vnode, container)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        createApp: createAppApi(render)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="组件渲染流程"><a href="#组件渲染流程" class="headerlink" title="组件渲染流程"></a>组件渲染流程</h2><p>在 setupRenderEffect 方法中创建effect函数</p>
<h3 id="获取render函数的返回值"><a href="#获取render函数的返回值" class="headerlink" title="获取render函数的返回值"></a>获取render函数的返回值</h3><p>修改 runtime-core/src/renderer.ts 文件的 <code>setupRenderEffect </code>方法</p>
<p>创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</p>
<p>只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createAppApi&#125; <span class="keyword">from</span> <span class="string">&quot;./apiCreateApp&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createComponentInstance, setupComponent&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;effect&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/reactivity&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRender</span>(<span class="params">renderOptions</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line">    <span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</span></span><br><span class="line">        <span class="comment">// 只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</span></span><br><span class="line">        effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断是否是初次渲染</span></span><br><span class="line">            <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">                <span class="comment">// 初次渲染组件，调用render函数拿到返回值</span></span><br><span class="line">                <span class="keyword">let</span> subTree = instance.render.call(instance.proxy, instance.proxy)</span><br><span class="line">                <span class="built_in">console</span>.log(subTree, container)</span><br><span class="line">                <span class="comment">// 调用patch进行页面渲染</span></span><br><span class="line">                patch(<span class="literal">null</span>, subTree, container)</span><br><span class="line">                <span class="comment">// 修改是否初次渲染的状态</span></span><br><span class="line">                instance.isMounted = <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 更新组件</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载组件</span></span><br><span class="line">    <span class="keyword">const</span> mountComponent = <span class="function">(<span class="params">initialVNode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 组件的渲染方法，这个方法的核心功能是调用setup拿到返回值，获取render函数返回的结果来进行渲染</span></span><br><span class="line">        <span class="comment">// 1.拿到实例,根据initialVNode来创建实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = (initialVNode.component = createComponentInstance(initialVNode))</span><br><span class="line">        <span class="comment">// 2.需要的数据解析到实例上</span></span><br><span class="line">        setupComponent(instance)</span><br><span class="line">        <span class="comment">// 3.创建一个effect让render函数执行，并且吧需要挂载的节点传过去</span></span><br><span class="line">        setupRenderEffect(instance, container)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> processComponent = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 判断有没有上一次的虚拟节点，如果没有，则就是初始化，否则是更新</span></span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化挂载组件</span></span><br><span class="line">            mountComponent(n2, container)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> patch = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;shapeFlag&#125; = n2 <span class="comment">// 拿到虚拟节点的类型</span></span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">            <span class="comment">// 元素</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">            <span class="comment">// 组件</span></span><br><span class="line">            processComponent(n1, n2, container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vue核心方法，拿到一个虚拟节点和一个容器，将虚拟节点渲染到容器中</span></span><br><span class="line">    <span class="keyword">const</span> render = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里拿到不同的虚拟节点，创建对应的真实节点，然后将真实节点渲染到容器中</span></span><br><span class="line">        <span class="comment">// 第一次调用时，可能是初始化，没有上一个虚拟节点</span></span><br><span class="line">        patch(<span class="literal">null</span>, vnode, container)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        createApp: createAppApi(render)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写h函数"><a href="#编写h函数" class="headerlink" title="编写h函数"></a>编写h函数</h3><p>render的返回值是一个h函数，h函数的返回值是虚拟节点，所以下面来实现h函数</p>
<p>新建 packages/runtime-core/src/h.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 实现h函数,h函数可能存在的几种方式</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 两个参数的情况</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;)  类型 + 属性</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, h(&quot;span&quot;, &quot;hello world&quot;))  类型 + 套h函数，这里h函数返回的是一个虚拟节点，我们可以判断 __v_isVnode</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &quot;hello world&quot;)  类型 + 孩子</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, [h(&quot;span&quot;, &quot;hello world&quot;)])  类型 + 数组</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 三个参数的情况</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;, &quot;hello world&quot;)  类型 + 属性 + 孩子</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;, h(&quot;span&quot;, &quot;hello world&quot;)))  类型 + 属性 + 虚拟节点</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 大于三个参数的情况</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;, &quot;hello world&quot;, &quot;hello world&quot;)  类型 + 属性 + 多个孩子</span></span><br><span class="line"><span class="comment"> h(&quot;div&quot;, &#123;style: null, h(&quot;span&quot;, &quot;hello world&quot;), h(&quot;span&quot;, &quot;hello world&quot;))  类型 + 属性 + 多个虚拟节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;isArray, isObject&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createVNode, isVnode&#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"><span class="keyword">type</span>, propsOrChildren, children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> l = <span class="built_in">arguments</span>.length</span><br><span class="line">    <span class="keyword">if</span> (l === <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isObject(propsOrChildren) &amp;&amp; !isArray(propsOrChildren)) &#123;</span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, h(&quot;span&quot;, &quot;hello world&quot;))</span></span><br><span class="line">            <span class="keyword">if</span> (isVnode(propsOrChildren)) &#123;</span><br><span class="line">                <span class="keyword">return</span> createVNode(<span class="keyword">type</span>, <span class="literal">null</span>, [propsOrChildren])</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;)</span></span><br><span class="line">            <span class="keyword">return</span> createVNode(<span class="keyword">type</span>, propsOrChildren)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, &quot;hello world&quot;)  类型 + 孩子</span></span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, [h(&quot;span&quot;, &quot;hello world&quot;)])  类型 + 数组</span></span><br><span class="line">            <span class="keyword">return</span> createVNode(<span class="keyword">type</span>, <span class="literal">null</span>, propsOrChildren)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (l &gt; <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;, &quot;hello world&quot;, &quot;hello world&quot;)  类型 + 属性 + 多个孩子</span></span><br><span class="line">            children = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">2</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (l === <span class="number">3</span> &amp;&amp; isVnode(children)) &#123;</span><br><span class="line">            <span class="comment">// h(&quot;div&quot;, &#123;style: &#123;color: &quot;red&quot;&#125;&#125;, h(&quot;span&quot;, &quot;hello world&quot;)))  类型 + 属性 + 虚拟节点</span></span><br><span class="line">            children = [children]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createVNode(<span class="keyword">type</span>, propsOrChildren, children)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后导出</p>
<p>packages/runtime-core/src/index.ts文件导出h函数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRender&#125; <span class="keyword">from</span> <span class="string">&quot;./renderer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;h&#125; <span class="keyword">from</span> <span class="string">&quot;./h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createRender,</span><br><span class="line">    h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再 runtime-dom 中吧 runtime-core 的内容导出</p>
<p>packages/runtime-dom/src/index.ts</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import &#123;patchProps&#125; from &quot;./patchProps&quot;</span><br><span class="line">import &#123;nodeOpts&#125; from &quot;./nodeOpts&quot;</span><br><span class="line">import &#123;mergeObjects&#125; from &quot;@vue/shared&quot;;</span><br><span class="line">import &#123;createRender&#125; from &quot;@vue/runtime-core&quot;;</span><br><span class="line"></span><br><span class="line"><span class="addition">+ // runtime-dom中导出runtime-core中所有的内容</span></span><br><span class="line"><span class="addition">+ export * from &quot;@vue/runtime-core&quot;</span></span><br><span class="line"></span><br><span class="line">// 将patchProps和nodeOpts合并为一个对象并导出</span><br><span class="line">const renderOptions = mergeObjects(&#123;patchProps&#125;, nodeOpts)</span><br><span class="line"></span><br><span class="line">// 导出 createApp 方法</span><br><span class="line">export function createApp(rootComponent, rootProps = null) &#123;</span><br><span class="line">    const app: any = createRender(renderOptions).createApp(rootComponent, rootProps)</span><br><span class="line">    const &#123;mount&#125; = app</span><br><span class="line">    app.mount = (container) =&gt; &#123;</span><br><span class="line">        // 先清空容器内容</span><br><span class="line">        const contain = nodeOpts.querySelector(container)</span><br><span class="line">        contain.innerHTML = &quot;&quot;</span><br><span class="line">        mount(contain)</span><br><span class="line">    &#125;</span><br><span class="line">    return app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试查看打印结果"><a href="#测试查看打印结果" class="headerlink" title="测试查看打印结果"></a>测试查看打印结果</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;createApp, h&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">setup</span>(<span class="params">props, context</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&quot;setup&quot;</span>)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(props, context)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line">                b: 111,</span><br><span class="line">                c: 333</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">render</span>(<span class="params">proxy</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.name)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.b)</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(proxy.c)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> h(<span class="string">&quot;div&quot;</span>, &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;, <span class="string">&quot;hello world&quot;</span>)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = createApp(App, &#123;<span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;)</span></span><br><span class="line"><span class="javascript">    app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202112524657.png" alt="image-20240202112524657"></p>
<p>下面我们来实现这个过程</p>
<h3 id="实现组件渲染"><a href="#实现组件渲染" class="headerlink" title="实现组件渲染"></a>实现组件渲染</h3><p>修改 packages/runtime-core/src/renderer.ts 文件中的 patch 方法，添加针对元素的操作</p>
<ol>
<li>增加 <code>processElement</code> 方法处理元素，并且将创建出来的真实DOM赋值给vnode的el属性</li>
<li>然后再 <code>processElement</code> 方法判断是否是初次挂载，如果是初次挂载则调用 <code>mountElement</code> 方法</li>
<li><code>mountElement</code> 方法中开始创建真实DOM，并且添加属性和子元素等</li>
<li>如果判断子元素是一个数组，则调用 <code>mountChildren</code> 方法遍历子元素</li>
<li><code>mountChildren</code> 方法中使用 <code>normalizeVnode</code> 来创建每一个子元素对应的虚拟节点</li>
<li><code>normalizeVnode</code> 方法会判断当前元素是否是对象，如果是对象则直接返回，否则创建一个类型是 <code>Symbol(&quot;Text&quot;)</code> 的虚拟节点</li>
<li>然后重新调用 <code>patch</code> 方法进行子组件渲染，此时子组件挂载目标就是上面的el</li>
<li>递归调用 path 最终完成组件渲染</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createAppApi&#125; <span class="keyword">from</span> <span class="string">&quot;./apiCreateApp&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;ShapeFlags&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/shared/src/shapeFlags&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createComponentInstance, setupComponent&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;effect&#125; <span class="keyword">from</span> <span class="string">&quot;@vue/reactivity&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;normalizeVnode, Text&#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRender</span>(<span class="params">renderOptions</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 结构renderOptions获取操作DOM的各种方法</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        patchProps: hostPatchProps,</span><br><span class="line">        insert: hostInsert,</span><br><span class="line">        remove: hostRemove,</span><br><span class="line">        createElement: hostCreateElement,</span><br><span class="line">        createText: hostCreateText,</span><br><span class="line">        setText: hostSetText,</span><br><span class="line">        setElementText: hostSetElementText,</span><br><span class="line">    &#125; = renderOptions</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line">    <span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</span></span><br><span class="line">        <span class="comment">// 只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</span></span><br><span class="line">        effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断是否是初次渲染</span></span><br><span class="line">            <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">                <span class="comment">// 初次渲染组件，调用render函数拿到返回值</span></span><br><span class="line">                <span class="keyword">let</span> subTree = instance.render.call(instance.proxy, instance.proxy)</span><br><span class="line">                <span class="comment">// 调用patch进行页面渲染</span></span><br><span class="line">                patch(<span class="literal">null</span>, subTree, container)</span><br><span class="line">                <span class="comment">// 修改是否初次渲染的状态</span></span><br><span class="line">                instance.isMounted = <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 更新组件</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载组件</span></span><br><span class="line">    <span class="keyword">const</span> mountComponent = <span class="function">(<span class="params">initialVNode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 组件的渲染方法，这个方法的核心功能是调用setup拿到返回值，获取render函数返回的结果来进行渲染</span></span><br><span class="line">        <span class="comment">// 1.拿到实例,根据initialVNode来创建实例</span></span><br><span class="line">        <span class="keyword">const</span> instance = (initialVNode.component = createComponentInstance(initialVNode))</span><br><span class="line">        <span class="comment">// 2.需要的数据解析到实例上</span></span><br><span class="line">        setupComponent(instance)</span><br><span class="line">        <span class="comment">// 3.创建一个effect让render函数执行</span></span><br><span class="line">        setupRenderEffect(instance, container)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理组件</span></span><br><span class="line">    <span class="keyword">const</span> processComponent = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 判断有没有上一次的虚拟节点，如果没有，则就是初始化，否则是更新</span></span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化挂载组件</span></span><br><span class="line">            mountComponent(n2, container)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载元素</span></span><br><span class="line">    <span class="keyword">const</span> mountElement = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;<span class="keyword">type</span>, props, shapeFlag, children&#125; = vnode</span><br><span class="line">        <span class="comment">// 创建元素，并且把真实DOM赋值到虚拟节点的el属性上</span></span><br><span class="line">        <span class="keyword">let</span> el = (vnode.el = hostCreateElement(<span class="keyword">type</span>))</span><br><span class="line">        <span class="comment">// 处理属性</span></span><br><span class="line">        <span class="keyword">if</span> (props) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">                hostPatchProps(el, key, <span class="literal">null</span>, props[key])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断元素类型</span></span><br><span class="line">        <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">            <span class="comment">// 普通文本比较简单，直接吧内容放在元素中即可</span></span><br><span class="line">            hostSetElementText(el, children)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">            <span class="comment">// 子元素是一个数组，需要遍历每一个子元素</span></span><br><span class="line">            mountChildren(children, el)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 插入元素到指定位置</span></span><br><span class="line">        hostInsert(el, container)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理子元素是一个数组的情况</span></span><br><span class="line">    <span class="keyword">const</span> mountChildren = <span class="function">(<span class="params">children, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> child = (children[i] = normalizeVnode(children[i]))</span><br><span class="line">            patch(<span class="literal">null</span>, child, container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理元素</span></span><br><span class="line">    <span class="keyword">const</span> processElement = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 挂载元素</span></span><br><span class="line">            mountElement(n2, container)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新元素</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> processText = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">            hostInsert(hostCreateText(n2.children), container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> patch = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;shapeFlag, <span class="keyword">type</span>&#125; = n2 <span class="comment">// 拿到虚拟节点的类型</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> Text:</span><br><span class="line">                processText(n1, n2, container)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">                    <span class="comment">// 元素</span></span><br><span class="line">                    processElement(n1, n2, container)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">                    <span class="comment">// 组件</span></span><br><span class="line">                    processComponent(n1, n2, container)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vue核心方法，拿到一个虚拟节点和一个容器，将虚拟节点渲染到容器中</span></span><br><span class="line">    <span class="keyword">const</span> render = <span class="function">(<span class="params">vnode, container</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里拿到不同的虚拟节点，创建对应的真实节点，然后将真实节点渲染到容器中</span></span><br><span class="line">        <span class="comment">// 第一次调用时，可能是初始化，没有上一个虚拟节点</span></span><br><span class="line">        patch(<span class="literal">null</span>, vnode, container)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        createApp: createAppApi(render)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>packages/runtime-core/src/vnode.ts 新增 <code>normalizeVnode</code> 方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Text = <span class="built_in">Symbol</span>(<span class="string">&quot;Text&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeVnode</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isObject(vnode)) <span class="keyword">return</span> vnode</span><br><span class="line">    <span class="comment">// 创建一个类型是 Symbol(&quot;Text&quot;) 的元素，标识这是一个虚拟的文本节点</span></span><br><span class="line">    <span class="keyword">return</span> createVNode(Text, <span class="literal">null</span>, <span class="built_in">String</span>(vnode))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试查看渲染效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;createApp, h&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">render</span>(<span class="params">proxy</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> h(</span></span><br><span class="line"><span class="javascript">                <span class="string">&quot;div&quot;</span>,</span></span><br><span class="line"><span class="javascript">                &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;&#125;,</span></span><br><span class="line">                [</span><br><span class="line">                    h(</span><br><span class="line"><span class="javascript">                        <span class="string">&quot;h2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                        &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;blue&quot;</span>&#125;&#125;,</span></span><br><span class="line">                        [</span><br><span class="line"><span class="javascript">                            <span class="string">&quot;hello world&quot;</span>,</span></span><br><span class="line">                            h(</span><br><span class="line"><span class="javascript">                                <span class="string">&quot;b&quot;</span>,</span></span><br><span class="line"><span class="javascript">                                &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;pink&quot;</span>&#125;&#125;,</span></span><br><span class="line"><span class="javascript">                                <span class="string">&quot;123&quot;</span></span></span><br><span class="line">                            )</span><br><span class="line">                        ]</span><br><span class="line">                    ),</span><br><span class="line"><span class="javascript">                    <span class="string">&quot;world&quot;</span></span></span><br><span class="line">                ])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = createApp(App, &#123;<span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;)</span></span><br><span class="line"><span class="javascript">    app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202151239249.png" alt="image-20240202151239249"></p>
<p>接下来实现数据更新，自动更新组件</p>
<h2 id="组件更新流程"><a href="#组件更新流程" class="headerlink" title="组件更新流程"></a>组件更新流程</h2><h3 id="只触发一次更新"><a href="#只触发一次更新" class="headerlink" title="只触发一次更新"></a>只触发一次更新</h3><p>packages/runtime-core/src/index.ts 导入 reactive 内容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createRender,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./renderer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    h</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;@vue/reactivity&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后修改测试的 html 文件，使用 reactive</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;createApp, h, reactive&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> state = reactive(&#123;</span></span><br><span class="line"><span class="javascript">                name: <span class="string">&quot;szx&quot;</span></span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="function"><span class="keyword">function</span> <span class="title">changeName</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                state.name = <span class="string">&quot;songzx&quot;</span></span></span><br><span class="line"><span class="javascript">                state.name = <span class="string">&quot;szx&quot;</span></span></span><br><span class="line"><span class="javascript">                state.name = <span class="string">&quot;songzx&quot;</span></span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> h(</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;div&quot;</span>,</span></span><br><span class="line"><span class="javascript">                    &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>&#125;, <span class="attr">onClick</span>: changeName&#125;,</span></span><br><span class="line">                    [</span><br><span class="line">                        h(</span><br><span class="line"><span class="javascript">                            <span class="string">&quot;h2&quot;</span>,</span></span><br><span class="line"><span class="javascript">                            &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;blue&quot;</span>&#125;&#125;,</span></span><br><span class="line">                            [</span><br><span class="line"><span class="javascript">                                <span class="string">&quot;hello world&quot;</span>,</span></span><br><span class="line">                                h(</span><br><span class="line"><span class="javascript">                                    <span class="string">&quot;b&quot;</span>,</span></span><br><span class="line"><span class="javascript">                                    &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;pink&quot;</span>&#125;&#125;,</span></span><br><span class="line"><span class="javascript">                                    <span class="string">&quot;123&quot;</span></span></span><br><span class="line">                                )</span><br><span class="line">                            ]</span><br><span class="line">                        ),</span><br><span class="line">                        state.name</span><br><span class="line">                    ])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> app = createApp(App, &#123;<span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;)</span></span><br><span class="line"><span class="javascript">    app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在我们在 h  函数中用到了 state.name ，并且点击后出改变数据，此时会触发三次更新</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202160023971.png" alt="image-20240202160023971"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202160040360.png" alt="image-20240202160040360"></p>
<p>此时，可以使用之前定义过的effect的 scheduler 属性，自定义更新事件</p>
<p>如果 effect 函数的参数中有 scheduler 属性，则会调用 scheduler()，并传入当前要执行的effect</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202160316551.png" alt="image-20240202160316551"></p>
<p>新建 packages/runtime-core/src/scheduler.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用一个队列来处理多次调用render函数更新组件的问题</span></span><br><span class="line"><span class="keyword">let</span> queue = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueJob</span>(<span class="params">job</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!queue.includes(job)) &#123;</span><br><span class="line">        queue.push(job)</span><br><span class="line">        queueFlush()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> isFlushPending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueFlush</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFlushPending) &#123;</span><br><span class="line">        isFlushPending = <span class="literal">true</span></span><br><span class="line">        <span class="built_in">Promise</span>.resolve().then(flushJobs)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushJobs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    isFlushPending = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 进行排序，先调用父组件的更新方法</span></span><br><span class="line">    queue.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; queue.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> job = queue[i]</span><br><span class="line">        job()</span><br><span class="line">    &#125;</span><br><span class="line">    queue.length = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改 packages/runtime-core/src/renderer.ts 文件的 <code>setupRenderEffect</code> 方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line"><span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance, container</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</span></span><br><span class="line">    <span class="comment">// 只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</span></span><br><span class="line">    effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否是初次渲染</span></span><br><span class="line">        <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">            <span class="comment">// 初次渲染组件，调用render函数拿到返回值</span></span><br><span class="line">            <span class="keyword">let</span> subTree = instance.render.call(instance.proxy, instance.proxy)</span><br><span class="line">            <span class="comment">// 调用patch进行页面渲染</span></span><br><span class="line">            patch(<span class="literal">null</span>, subTree, container)</span><br><span class="line">            <span class="comment">// 修改是否初次渲染的状态</span></span><br><span class="line">            instance.isMounted = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;更新&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        scheduler: <span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">            queueJob(effect)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时再去点击就会触发一次更新</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240202160400217.png" alt="image-20240202160400217"></p>
<h3 id="默认两个元素的比较"><a href="#默认两个元素的比较" class="headerlink" title="默认两个元素的比较"></a>默认两个元素的比较</h3><p>packages/runtime-dom/src/nodeOpts.ts</p>
<p>添加 nextSibling 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个文件专门存放用于操作节点的各种方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nodeOpts = &#123;</span><br><span class="line">    <span class="comment">// 创建一个元素</span></span><br><span class="line">    createElement: <span class="function">(<span class="params">target</span>) =&gt;</span> <span class="built_in">document</span>.createElement(target),</span><br><span class="line">    <span class="comment">// 删除一个元素</span></span><br><span class="line">    remove: <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 1.先找到这个元素的父元素</span></span><br><span class="line">        <span class="keyword">const</span> parent = target.parentNode</span><br><span class="line">        <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">            parent.removeChild(target)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在指定位置插入一个元素</span></span><br><span class="line">    insert: <span class="function">(<span class="params">target, parent, anchor = <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">        parent.insertBefore(target, anchor)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 查找一个元素</span></span><br><span class="line">    querySelector: <span class="function">(<span class="params">selector</span>) =&gt;</span> <span class="built_in">document</span>.querySelector(selector),</span><br><span class="line">    <span class="comment">// 设置一个标签元素的文本内容</span></span><br><span class="line">    setElementText: <span class="function">(<span class="params">el, text</span>) =&gt;</span> el.textContent = text,</span><br><span class="line">    <span class="comment">// 创建一个文本元素</span></span><br><span class="line">    createText: <span class="function">(<span class="params">text</span>) =&gt;</span> <span class="built_in">document</span>.createTextNode(text),</span><br><span class="line">    <span class="comment">// 设置文本元素的内容</span></span><br><span class="line">    setText: <span class="function">(<span class="params">node, text</span>) =&gt;</span> node.nodeValue = text,</span><br><span class="line">    <span class="comment">// 获取指定元素的下一个兄弟元素</span></span><br><span class="line">    nextSibling: <span class="function">(<span class="params">el</span>) =&gt;</span> el.nextSibling</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有如下代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> &#123;createApp, h, reactive,ref&#125; = VueRuntimeDom</span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> flag = ref(<span class="literal">true</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        flag.value = <span class="literal">false</span></span></span><br><span class="line">      &#125;,1000)</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> flag.value ?</span></span><br><span class="line"><span class="javascript">                h(<span class="string">&quot;div&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;red&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;hello word&quot;</span>)) :</span></span><br><span class="line"><span class="javascript">                h(<span class="string">&quot;div&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;blue&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;你好 世界&quot;</span>))</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = createApp(App)</span></span><br><span class="line"><span class="javascript">  app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在倒计时一秒后，页面发生变化</p>
<p><code>flag.value</code> 变化后，会重新触发 effect 方法，此时判断是否初次渲染</p>
<p>packages/runtime-core/src/renderer.ts</p>
<p>修改setupRenderEffect方法中的effect方法，从当前实例中获取上次的VNode，然后调用render函数拿到新的VNode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line"><span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance, container</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</span></span><br><span class="line">    <span class="comment">// 只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</span></span><br><span class="line">    effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否是初次渲染</span></span><br><span class="line">        <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">            <span class="comment">// 初次渲染组件，调用render函数拿到返回值</span></span><br><span class="line">            <span class="keyword">let</span> subTree = instance.subTree = instance.render.call(instance.proxy, instance.proxy)</span><br><span class="line">            <span class="comment">// 调用patch进行页面渲染</span></span><br><span class="line">            patch(<span class="literal">null</span>, subTree, container)</span><br><span class="line">            <span class="comment">// 修改是否初次渲染的状态</span></span><br><span class="line">            instance.isMounted = <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 更新组件，调用render函数拿到最新的Node节点</span></span><br><span class="line">            <span class="keyword">let</span> prevTree = instance.subTree</span><br><span class="line">            <span class="keyword">let</span> proxyToUse = instance.proxy</span><br><span class="line">            <span class="keyword">let</span> nextTree = instance.render.call(proxyToUse, proxyToUse)</span><br><span class="line">            patch(prevTree, nextTree, container)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        scheduler: <span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">            queueJob(effect)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用patch方法进行页面页面更新</p>
<p>packages/runtime-core/src/renderer.ts</p>
<p>patch方法中添加一个判断，判断n1和n2是否相同，如果不相同，表示本次更新的元素完全和上次不一样，所以直接吧上一次的删除掉，重新渲染新的元素，同时获取上一个元素的下一个兄弟元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSameVNodeType = <span class="function">(<span class="params">n1, n2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n1.type === n2.type &amp;&amp; n1.key === n2.key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> unmount = <span class="function">(<span class="params">n1</span>) =&gt;</span> &#123;</span><br><span class="line">    hostRemove(n1.el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patch = <span class="function">(<span class="params">n1, n2, container, anchor = <span class="literal">null</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;shapeFlag, type&#125; = n2 <span class="comment">// 拿到虚拟节点的类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果存在n1的情况下，先判断一下n1和n2的类型是否相同，如果不相同，则直接吧n1删除掉</span></span><br><span class="line">    <span class="keyword">if</span> (n1 &amp;&amp; !isSameVNodeType(n1, n2)) &#123;</span><br><span class="line">        <span class="comment">// 获取当前元素的下一个元素，在重新插入的时候根据anchor正确的插入新元素，否则会插入到当前元素的后面</span></span><br><span class="line">        anchor = hostNextSibling(n1.el)</span><br><span class="line">        unmount(n1)</span><br><span class="line">        n1 = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> Text:</span><br><span class="line">            <span class="comment">// 单独处理文本</span></span><br><span class="line">            processText(n1, n2, container)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">                <span class="comment">// 元素</span></span><br><span class="line">                processElement(n1, n2, container, anchor)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">                <span class="comment">// 组件</span></span><br><span class="line">                processComponent(n1, n2, container)</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断完成之后如果可以进入到processElement方法中，表示两个元素的类型相同，则要开始比较他们的属性和孩子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理元素</span></span><br><span class="line"><span class="keyword">const</span> processElement = <span class="function">(<span class="params">n1, n2, container, anchor</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n1 === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 挂载元素</span></span><br><span class="line">        mountElement(n2, container)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 更新元素</span></span><br><span class="line">        patchElement(n1, n2, container)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新元素的属性</span></span><br><span class="line"><span class="keyword">const</span> patchProps = <span class="function">(<span class="params">el,oleProps,newProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">        <span class="keyword">let</span> prev = oleProps[key]</span><br><span class="line">        <span class="keyword">let</span> next = newProps[key]</span><br><span class="line">        <span class="keyword">if</span>(prev !== next)&#123;</span><br><span class="line">            hostPatchProps(el,key,oleProps[key],newProps[key])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oleProps) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!(key <span class="keyword">in</span> newProps))&#123;</span><br><span class="line">            hostPatchProps(el,key,oleProps[key],<span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 比较两个元素的儿子</span></span><br><span class="line"><span class="comment">* 比较儿子有如下四种情况</span></span><br><span class="line"><span class="comment">* 1.老的有儿子，新的没儿子</span></span><br><span class="line"><span class="comment">* 2.老的有儿子，新的有儿子</span></span><br><span class="line"><span class="comment">* 3.老的没儿子，新的没儿子</span></span><br><span class="line"><span class="comment">* 4.老的没儿子，新的有儿子</span></span><br><span class="line"><span class="comment">* 5.新老都是文本</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> patchChildren = <span class="function">(<span class="params">n1,n2,el</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(n1,n2,el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新元素</span></span><br><span class="line"><span class="keyword">const</span> patchElement = <span class="function">(<span class="params">n1, n2, container</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 直接复用旧的元素节点</span></span><br><span class="line">    <span class="keyword">let</span> el = (n2.el = n1.el)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比属性</span></span><br><span class="line">    <span class="keyword">let</span> oldProps = n1.props</span><br><span class="line">    <span class="keyword">let</span> newProps = n2.props</span><br><span class="line">    patchProps(el, oldProps, newProps)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比儿子</span></span><br><span class="line">    patchChildren(n1,n2,el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试比较两个不同的元素</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> App = &#123;</span><br><span class="line">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> flag = ref(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            flag.value = <span class="literal">false</span></span><br><span class="line">        &#125;,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> flag.value ?</span><br><span class="line">                h(<span class="string">&quot;div&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;red&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;hello word&quot;</span>)) :</span><br><span class="line">                h(<span class="string">&quot;span&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;blue&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;你好 世界&quot;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时页面会直接替换</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240228205858937.png" alt="image-20240228205858937"></p>
<p>如果元素类型相同，则会比较属性和比较孩子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> App = &#123;</span><br><span class="line">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> flag = ref(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            flag.value = <span class="literal">false</span></span><br><span class="line">        &#125;,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> flag.value ?</span><br><span class="line">                h(<span class="string">&quot;div&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;red&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;hello word&quot;</span>)) :</span><br><span class="line">                h(<span class="string">&quot;div&quot;</span>,&#123;<span class="attr">style</span>:&#123;<span class="attr">color</span>:<span class="string">&quot;blue&quot;</span>&#125;&#125;,h(<span class="string">&quot;div&quot;</span>,<span class="string">&quot;你好 世界&quot;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时页面只是吧属性更新了一下，内容没有替换</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240228210048996.png" alt="image-20240228210048996"></p>
<p>接下来开始实现比较孩子的操作</p>
<h3 id="特殊比较和优化"><a href="#特殊比较和优化" class="headerlink" title="特殊比较和优化"></a>特殊比较和优化</h3><p>packages/runtime-core/src/renderer.ts</p>
<h4 id="实现-patchChildren-方法"><a href="#实现-patchChildren-方法" class="headerlink" title="实现  patchChildren 方法"></a>实现  patchChildren 方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unmountChildren = <span class="function">(<span class="params">children</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> children) &#123;</span><br><span class="line">        unmount(child)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patchKeyedChildren = <span class="function">(<span class="params">c1, c2, el</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> e1 = c1.length - <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> e2 = c2.length - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从头开始一个一个比较，遇到不同的就停止比较</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">        <span class="keyword">const</span> n1 = c1[i]</span><br><span class="line">        <span class="keyword">const</span> n2 = c2[i]</span><br><span class="line">        <span class="keyword">if</span> (isSameVNodeType(n1, n2)) &#123;</span><br><span class="line">            patch(n1, n2, el)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从尾部开始比较,特殊优化，尽可能缩小需要diff的范围</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2)&#123;</span><br><span class="line">        <span class="keyword">const</span> n1 = c1[e1]</span><br><span class="line">        <span class="keyword">const</span> n2 = c2[e2]</span><br><span class="line">        <span class="keyword">if</span>(isSameVNodeType(n1,n2))&#123;</span><br><span class="line">            patch(n1, n2, el)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        e1--</span><br><span class="line">        e2--</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较完成后，如果i大于e1表示有新增的部分，老的少，新的多</span></span><br><span class="line">    <span class="keyword">if</span>(i &gt; e1)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i &lt;= e2)&#123;</span><br><span class="line">            <span class="keyword">const</span> nextPosition = e2 + <span class="number">1</span></span><br><span class="line">            <span class="comment">// 确认在那个元素之前插入</span></span><br><span class="line">            <span class="comment">// 判断如果e2 + 1大于新的孩子长度，表示在结尾</span></span><br><span class="line">            <span class="comment">// 否则就在当前e2的下一个元素之前插入</span></span><br><span class="line">            <span class="keyword">const</span> anchor = nextPosition &lt; c2.length ? c2[nextPosition].el : <span class="literal">null</span></span><br><span class="line">            <span class="keyword">while</span> (i &lt;= e2)&#123;</span><br><span class="line">                patch(<span class="literal">null</span>,c2[i],el,anchor)</span><br><span class="line">                i++</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i &gt; e2)&#123; <span class="comment">// 表示老的多，新的少</span></span><br><span class="line">       <span class="keyword">while</span> (i &lt;= e1)&#123;</span><br><span class="line">           unmount(c1[i])</span><br><span class="line">           i++</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 乱序比较，采用一个映射表，尽可能复用元素</span></span><br><span class="line">        <span class="keyword">let</span> s1 = i</span><br><span class="line">        <span class="keyword">let</span> s2 = i</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里存放的是新中间的元素的每一个下标</span></span><br><span class="line">        <span class="keyword">const</span> keyToNewIndexMap = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">            <span class="keyword">const</span>  childVNode = c2[j]</span><br><span class="line">            keyToNewIndexMap.set(childVNode.key,j)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到中间的需要对比的元素个数</span></span><br><span class="line">        <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span></span><br><span class="line">        <span class="comment">// 创建一个相同长度的数据，存放的是老的孩子的下标,默认都是0</span></span><br><span class="line">        <span class="comment">// 可以通过判断是不是0来确认这个节点是否需要被patch</span></span><br><span class="line">        <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="built_in">Array</span>(toBePatched).fill(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 去老的里面找，有没有可以复用的</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = s1; j &lt;= e1; j++) &#123;</span><br><span class="line">            <span class="keyword">const</span> oldVNode = c1[j]</span><br><span class="line">            <span class="comment">// 用老的key去看新的里面有没有这个key</span></span><br><span class="line">            <span class="keyword">const</span> newIndex = keyToNewIndexMap.get(oldVNode.key)</span><br><span class="line">            <span class="comment">// 如果这个key在新的孩子中没有，则删除掉老的</span></span><br><span class="line">            <span class="keyword">if</span>(newIndex === <span class="literal">undefined</span>)&#123;</span><br><span class="line">                unmount(oldVNode)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 如果新的孩子在老的孩子里面存在，则拿到老的孩子所对应的下标 + 1</span></span><br><span class="line">                newIndexToOldIndexMap[newIndex - s2] = j + <span class="number">1</span></span><br><span class="line">                <span class="comment">// 如果有，则对比新老节点</span></span><br><span class="line">                patch(oldVNode,c2[newIndex],el)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 倒序遍历新的中间节点。从后往前一次插入到页面中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = toBePatched - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; i--) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(i,<span class="string">&#x27;565656&#x27;</span>)</span><br><span class="line">            <span class="comment">// 当前元素的的在c2中的下标</span></span><br><span class="line">            <span class="keyword">const</span> currentIndex = i + s2</span><br><span class="line">            <span class="comment">// 当前元素在页面中的真实DOM节点</span></span><br><span class="line">            <span class="keyword">const</span> child = c2[currentIndex]</span><br><span class="line">            <span class="comment">// 当前元素在页面中的真实DOM节点的下一个兄弟节点</span></span><br><span class="line">            <span class="keyword">const</span> anchor = currentIndex + <span class="number">1</span> &lt; c2.length ? c2[currentIndex + <span class="number">1</span>].el : <span class="literal">null</span></span><br><span class="line">            <span class="built_in">console</span>.log(child,<span class="string">&#x27;555&#x27;</span>)</span><br><span class="line">            <span class="comment">// 判断这个元素是否在老的里面存在</span></span><br><span class="line">            <span class="keyword">if</span>(newIndexToOldIndexMap[i] === <span class="number">0</span>)&#123;</span><br><span class="line">                patch(<span class="literal">null</span>,child,el,anchor)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                hostInsert(child.el,el,anchor)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 比较两个元素的儿子</span></span><br><span class="line"><span class="comment"> * 比较儿子有如下四种情况</span></span><br><span class="line"><span class="comment"> * 1.老的有儿子，新的没儿子</span></span><br><span class="line"><span class="comment"> * 2.老的有儿子，新的有儿子</span></span><br><span class="line"><span class="comment"> * 3.老的没儿子，新的没儿子</span></span><br><span class="line"><span class="comment"> * 4.老的没儿子，新的有儿子</span></span><br><span class="line"><span class="comment"> * 5.新老都是文本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> patchChildren = <span class="function">(<span class="params">n1, n2, el</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> c1 = n1.children</span><br><span class="line">    <span class="keyword">let</span> c2 = n2.children</span><br><span class="line">    <span class="keyword">const</span> prevShapeFlag = n1.shapeFlag</span><br><span class="line">    <span class="keyword">const</span> shapeFlag = n2.shapeFlag</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果新元素是一个文本类型</span></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">        <span class="comment">// 如果老的孩子是一个元素数组，则吧老的孩子全部删除</span></span><br><span class="line">        <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">            unmountChildren(c1)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果老的孩子是一个文本类型，则直接更新文本</span></span><br><span class="line">        <span class="keyword">if</span> (c1 !== c2) &#123;</span><br><span class="line">            <span class="comment">// 直接给当前的el设置文本内容为新的内容</span></span><br><span class="line">            hostSetElementText(el, c2)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 新的不是文本，老的是一个数组</span></span><br><span class="line">        <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">                <span class="comment">// 两个数组元素比较</span></span><br><span class="line">                <span class="comment">// diff算法的核心</span></span><br><span class="line">                patchKeyedChildren(c1, c2, el)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 新的没有儿子，老的有儿子，则把老的儿子全部删除</span></span><br><span class="line">                unmountChildren(c1)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 新的不是文本，老的是一个文本</span></span><br><span class="line">            <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">                hostSetElementText(el, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 新的是一个元素</span></span><br><span class="line">            <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">                mountChildren(c2, el)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="前面相同，后面不同"><a href="#前面相同，后面不同" class="headerlink" title="前面相同，后面不同"></a>前面相同，后面不同</h4><p>前面相同，后面不同，从头开始比较</p>
<img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240228220300777.png" alt="image-20240228220300777" style="zoom: 50%;" />

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从头开始一个一个比较，遇到不同的就停止比较</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2) &#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[i]</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[i]</span><br><span class="line">    <span class="keyword">if</span> (isSameVNodeType(n1, n2)) &#123;</span><br><span class="line">        patch(n1, n2, el)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    i++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="后面相同，前面不同"><a href="#后面相同，前面不同" class="headerlink" title="后面相同，前面不同"></a>后面相同，前面不同</h4><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240228222747031.png" alt="image-20240228222747031" style="zoom: 50%;" />

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从尾部开始比较,特殊优化，尽可能缩小需要diff的范围</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2)&#123;</span><br><span class="line">    <span class="keyword">const</span> n1 = c1[e1]</span><br><span class="line">    <span class="keyword">const</span> n2 = c2[e2]</span><br><span class="line">    <span class="keyword">if</span>(isSameVNodeType(n1,n2))&#123;</span><br><span class="line">        patch(n1, n2, el)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    e1--</span><br><span class="line">    e2--</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="尾部追加"><a href="#尾部追加" class="headerlink" title="尾部追加"></a>尾部追加</h4><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240302143419175.png" alt="image-20240302143419175" style="zoom:50%;" />

<p>前后对比完成后，如果发现新的多，则往后面追加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比较完成后，如果i大于e1表示有新增的部分，老的少，新的多</span></span><br><span class="line"><span class="keyword">if</span>(i &gt; e1)&#123;</span><br><span class="line">    <span class="keyword">if</span>(i &lt;= e2)&#123;</span><br><span class="line">        <span class="keyword">const</span> nextPosition = e2 + <span class="number">1</span></span><br><span class="line">        <span class="comment">// 确认在那个元素之前插入</span></span><br><span class="line">        <span class="comment">// 判断如果e2 + 1大于新的孩子长度，表示在结尾</span></span><br><span class="line">        <span class="comment">// 否则就在当前e2的下一个元素之前插入</span></span><br><span class="line">        <span class="keyword">const</span> anchor = nextPosition &lt; c2.length ? c2[nextPosition].el : <span class="literal">null</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= e2)&#123;</span><br><span class="line">            patch(<span class="literal">null</span>,c2[i],el,anchor)</span><br><span class="line">            i++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="尾部删除"><a href="#尾部删除" class="headerlink" title="尾部删除"></a>尾部删除</h4><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240302143611218.png" alt="image-20240302143611218" style="zoom:50%;" />

<p>前后对比完成后，如果发现新的少，老的多，则删除老的多余节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(i &gt; e2)&#123; <span class="comment">// 表示老的多，新的少</span></span><br><span class="line">   <span class="keyword">while</span> (i &lt;= e1)&#123;</span><br><span class="line">       unmount(c1[i])</span><br><span class="line">       i++</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="最终进入乱序比较"><a href="#最终进入乱序比较" class="headerlink" title="最终进入乱序比较"></a>最终进入乱序比较</h4><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240302143739404.png" alt="image-20240302143739404" style="zoom:50%;" />

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 乱序比较，采用一个映射表，尽可能复用元素</span></span><br><span class="line">    <span class="keyword">let</span> s1 = i</span><br><span class="line">    <span class="keyword">let</span> s2 = i</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里存放的是新中间的元素的每一个下标</span></span><br><span class="line">    <span class="keyword">const</span> keyToNewIndexMap = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span>  childVNode = c2[j]</span><br><span class="line">        keyToNewIndexMap.set(childVNode.key,j)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到中间的需要对比的元素个数</span></span><br><span class="line">    <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span></span><br><span class="line">    <span class="comment">// 创建一个相同长度的数据，存放的是老的孩子的下标,默认都是0</span></span><br><span class="line">    <span class="comment">// 可以通过判断是不是0来确认这个节点是否需要被patch</span></span><br><span class="line">    <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="built_in">Array</span>(toBePatched).fill(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 去老的里面找，有没有可以复用的</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = s1; j &lt;= e1; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldVNode = c1[j]</span><br><span class="line">        <span class="comment">// 用老的key去看新的里面有没有这个key</span></span><br><span class="line">        <span class="keyword">const</span> newIndex = keyToNewIndexMap.get(oldVNode.key)</span><br><span class="line">        <span class="comment">// 如果这个key在新的孩子中没有，则删除掉老的</span></span><br><span class="line">        <span class="keyword">if</span>(newIndex === <span class="literal">undefined</span>)&#123;</span><br><span class="line">            unmount(oldVNode)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 如果新的孩子在老的孩子里面存在，则拿到老的孩子所对应的下标 + 1</span></span><br><span class="line">            newIndexToOldIndexMap[newIndex - s2] = j + <span class="number">1</span></span><br><span class="line">            <span class="comment">// 如果有，则对比新老节点</span></span><br><span class="line">            patch(oldVNode,c2[newIndex],el)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 倒序遍历新的中间节点。从后往前一次插入到页面中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = toBePatched - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; i--) &#123;</span><br><span class="line">        <span class="comment">// 当前元素的的在c2中的下标</span></span><br><span class="line">        <span class="keyword">const</span> currentIndex = i + s2</span><br><span class="line">        <span class="comment">// 当前元素在页面中的真实DOM节点</span></span><br><span class="line">        <span class="keyword">const</span> child = c2[currentIndex]</span><br><span class="line">        <span class="comment">// 当前元素在页面中的真实DOM节点的下一个兄弟节点</span></span><br><span class="line">        <span class="keyword">const</span> anchor = currentIndex + <span class="number">1</span> &lt; c2.length ? c2[currentIndex + <span class="number">1</span>].el : <span class="literal">null</span></span><br><span class="line">        <span class="built_in">console</span>.log(child,<span class="string">&#x27;555&#x27;</span>)</span><br><span class="line">        <span class="comment">// 判断这个元素是否在老的里面存在</span></span><br><span class="line">        <span class="keyword">if</span>(newIndexToOldIndexMap[i] === <span class="number">0</span>)&#123;</span><br><span class="line">            patch(<span class="literal">null</span>,child,el,anchor)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            hostInsert(child.el,el,anchor)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试比较结果"><a href="#测试比较结果" class="headerlink" title="测试比较结果"></a>测试比较结果</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> App = &#123;</span><br><span class="line">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> flag = ref(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            flag.value = <span class="literal">false</span></span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> flag.value ?</span><br><span class="line">                h(<span class="string">&quot;div&quot;</span>, &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;red&quot;</span>, <span class="string">&quot;font-size&quot;</span>: <span class="string">&quot;25px&quot;</span>&#125;&#125;, [</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;a&quot;</span>&#125;, <span class="string">&quot;a&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;b&quot;</span>&#125;, <span class="string">&quot;b&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;e&quot;</span>&#125;, <span class="string">&quot;e&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;f&quot;</span>&#125;, <span class="string">&quot;f&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;g&quot;</span>&#125;, <span class="string">&quot;g&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;l&quot;</span>&#125;, <span class="string">&quot;l&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;k&quot;</span>&#125;, <span class="string">&quot;k&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;c&quot;</span>&#125;, <span class="string">&quot;c&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;d&quot;</span>&#125;, <span class="string">&quot;d&quot;</span>),</span><br><span class="line">                ]) :</span><br><span class="line">                h(<span class="string">&quot;div&quot;</span>, &#123;<span class="attr">style</span>: &#123;<span class="attr">color</span>: <span class="string">&quot;blue&quot;</span>&#125;&#125;, [</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;a&quot;</span>&#125;, <span class="string">&quot;a&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;b&quot;</span>&#125;, <span class="string">&quot;b&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;g&quot;</span>&#125;, <span class="string">&quot;g&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;e&quot;</span>&#125;, <span class="string">&quot;e&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;f&quot;</span>&#125;, <span class="string">&quot;f&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;h&quot;</span>&#125;, <span class="string">&quot;h&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;c&quot;</span>&#125;, <span class="string">&quot;c&quot;</span>),</span><br><span class="line">                    h(<span class="string">&quot;li&quot;</span>, &#123;<span class="attr">key</span>: <span class="string">&quot;d&quot;</span>&#125;, <span class="string">&quot;d&quot;</span>),</span><br><span class="line">                ])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line">app.mount(<span class="string">&quot;#app&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/diffimg1.gif" alt="diffimg1"></p>
<p>观察动画发现虽然结果正确了，但是 g、e、f、h 四个节点都会发生一次变化。在老节点中，e、f 两个节点是连续在一起的，新的节点中 e、f 也是在一起的，我们只需要吧 g 直接插入到 e 的前面即可。</p>
<p>这个逻辑优化就是查找最长递增子序列。下面我们来实现这个优化</p>
<h3 id="最长递增子序列"><a href="#最长递增子序列" class="headerlink" title="最长递增子序列"></a>最长递增子序列</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSequence</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = arr.slice()                 <span class="comment">//  保存原始数据</span></span><br><span class="line">  <span class="keyword">const</span> result = [<span class="number">0</span>]                    <span class="comment">//  存储最长增长子序列的索引数组</span></span><br><span class="line">  <span class="keyword">let</span> i, j, u, v, c</span><br><span class="line">  <span class="keyword">const</span> len = arr.length</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> arrI = arr[i]</span><br><span class="line">    <span class="keyword">if</span> (arrI !== <span class="number">0</span>) &#123;</span><br><span class="line">      j = result[result.length - <span class="number">1</span>]     <span class="comment">//  j是子序列索引最后一项</span></span><br><span class="line">      <span class="keyword">if</span> (arr[j] &lt; arrI) &#123;              <span class="comment">//  如果arr[i] &gt; arr[j], 当前值比最后一项还大，可以直接push到索引数组(result)中去</span></span><br><span class="line">        p[i] = j                        <span class="comment">//  p记录第i个位置的索引变为j</span></span><br><span class="line">        result.push(i)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      u = <span class="number">0</span>                             <span class="comment">//  数组的第一项</span></span><br><span class="line">      v = result.length - <span class="number">1</span>             <span class="comment">//  数组的最后一项</span></span><br><span class="line">      <span class="keyword">while</span> (u &lt; v) &#123;                   <span class="comment">//  如果arrI &lt;= arr[j] 通过二分查找，将i插入到result对应位置；u和v相等时循环停止</span></span><br><span class="line">        c = ((u + v) / <span class="number">2</span>) | <span class="number">0</span>           <span class="comment">//  二分查找 </span></span><br><span class="line">        <span class="keyword">if</span> (arr[result[c]] &lt; arrI) &#123;</span><br><span class="line">          u = c + <span class="number">1</span>                     <span class="comment">//  移动u</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          v = c                         <span class="comment">//  中间的位置大于等于i,v=c</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (arrI &lt; arr[result[u]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (u &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          p[i] = result[u - <span class="number">1</span>]          <span class="comment">//  记录修改的索引</span></span><br><span class="line">        &#125;</span><br><span class="line">        result[u] = i                   <span class="comment">//  更新索引数组(result)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  u = result.length</span><br><span class="line">  v = result[u - <span class="number">1</span>]</span><br><span class="line">  <span class="comment">//把u值赋给result  </span></span><br><span class="line">  <span class="keyword">while</span> (u-- &gt; <span class="number">0</span>) &#123;                     <span class="comment">//  最后通过p数组对result数组进行进行修订，取得正确的索引</span></span><br><span class="line">    result[u] = v</span><br><span class="line">    v = p[v];                        </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以数组[2, 11, 6, 8, 1]为例：最终输出的结果为[0, 2, 3]，表示最强增长序列的索引分别是0, 2 ,3;对应的值是2,6,8。换句话说，在这个数组中最长连续增长的值就是数组中的2,6,8三个元素。</p>
<p>费了这么大的力气，使用这个方法的目的是什么呢？</p>
<p>Vue2在DOM-Diff过程中，优先处理特殊场景的情况，即头头比对，头尾比对，尾头比对等。</p>
<p>而Vue3在DOM-Diff过程中，根据 newIndexToOldIndexMap 新老节点索引列表找到最长稳定序列，通过最长增长子序列的算法比对，找出新旧节点中不需要移动的节点，原地复用，仅对需要移动或已经patch的节点进行操作，最大限度地提升替换效率，相比于Vue2版本是质的提升！</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240303154841690.png" alt="image-20240303154841690"></p>
<p>有了这个方法后我们就可以利用这个算法得出那些节点是可以直接跳过的</p>
<p>修改 else 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 乱序比较，采用一个映射表，尽可能复用元素</span></span><br><span class="line">    <span class="keyword">let</span> s1 = i</span><br><span class="line">    <span class="keyword">let</span> s2 = i</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里存放的是新中间的元素的每一个下标</span></span><br><span class="line">    <span class="keyword">const</span> keyToNewIndexMap = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = s2; j &lt;= e2; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span>  childVNode = c2[j]</span><br><span class="line">        keyToNewIndexMap.set(childVNode.key,j)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到中间的需要对比的元素个数</span></span><br><span class="line">    <span class="keyword">const</span> toBePatched = e2 - s2 + <span class="number">1</span></span><br><span class="line">    <span class="comment">// 创建一个相同长度的数据，存放的是老的孩子的下标,默认都是0</span></span><br><span class="line">    <span class="comment">// 可以通过判断是不是0来确认这个节点是否需要被patch</span></span><br><span class="line">    <span class="keyword">const</span> newIndexToOldIndexMap = <span class="keyword">new</span> <span class="built_in">Array</span>(toBePatched).fill(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 去老的里面找，有没有可以复用的</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = s1; j &lt;= e1; j++) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldVNode = c1[j]</span><br><span class="line">        <span class="comment">// 用老的key去看新的里面有没有这个key</span></span><br><span class="line">        <span class="keyword">const</span> newIndex = keyToNewIndexMap.get(oldVNode.key)</span><br><span class="line">        <span class="comment">// 如果这个key在新的孩子中没有，则删除掉老的</span></span><br><span class="line">        <span class="keyword">if</span>(newIndex === <span class="literal">undefined</span>)&#123;</span><br><span class="line">            unmount(oldVNode)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 如果新的孩子在老的孩子里面存在，则拿到老的孩子所对应的下标 + 1</span></span><br><span class="line">            newIndexToOldIndexMap[newIndex - s2] = j + <span class="number">1</span></span><br><span class="line">            <span class="comment">// 如果有，则对比新老节点</span></span><br><span class="line">            patch(oldVNode,c2[newIndex],el)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 求最长递增子序列</span></span><br><span class="line">    <span class="comment">// 比如：newIndexToOldIndexMap 的结果是 5, 3, 4, 0</span></span><br><span class="line">    <span class="comment">// 则对应的最长递增子序列是 3, 4 对应的下标是 1, 2。意思就是我得到了下标为1和2的节点不需要移动</span></span><br><span class="line">    <span class="keyword">let</span> increasingNewIndexSequence = getSequence(newIndexToOldIndexMap)</span><br><span class="line">    <span class="comment">// 用一个遍历记录最后以为的下标</span></span><br><span class="line">    <span class="keyword">let</span> j = increasingNewIndexSequence.length - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 倒序遍历新的中间节点。从后往前一次插入到页面中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = toBePatched - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; i--) &#123;</span><br><span class="line">        <span class="comment">// 当前元素的的在c2中的下标</span></span><br><span class="line">        <span class="keyword">const</span> currentIndex = i + s2</span><br><span class="line">        <span class="comment">// 当前元素在页面中的真实DOM节点</span></span><br><span class="line">        <span class="keyword">const</span> child = c2[currentIndex]</span><br><span class="line">        <span class="comment">// 当前元素在页面中的真实DOM节点的下一个兄弟节点</span></span><br><span class="line">        <span class="keyword">const</span> anchor = currentIndex + <span class="number">1</span> &lt; c2.length ? c2[currentIndex + <span class="number">1</span>].el : <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 判断这个元素是否在老的里面存在</span></span><br><span class="line">        <span class="keyword">if</span>(newIndexToOldIndexMap[i] === <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 直接吧这个新的放进去</span></span><br><span class="line">            patch(<span class="literal">null</span>,child,el,anchor)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 判断一下当前需要这个节点的下标是否在最长递增子序列里面，如果不存在，则这个节点需要移动</span></span><br><span class="line">            <span class="keyword">if</span>(i !== increasingNewIndexSequence[j])&#123;</span><br><span class="line">                hostInsert(child.el,el,anchor)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 否则不需要移动这个节点，并且让j--,继续判断前一个</span></span><br><span class="line">                j--</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看结果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/getSequence.gif" alt="getSequence"></p>
<p>仔细观察 e、f 节点，可以发现 e、f 并没有发生移动，这一点对比vue2的 diff 算法是质的变化，页面渲染效率提高很多。</p>
<h3 id="组件渲染流程图"><a href="#组件渲染流程图" class="headerlink" title="组件渲染流程图"></a>组件渲染流程图</h3><p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240303164900824.png" alt="image-20240303164900824"></p>
<h3 id="组件更新流程图"><a href="#组件更新流程图" class="headerlink" title="组件更新流程图"></a>组件更新流程图</h3><p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240304192359101.png" alt="image-20240304192359101"></p>
<h2 id="Vue3的模板编译过程的优化"><a href="#Vue3的模板编译过程的优化" class="headerlink" title="Vue3的模板编译过程的优化"></a>Vue3的模板编译过程的优化</h2><h3 id="blockTree和patchFlag"><a href="#blockTree和patchFlag" class="headerlink" title="blockTree和patchFlag"></a>blockTree和patchFlag</h3><p>在这个网址中可以查看vue3代码编译后的结果</p>
<p><a target="_blank" rel="noopener" href="https://template-explorer.vuejs.org/">https://template-explorer.vuejs.org/</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240304205511467.png" alt="image-20240304205511467"></p>
<p>复制这段编译后的代码到vue3的项目中去运行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; toDisplayString <span class="keyword">as</span> _toDisplayString, createElementVNode <span class="keyword">as</span> _createElementVNode, Fragment <span class="keyword">as</span> _Fragment, openBlock <span class="keyword">as</span> _openBlock, createElementBlock <span class="keyword">as</span> _createElementBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache, $props, $setup, $data, $options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (_openBlock(), _createElementBlock(_Fragment, <span class="literal">null</span>, [</span><br><span class="line">        _createElementVNode(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, _toDisplayString(_ctx.name), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">        _createElementVNode(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">            _createElementVNode(<span class="string">&quot;a&quot;</span>, &#123; <span class="attr">href</span>: _ctx.dyHref &#125;, _toDisplayString(_ctx.age), <span class="number">9</span> <span class="comment">/* TEXT, PROPS */</span>, [<span class="string">&quot;href&quot;</span>])</span><br><span class="line">        ])</span><br><span class="line">    ], <span class="number">64</span> <span class="comment">/* STABLE_FRAGMENT */</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(render(&#123;</span><br><span class="line">    name:<span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    age:<span class="number">18</span>,</span><br><span class="line">    href:<span class="string">&quot;http://baidu.com&quot;</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>可以看到收集到了两个动态节点</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240304205652323.png" alt="image-20240304205652323"></p>
<p>vue3在模板更新时加入了 blockTree 和 patchFlag</p>
<ul>
<li>blockTree 作用是收集了动态的节点，放在了 <strong>dynamicChildren</strong> 中</li>
<li>在进行diff对比的过程中去判断如果这个节点的dynamicChildren不为空，则遍历dynamicChildren中的节点进行比对，而不再进行全量diff</li>
<li>这样效率大大提高</li>
</ul>
<h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><ul>
<li>先将模板进行分析，生成对应的ast数。ast数是一个大对象，来描述语法的</li>
<li>然后做转化流程 transform -&gt; 对动态节点做一些标记，例如：指令、插槽、事件、属性….，这些标记会被记录到 patchFlag 属性中，对应不同的值</li>
<li>然后diff过程中会根据 patchFlag  的值，知道这个节点具体是哪个东西发生了改变，从而进行精准diff</li>
<li>最后代码生成 codegen -&gt; 生成最终代码</li>
</ul>
<h3 id="blokeTree"><a href="#blokeTree" class="headerlink" title="blokeTree"></a>blokeTree</h3><ul>
<li>diff 算法的特点是递归遍历，每次比较同一层，然后深度遍历比较所有，这样效率并不好</li>
<li>block 的作用就是为了收集动态节点，将树的递归拍平成了一个数组，只遍历收集起来的节点</li>
<li>在 createVnode 的时候，就会判断这个节点是不是动态的，然外层的 block 收集起来</li>
<li>目的是为了 diff 时只 diff 动态节点</li>
</ul>
<blockquote>
<p>如果会影响DOM结构的，例如 v-if v-else 都会被标记成 block 节点</p>
<p>父亲也会收集儿子的 block</p>
<p>最终多个 block 构成一个 blockTree</p>
</blockquote>
<h3 id="patchFlags"><a href="#patchFlags" class="headerlink" title="patchFlags"></a>patchFlags</h3><ul>
<li>对不同的类型进行描述</li>
</ul>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><ul>
<li>每次重新渲染时，都要创建一个虚拟节点，调用的是 createVnode 方法</li>
<li>当创建多个重复的静态节点时，会做静态提升，静态节点进行提取</li>
</ul>
<h3 id="Vue3和Vue2的对比"><a href="#Vue3和Vue2的对比" class="headerlink" title="Vue3和Vue2的对比"></a>Vue3和Vue2的对比</h3><ul>
<li>响应式原理：由 defineProperty 替换成了 proxy<ul>
<li>defineProperty 会递归对所有属性进行代理，而 proxy 只会在访问到这个属性时返回代理结果</li>
</ul>
</li>
<li>vue3 diff算法（可以根据 patchFlag 做 diff）vue2 的 diff 是全量 diff。其中 vue3的diff算法中用到了一个最长递增子序列的算法，如果有相邻的重复节点，则会跳过这些节点，提高性能</li>
<li>编码层面的变化：vue2采用 optionsAPI，vue3是 compositionAPI</li>
<li>vue3支持同时存在多个根节点，因为如果是多个根节点的情况，会自动的在最外面添加一个 Fragment</li>
<li>vue3源码全面采用ts编写，vue2是flow，类型退到不准确</li>
<li>vue3支持自定义渲染器 createRender() 传入自己的渲染方法，可以编译到不同平台</li>
</ul>
<h2 id="组件生命周期原理"><a href="#组件生命周期原理" class="headerlink" title="组件生命周期原理"></a>组件生命周期原理</h2><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>在组件的不同阶段会触发不同的钩子。当页面初次渲染和更新都会走 patch 方法，然而在初次渲染时，调用 patch 之前，会先获取当前组件的实例，去实例上获取声明的生命周期钩子函数，判断是否存在 onBeforeMount 钩子，如果有，就会先调用 onBeforeMount 方法，然后 patch 函数执行完毕后，调用 onMounted 钩子。然后组件更新时也会走 patch 方法，更新之前会判断是否存在 onBeforeUpdated 钩子，如果有，就会先调用 onBeforeUpdated  方法，更新完毕后，在调用 onUpdated 方法。</p>
<p>这里的核心是如何确保当前组件的声明周期钩子函数中获取到的实例是当前组件的。例如当父组件内包含一个子组件时，一定是先执行子组件的钩子，再执行父组件的钩子。</p>
<h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h3><p>下面来实现代码</p>
<p>找到 packages/runtime-core/src/component.ts 文件中调用 setup 的 setupStatefulComponent 函数</p>
<p>添加下面代码，分别导出</p>
<ul>
<li>currentInstance</li>
<li>getCurrentInstance</li>
<li>setCurrentInstance</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义变量保存当前的实例</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> currentInstance = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getCurrentInstance = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> currentInstance</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setCurrentInstance = <span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">    currentInstance = instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupStatefulComponent</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> Component = instance.type</span><br><span class="line">    <span class="keyword">let</span> &#123;setup&#125; = Component</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断组件上是否有setup函数</span></span><br><span class="line">    <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">        <span class="comment">// 设置当前组件的实例</span></span><br><span class="line">        currentInstance = instance</span><br><span class="line">        <span class="comment">// 组件中定义的setup函数，同时传递参数</span></span><br><span class="line">        <span class="comment">// 第一个参数是定义的props属性数据</span></span><br><span class="line">        <span class="comment">// 第二个是定义的context上下文对象</span></span><br><span class="line">        <span class="comment">// 上下文对象中包含：attrs、props、slots、emit、expose</span></span><br><span class="line">        <span class="keyword">let</span> setupContext = createSetupContext(instance)</span><br><span class="line">        <span class="comment">// 拿到setup函数的返回值进行不同的处理</span></span><br><span class="line">        <span class="keyword">let</span> setupResult = setup(instance.props, setupContext)</span><br><span class="line">        <span class="comment">// setup函数执行完毕后，将当前实例清空</span></span><br><span class="line">        currentInstance = <span class="literal">null</span></span><br><span class="line">        handleSetupResult(instance, setupResult)</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 组件中没有定义setup函数，则直接获取render函数</span></span><br><span class="line">        finishComponentSetup(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在执行 setup 之前将当前的实例赋给 currentInstance，然后 setup 函数执行完毕后清空 currentInstance</p>
<p>然后新建 packages/runtime-core/src/apiLifecycle.ts 文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;currentInstance, setCurrentInstance&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> enum LifeCycleHooks &#123;</span><br><span class="line">    BEFORE_MOUNT = <span class="string">&quot;bm&quot;</span>,</span><br><span class="line">    MOUNTED = <span class="string">&quot;m&quot;</span>,</span><br><span class="line">    BEFORE_UPDATE = <span class="string">&quot;bu&quot;</span>,</span><br><span class="line">    UPDATED = <span class="string">&quot;u&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createHook = <span class="function">(<span class="params">lifeCycle</span>) =&gt;</span> <span class="function">(<span class="params">hooke, target = currentInstance</span>) =&gt;</span> &#123;</span><br><span class="line">    injectHook(lifeCycle, hooke, target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectHook</span>(<span class="params">type, hooke, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!target) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">&quot;当前没有实例，无法执行钩子函数&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> hooks = target[type] || (target[type] = [])</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里的hook就是真正的钩子函数</span></span><br><span class="line"><span class="comment">         * onMounted(()=&gt;&#123;</span></span><br><span class="line"><span class="comment">         *     console.log(&quot;onMounted&quot;)</span></span><br><span class="line"><span class="comment">         * &#125;)</span></span><br><span class="line"><span class="comment">         * onMounted 方法第一个参数是一个函数，这个函数会被hooke变量接收</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> wrap = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            setCurrentInstance(target)</span><br><span class="line">            hooke.call(target)</span><br><span class="line">            setCurrentInstance(<span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        hooks.push(wrap)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行钩子函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> invokeArrayFns = <span class="function">(<span class="params">fns</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; fns.length; i++) &#123;</span><br><span class="line">        fns[i]()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onBeforeMount = createHook(LifeCycleHooks.BEFORE_MOUNT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onMounted = createHook(LifeCycleHooks.MOUNTED)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onBeforeUpdate = createHook(LifeCycleHooks.BEFORE_UPDATE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> onUpdated = createHook(LifeCycleHooks.UPDATED)</span><br></pre></td></tr></table></figure>

<p>这个文件中的 injectHook 方法巧妙的利用闭包保存了每个组件自己的实例，并且在执行钩子函数之前会调用 setCurrentInstance 方法保存当前实例，这样组件钩子内去调用 getCurrentInstance 方法是会准确的获取到当前的实例</p>
<p>并且将每个钩子名称做了简化，以数组的形式保存到当前实例中</p>
<p>实例上了钩子函数后，下一步就是要在合适的时机去执行这些钩子</p>
<p>找到 packages/runtime-core/src/renderer.ts 文件的 createRender 方法中的 setupRenderEffect 方法，这个方法中包含了挂载前，挂载完成，更新前，更新完成这四个时机</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿到实例上的render，创建effect，当数据发生变化时，重新触发effect，并且调用render函数</span></span><br><span class="line"><span class="keyword">const</span> setupRenderEffect = <span class="function">(<span class="params">instance, container</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个effect，在effect中调用render方法，这样render方法会拿到数据会收集这个effect，属性更新时effect会重新执行</span></span><br><span class="line">    <span class="comment">// 只要effect重新执行，render方法就会重新调用，这样页面就会重新渲染</span></span><br><span class="line">    effect(<span class="function"><span class="keyword">function</span> <span class="title">componentEffect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否是初次渲染</span></span><br><span class="line">        <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123;bm, m&#125; = instance</span><br><span class="line">            <span class="comment">// 更新之前调用组件的onBeforeMount钩子</span></span><br><span class="line">            <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">                invokeArrayFns(bm)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 初次渲染组件，调用render函数拿到返回值</span></span><br><span class="line">            <span class="keyword">let</span> subTree = instance.subTree = instance.render.call(instance.proxy, instance.proxy)</span><br><span class="line">            <span class="comment">// 调用patch进行页面渲染</span></span><br><span class="line">            patch(<span class="literal">null</span>, subTree, container)</span><br><span class="line">            <span class="comment">// 修改是否初次渲染的状态</span></span><br><span class="line">            instance.isMounted = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 页面渲染完毕后调用组件的onMounted钩子</span></span><br><span class="line">            <span class="keyword">if</span> (m) &#123;</span><br><span class="line">                invokeArrayFns(m)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123;bu, u&#125; = instance</span><br><span class="line">            <span class="comment">// 组件更新之前执行组件的onBeforeUpdate钩子</span></span><br><span class="line">            <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">                invokeArrayFns(bu)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 更新组件，调用render函数拿到最新的Node节点</span></span><br><span class="line">            <span class="keyword">let</span> prevTree = instance.subTree</span><br><span class="line">            <span class="keyword">let</span> proxyToUse = instance.proxy</span><br><span class="line">            <span class="keyword">let</span> nextTree = instance.render.call(proxyToUse, proxyToUse)</span><br><span class="line">            patch(prevTree, nextTree, container)</span><br><span class="line">            <span class="comment">// 组件更新之后执行组件的onUpdate钩子</span></span><br><span class="line">            <span class="keyword">if</span> (u) &#123;</span><br><span class="line">                invokeArrayFns(u)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        scheduler: <span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">            queueJob(effect)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后导出方法</p>
<p>packages/runtime-core/src/index.ts</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    createRender,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./renderer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    h</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    onBeforeMount,</span><br><span class="line">    onMounted,</span><br><span class="line">    onBeforeUpdate,</span><br><span class="line">    onUpdated</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./apiLifecycle&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;getCurrentInstance&#125; <span class="keyword">from</span> <span class="string">&quot;./component&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;@vue/reactivity&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试生命周期"><a href="#测试生命周期" class="headerlink" title="测试生命周期"></a>测试生命周期</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../node_modules/@vue/runtime-dom/dist/runtime-dom.global.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> &#123;</span></span><br><span class="line">        createApp,</span><br><span class="line">        h,</span><br><span class="line">        reactive,</span><br><span class="line">        ref,</span><br><span class="line">        onBeforeMount,</span><br><span class="line">        onMounted,</span><br><span class="line">        onBeforeUpdate,</span><br><span class="line">        onUpdated,</span><br><span class="line">        getCurrentInstance</span><br><span class="line">    &#125; = VueRuntimeDom</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> flag = ref(<span class="literal">true</span>)</span></span><br><span class="line"><span class="javascript">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        flag.value = <span class="literal">false</span></span></span><br><span class="line">    &#125;, 1000)</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> App = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 在每个生命周期调用时，就已经拿到了当前组件的实例</span></span></span><br><span class="line"><span class="javascript">            onBeforeMount(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;onBeforeMount&quot;</span>)</span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="javascript">            onMounted(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// 可以在生命周期内获取当前组件的实例</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> instance = getCurrentInstance()</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(instance)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;onMounted&quot;</span>)</span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="javascript">            onBeforeUpdate(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;onBeforeUpdate&quot;</span>)</span></span><br><span class="line">            &#125;)</span><br><span class="line"><span class="javascript">            onUpdated(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&quot;onUpdate&quot;</span>)</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> h(<span class="string">&quot;div&quot;</span>, flag.value)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> app = createApp(App)</span></span><br><span class="line"><span class="javascript">    app.mount(<span class="string">&quot;#app&quot;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240308091702528.png" alt="image-20240308091702528"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20240308091723623.png" alt="image-20240308091723623"></p>
<p>通过打印，可以发现组件的实例上已经添加了不同生命周期中的不同钩子</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">SZX</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://songzx0106.github.io/Vue/%E6%89%8B%E5%86%99vue3%E6%BA%90%E7%A0%81/">https://songzx0106.github.io/Vue/手写vue3源码/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://SongZX0106.github.io" target="_blank">SZX的开发笔记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/vue/">vue</a></div><div class="post_share"><div class="social-share" data-image="/images/ys03.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/share.min.css" media="print" onload="this.media='all'"><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/images/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/images/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/JavaScript/%E5%B7%A7%E7%94%A8CSS%E7%9A%84clamp%E5%87%BD%E6%95%B0/"><img class="prev-cover" data-lazy-src="/images/ys07.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">巧用CSS的clamp函数</div></div></a></div><div class="next-post pull-right"><a href="/JavaScript/%E4%BB%BFChatGPT%E5%85%89%E6%A0%87%E8%B7%9F%E9%9A%8F%E6%95%88%E6%9E%9C/"><img class="next-cover" data-lazy-src="/images/ys12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">仿ChatGPT光标跟随效果</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/WeiXin/01/" title="公众号H5页面接入微信登录流程"><img class="cover" data-lazy-src="/images/ys08.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">公众号H5页面接入微信登录流程</div></div></a></div><div><a href="/Vue/node+vue实现群聊功能/" title="使用node+prisma和vue3实现一个群聊功能"><img class="cover" data-lazy-src="/images/ys09.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-09</div><div class="title">使用node+prisma和vue3实现一个群聊功能</div></div></a></div><div><a href="/Vue/一个优雅的轮循代码/" title="一个优雅的轮循代码"><img class="cover" data-lazy-src="/images/ys16.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-23</div><div class="title">一个优雅的轮循代码</div></div></a></div><div><a href="/Vue/图片压缩上传/" title="前端使用Compressor.js实现图片压缩上传"><img class="cover" data-lazy-src="/images/ys11.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-10</div><div class="title">前端使用Compressor.js实现图片压缩上传</div></div></a></div><div><a href="/Vue/加载远程vue文件/" title="使用 vue3-sfc-loader 在运行时动态加载 .vue 文件"><img class="cover" data-lazy-src="/images/ys13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-11</div><div class="title">使用 vue3-sfc-loader 在运行时动态加载 .vue 文件</div></div></a></div><div><a href="/Vue/无限滚动效果/" title="大屏无限滚动效果实现"><img class="cover" data-lazy-src="/images/ys03.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-28</div><div class="title">大屏无限滚动效果实现</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/images/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">SZX</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">152</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/szxio"><i class="iconfont icon-gitee-fill-round"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">welcome to my blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Monorepo%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Monorepo介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue3%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">Vue3项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue3%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">Vue3构建流程搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%AD%90%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">声明子文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#reactivity"><span class="toc-number">3.2.1.</span> <span class="toc-text">reactivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shared"><span class="toc-number">3.2.2.</span> <span class="toc-text">shared</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC%E3%80%81rollup%E3%80%81ts%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">编译脚本、rollup、ts配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BA%92%E7%9B%B8%E5%BC%95%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">包之间的互相引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reactive-Api%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">reactive Api实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E4%B8%AA%E6%A0%B8%E5%BF%83%E7%9A%84API"><span class="toc-number">4.1.</span> <span class="toc-text">四个核心的API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFsourceMap"><span class="toc-number">4.2.</span> <span class="toc-text">开启sourceMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared-src-index-ts"><span class="toc-number">4.4.</span> <span class="toc-text">shared&#x2F;src&#x2F;index.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-index-ts"><span class="toc-number">4.5.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;index.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-reactive-ts"><span class="toc-number">4.6.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;reactive.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-baseHandlers-ts"><span class="toc-number">4.7.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;baseHandlers.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95reactive-Api"><span class="toc-number">4.8.</span> <span class="toc-text">测试reactive Api</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Effect%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86"><span class="toc-number">5.</span> <span class="toc-text">Effect依赖收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#effect-ts"><span class="toc-number">5.1.</span> <span class="toc-text">effect.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#baseHandlers-ts"><span class="toc-number">5.2.</span> <span class="toc-text">baseHandlers.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#operators-ts"><span class="toc-number">5.3.</span> <span class="toc-text">operators.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95effect"><span class="toc-number">5.4.</span> <span class="toc-text">测试effect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E6%9B%B4%E6%96%B0"><span class="toc-number">6.</span> <span class="toc-text">触发更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9createSetter%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">修改createSetter方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-operators-ts"><span class="toc-number">6.2.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;operators.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared-src-index-ts-1"><span class="toc-number">6.3.</span> <span class="toc-text">shared&#x2F;src&#x2F;index.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-effect-ts"><span class="toc-number">6.4.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;effect.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%A7%A6%E5%8F%91%E6%9B%B4%E6%96%B0"><span class="toc-number">6.5.</span> <span class="toc-text">测试触发更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ref-Api%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">ref Api实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E4%B8%AAAPI"><span class="toc-number">7.1.</span> <span class="toc-text">四个API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-ref-ts"><span class="toc-number">7.2.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;ref.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reactivity-src-index-ts-1"><span class="toc-number">7.3.</span> <span class="toc-text">reactivity&#x2F;src&#x2F;index.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95ref"><span class="toc-number">7.4.</span> <span class="toc-text">测试ref</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#computed%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">computed源码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runtimeDom%E5%92%8CruntimeCore"><span class="toc-number">9.</span> <span class="toc-text">runtimeDom和runtimeCore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAruntime-dom%E5%8C%85"><span class="toc-number">9.1.</span> <span class="toc-text">新建runtime-dom包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAruntime-core%E5%8C%85"><span class="toc-number">9.2.</span> <span class="toc-text">新建runtime-core包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">9.3.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patchNode"><span class="toc-number">9.4.</span> <span class="toc-text">patchNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patchProps"><span class="toc-number">9.5.</span> <span class="toc-text">patchProps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-dom%E5%AF%BC%E5%87%BAcreateApp%E6%96%B9%E6%B3%95"><span class="toc-number">9.6.</span> <span class="toc-text">runtime-dom导出createApp方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core%E5%AE%9E%E7%8E%B0createRender%E6%96%B9%E6%B3%95"><span class="toc-number">9.7.</span> <span class="toc-text">runtime-core实现createRender方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">10.</span> <span class="toc-text">组件创建流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-apiCreateApp-ts"><span class="toc-number">10.1.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;apiCreateApp.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-vnode-ts"><span class="toc-number">10.2.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;vnode.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shared-src-shapeFlags-ts"><span class="toc-number">10.3.</span> <span class="toc-text">shared&#x2F;src&#x2F;shapeFlags.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-renderer-ts"><span class="toc-number">10.4.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;renderer.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-component-ts"><span class="toc-number">10.5.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;component.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-PublicInstanceProxyHandlers-ts"><span class="toc-number">10.6.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;PublicInstanceProxyHandlers.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95setup%E5%87%BD%E6%95%B0%E5%92%8Crender%E5%87%BD%E6%95%B0"><span class="toc-number">10.7.</span> <span class="toc-text">测试setup函数和render函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86setup%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">11.</span> <span class="toc-text">处理setup的返回值</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-component-ts-1"><span class="toc-number">11.1.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;component.ts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-core-src-renderer-ts-1"><span class="toc-number">11.2.</span> <span class="toc-text">runtime-core&#x2F;src&#x2F;renderer.ts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">12.</span> <span class="toc-text">组件渲染流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96render%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">12.1.</span> <span class="toc-text">获取render函数的返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99h%E5%87%BD%E6%95%B0"><span class="toc-number">12.2.</span> <span class="toc-text">编写h函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%9F%A5%E7%9C%8B%E6%89%93%E5%8D%B0%E7%BB%93%E6%9E%9C"><span class="toc-number">12.3.</span> <span class="toc-text">测试查看打印结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="toc-number">12.4.</span> <span class="toc-text">实现组件渲染</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">13.</span> <span class="toc-text">组件更新流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E8%A7%A6%E5%8F%91%E4%B8%80%E6%AC%A1%E6%9B%B4%E6%96%B0"><span class="toc-number">13.1.</span> <span class="toc-text">只触发一次更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E4%B8%A4%E4%B8%AA%E5%85%83%E7%B4%A0%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-number">13.2.</span> <span class="toc-text">默认两个元素的比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%AF%94%E8%BE%83%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-number">13.3.</span> <span class="toc-text">特殊比较和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-patchChildren-%E6%96%B9%E6%B3%95"><span class="toc-number">13.3.1.</span> <span class="toc-text">实现  patchChildren 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E9%9D%A2%E7%9B%B8%E5%90%8C%EF%BC%8C%E5%90%8E%E9%9D%A2%E4%B8%8D%E5%90%8C"><span class="toc-number">13.3.2.</span> <span class="toc-text">前面相同，后面不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E9%9D%A2%E7%9B%B8%E5%90%8C%EF%BC%8C%E5%89%8D%E9%9D%A2%E4%B8%8D%E5%90%8C"><span class="toc-number">13.3.3.</span> <span class="toc-text">后面相同，前面不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%BE%E9%83%A8%E8%BF%BD%E5%8A%A0"><span class="toc-number">13.3.4.</span> <span class="toc-text">尾部追加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%BE%E9%83%A8%E5%88%A0%E9%99%A4"><span class="toc-number">13.3.5.</span> <span class="toc-text">尾部删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E8%BF%9B%E5%85%A5%E4%B9%B1%E5%BA%8F%E6%AF%94%E8%BE%83"><span class="toc-number">13.3.6.</span> <span class="toc-text">最终进入乱序比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%AF%94%E8%BE%83%E7%BB%93%E6%9E%9C"><span class="toc-number">13.3.7.</span> <span class="toc-text">测试比较结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97"><span class="toc-number">13.4.</span> <span class="toc-text">最长递增子序列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">13.5.</span> <span class="toc-text">组件渲染流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">13.6.</span> <span class="toc-text">组件更新流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue3%E7%9A%84%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">14.</span> <span class="toc-text">Vue3的模板编译过程的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#blockTree%E5%92%8CpatchFlag"><span class="toc-number">14.1.</span> <span class="toc-text">blockTree和patchFlag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B"><span class="toc-number">14.2.</span> <span class="toc-text">编译过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blokeTree"><span class="toc-number">14.3.</span> <span class="toc-text">blokeTree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patchFlags"><span class="toc-number">14.4.</span> <span class="toc-text">patchFlags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">14.5.</span> <span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue3%E5%92%8CVue2%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">14.6.</span> <span class="toc-text">Vue3和Vue2的对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%8E%9F%E7%90%86"><span class="toc-number">15.</span> <span class="toc-text">组件生命周期原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">15.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">15.2.</span> <span class="toc-text">实现代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">15.3.</span> <span class="toc-text">测试生命周期</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Java/springboot/%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" title="logback.xml 常用配置"><img data-lazy-src="/images/ys02.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="logback.xml 常用配置"/></a><div class="content"><a class="title" href="/Java/springboot/%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" title="logback.xml 常用配置">logback.xml 常用配置</a><time datetime="2024-11-22T06:09:55.000Z" title="发表于 2024-11-22 14:09:55">2024-11-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Vue/node+vue%E5%AE%9E%E7%8E%B0%E7%BE%A4%E8%81%8A%E5%8A%9F%E8%83%BD/" title="使用node+prisma和vue3实现一个群聊功能"><img data-lazy-src="/images/ys09.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用node+prisma和vue3实现一个群聊功能"/></a><div class="content"><a class="title" href="/Vue/node+vue%E5%AE%9E%E7%8E%B0%E7%BE%A4%E8%81%8A%E5%8A%9F%E8%83%BD/" title="使用node+prisma和vue3实现一个群聊功能">使用node+prisma和vue3实现一个群聊功能</a><time datetime="2024-10-09T02:30:49.000Z" title="发表于 2024-10-09 10:30:49">2024-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Vue/%E4%B8%80%E4%B8%AA%E4%BC%98%E9%9B%85%E7%9A%84%E8%BD%AE%E5%BE%AA%E4%BB%A3%E7%A0%81/" title="一个优雅的轮循代码"><img data-lazy-src="/images/ys16.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一个优雅的轮循代码"/></a><div class="content"><a class="title" href="/Vue/%E4%B8%80%E4%B8%AA%E4%BC%98%E9%9B%85%E7%9A%84%E8%BD%AE%E5%BE%AA%E4%BB%A3%E7%A0%81/" title="一个优雅的轮循代码">一个优雅的轮循代码</a><time datetime="2024-09-22T16:00:00.000Z" title="发表于 2024-09-23 00:00:00">2024-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JavaScript/pm2_linux_nginx/" title="pm2 + linux + nginx"><img data-lazy-src="/images/ys02.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="pm2 + linux + nginx"/></a><div class="content"><a class="title" href="/JavaScript/pm2_linux_nginx/" title="pm2 + linux + nginx">pm2 + linux + nginx</a><time datetime="2024-09-07T16:00:00.000Z" title="发表于 2024-09-08 00:00:00">2024-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JavaScript/scss%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%80%9A%E7%94%A8%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2/" title="巧用scss实现一个通用的媒介查询代码"><img data-lazy-src="/images/ys06.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="巧用scss实现一个通用的媒介查询代码"/></a><div class="content"><a class="title" href="/JavaScript/scss%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%80%9A%E7%94%A8%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2/" title="巧用scss实现一个通用的媒介查询代码">巧用scss实现一个通用的媒介查询代码</a><time datetime="2024-08-30T16:00:00.000Z" title="发表于 2024-08-31 00:00:00">2024-08-31</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/images/ys03.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By SZX</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">少年辛苦终身事，莫向光阴惰寸功。<a target="_blank" rel="noopener" href="https://gitee.com/szxio">My Gitee</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/instantpage.min.js" type="module"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'iJzt0X9OdhFCcdn4N0dJ86fY-gzGzoHsz',
      appKey: '8vtaRafgQSvU5ntYgszJfRW5',
      placeholder: '留下你的精彩评论',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/canvas-fluttering-ribbon.min.js"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,自由,平等,公正,法制,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>