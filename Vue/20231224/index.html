<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>手写Vue2源码 | SZX的开发笔记</title><meta name="keywords" content="Vue"><meta name="author" content="SZX"><meta name="copyright" content="SZX"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="使用rollup搭建开发环境使用rollup打包第三方库会比webpack更轻量，速度更快 首先安装依赖 123npm init -ynpm install rollup rollup-plugin-babel @babel&#x2F;core @babel&#x2F;preset-env --save-dev  然后添加 rollup 的配置文件 rollup.config.js 12345678910111213">
<meta property="og:type" content="article">
<meta property="og:title" content="手写Vue2源码">
<meta property="og:url" content="https://songzx0106.github.io/Vue/20231224/index.html">
<meta property="og:site_name" content="SZX的开发笔记">
<meta property="og:description" content="使用rollup搭建开发环境使用rollup打包第三方库会比webpack更轻量，速度更快 首先安装依赖 123npm init -ynpm install rollup rollup-plugin-babel @babel&#x2F;core @babel&#x2F;preset-env --save-dev  然后添加 rollup 的配置文件 rollup.config.js 12345678910111213">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://songzx0106.github.io/images/ys10.jpg">
<meta property="article:published_time" content="2023-12-24T08:28:09.000Z">
<meta property="article:modified_time" content="2024-11-22T06:14:31.209Z">
<meta property="article:author" content="SZX">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://songzx0106.github.io/images/ys10.jpg"><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://songzx0106.github.io/Vue/20231224/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":5000,"languages":{"author":"作者: SZX","link":"链接: ","source":"来源: SZX的开发笔记","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/jquery.min.js',
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-22 14:14:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2467717_jlvw8717b8.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/images/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">157</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/ys10.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">SZX的开发笔记</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">手写Vue2源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-24T08:28:09.000Z" title="发表于 2023-12-24 16:28:09">2023-12-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-22T06:14:31.209Z" title="更新于 2024-11-22 14:14:31">2024-11-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="手写Vue2源码"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="使用rollup搭建开发环境"><a href="#使用rollup搭建开发环境" class="headerlink" title="使用rollup搭建开发环境"></a>使用rollup搭建开发环境</h2><p>使用rollup打包第三方库会比webpack更轻量，速度更快</p>
<p>首先安装依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line">npm install rollup rollup-plugin-babel @babel/core @babel/preset-env --save-dev</span><br></pre></td></tr></table></figure>

<p>然后添加 rollup 的配置文件 <code>rollup.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> babel <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-babel&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    input:<span class="string">&quot;./src/index.js&quot;</span>, <span class="comment">// 配置入口文件</span></span><br><span class="line">    output:&#123;</span><br><span class="line">        file:<span class="string">&quot;./desc/vue.js&quot;</span>, <span class="comment">// 配置打包文件存放位置以及打包后生成的文件名</span></span><br><span class="line">        name:<span class="string">&quot;Vue&quot;</span>,<span class="comment">// 全局挂载一个Vue变量</span></span><br><span class="line">        format:<span class="string">&quot;umd&quot;</span>, <span class="comment">// 兼容esm es6模块</span></span><br><span class="line">        sourcemap:<span class="literal">true</span>, <span class="comment">// 可以调试源代码</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        babel(&#123;</span><br><span class="line">            exclude:<span class="string">&quot;node_modules/**&quot;</span>, <span class="comment">// 排除node_modules文件夹下的所有文件</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 babel 的配置文件 <code>.babelrc</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;@babel/preset-env&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 <code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;vue2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;dev&quot;</span>: <span class="string">&quot;rollup -cw&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;ISC&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@babel/core&quot;</span>: <span class="string">&quot;^7.23.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@babel/preset-env&quot;</span>: <span class="string">&quot;^7.23.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rollup&quot;</span>: <span class="string">&quot;^4.3.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rollup-plugin-babel&quot;</span>: <span class="string">&quot;^4.4.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;module&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>记得在 <code>package.json</code> 后面添加 <code>&quot;type&quot;: &quot;module&quot;</code>，否则启动时会提示 <code>import babel from &quot;rollup-plugin-babel&quot;</code> 错误</p>
<p>准备完成后运行启动命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231106213102696.png" alt="image-20231106213102696"></p>
<p>出现上图表示启动成功，并且正在监听文件变化，文件变化后会自动重新打包</p>
<p>查看打包出来的文件</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231106213146041.png" alt="image-20231106213146041"></p>
<p>然后新建一个 <code>index.html</code> 引入打包出来的 <code>vue.js</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(Vue)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问这个文件，并打开控制台查看打印</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231106213254103.png" alt="image-20231106213254103"></p>
<p>至此，我们准备工作完成，接下来开始实现Vue核心部分。</p>
<h2 id="初始化数据"><a href="#初始化数据" class="headerlink" title="初始化数据"></a>初始化数据</h2><p>修改 <code>src/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initMixin&#125; <span class="keyword">from</span> <span class="string">&quot;./init&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>

<p>添加 <code>init.js</code> ，用于初始化数据操作，并导出 initMixin 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initStatus&#125; <span class="keyword">from</span> <span class="string">&quot;./state.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 给Vue原型添加一个初始化方法</span></span><br><span class="line">    Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">        vm.$options = options</span><br><span class="line">        <span class="comment">// 初始化状态</span></span><br><span class="line">        initStatus(vm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>state.js</code> 的写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initStatus</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> opt = vm.$options</span><br><span class="line">    <span class="keyword">if</span>(opt.data)&#123;</span><br><span class="line">        initData(vm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">    data = <span class="keyword">typeof</span> data === <span class="string">&quot;function&quot;</span> ? data.call(vm) : data</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们打开控制台查看打印的东西</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231106222427949.png" alt="image-20231106222427949"></p>
<p>可以发现已经正确的得到data数据</p>
<h2 id="实现对象的响应式"><a href="#实现对象的响应式" class="headerlink" title="实现对象的响应式"></a>实现对象的响应式</h2><p>现在我们在 initData 方法中拿到了data，接下来就是对data中的属性进行数据劫持</p>
<p>在 initData 中添加 observe 方法，并传递data对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">    data = <span class="keyword">typeof</span> data === <span class="string">&quot;function&quot;</span> ? data.call(vm) : data</span><br><span class="line">    <span class="comment">// 拿到数据开始进行数据劫持，把数据变成响应式的</span></span><br><span class="line">    observe(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建 <code>observe/index.js</code> 文件，实现 observe 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.walk(data)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">walk</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 循环对象中的每一个属性进行劫持</span></span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">            defineReactive(data,key,data[key])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">target,key,value</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 这里对当前的值进行判断，如果值还是一个对象，则递归继续进行深度劫持</span></span><br><span class="line">    observe(value)</span><br><span class="line">    <span class="comment">// Object.defineProperty 接收三个参数，第一个是对象，第二是要劫持的key，第三个是一个对象，里面有get和set方法</span></span><br><span class="line">    <span class="comment">// 当读取这个key是，会触发get方法，当设置key时，会触发set方法，并接收新值</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target,key,&#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(newValue === value) <span class="keyword">return</span></span><br><span class="line">            value = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 对这个对象进行劫持，需要判断一下是否是一个对象，如果不是一个对象不能进行劫持</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data !== <span class="string">&quot;object&quot;</span> || data === <span class="literal">null</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observer(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在对数据就劫持完成了，但是我们如何获取呢？我们可以吧data方法返回的对象挂载到Vue的实例上即可</p>
<p>还是在 initData 方法内添加代码，并且增加一个 proxy 方法，让我们可以通过 vm.xxx 的方式直接获取data中的属性值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">    data = <span class="keyword">typeof</span> data === <span class="string">&quot;function&quot;</span> ? data.call(vm) : data</span><br><span class="line">    <span class="comment">// 拿到数据开始进行数据劫持，把数据变成响应式的</span></span><br><span class="line">    observe(data)</span><br><span class="line">    <span class="comment">// 吧data方法返回的对象挂载到Vue的实例上</span></span><br><span class="line">    vm._data = data</span><br><span class="line">    <span class="comment">// 目前取值必须通过 vm._data.xxx 的方式来获取值或者设置值</span></span><br><span class="line">    <span class="comment">// 如果想直接通过 vm.xxx 的方式来设置值，则必须对vm再进行一次代理</span></span><br><span class="line">    proxy(vm,<span class="string">&quot;_data&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">target,key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> dataKey <span class="keyword">in</span> target[key]) &#123;</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(target, dataKey,&#123;</span><br><span class="line">            <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> target[key][dataKey]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">                target[key][dataKey] = newValue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在来打印一下 vm</p>
<img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231113221208916.png" alt="image-20231113221208916" style="zoom: 80%;" />

<p>通过打印发现，vm 自身上就有了data中定义的属性</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231113221427297.png" alt="image-20231113221427297"></p>
<p>并且直接通过 vm 来读取和设置属性值也是可以的</p>
<h2 id="实现数组的响应式"><a href="#实现数组的响应式" class="headerlink" title="实现数组的响应式"></a>实现数组的响应式</h2><p>实现思路：</p>
<ol>
<li>首先遍历数组中的内容，吧数组中的数据变成响应式的</li>
<li>如果调用的数组中的方法，添加了新的数据，则也要吧新的数据变成响应式的，这里可以劫持7个变异方法来实现</li>
</ol>
<p>首先在 Observer 类中添加判断，如果data是一个数组，则单独走一个observeArray方法，来实现对数组的响应式处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;newArrayProperty&#125; <span class="keyword">from</span> <span class="string">&quot;./array.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 定义一个__ob__，值是this，不可枚举</span></span><br><span class="line">        <span class="comment">// 给数据加了一个标识，表示这个数据是一个已经被响应式了的</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data,<span class="string">&quot;__ob__&quot;</span>,&#123;</span><br><span class="line">            <span class="comment">// 定义这个属性值是当前的实例</span></span><br><span class="line">            value:<span class="built_in">this</span>,</span><br><span class="line">            <span class="comment">// 定义__ob__不能被遍历，否则会引起死循环</span></span><br><span class="line">            <span class="comment">// 原因：在walk方法中会递归遍历对象中的每一个属性进行响应式处理，因为__ob__表示的当前对象的实例</span></span><br><span class="line">            <span class="comment">// 实例本身又包含__ob__，这样就会导致递归无限往里面找，就造成了死循环，</span></span><br><span class="line">            <span class="comment">// 所以这里要设置成 enumerable：false，不能遍历 __ob__ 这个属性</span></span><br><span class="line">            enumerable:<span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 如果data中的某个值定义的是一个数组，则对数组进行劫持，进行响应式处理</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(data))&#123;</span><br><span class="line">            data.__proto__ = newArrayProperty</span><br><span class="line">            <span class="built_in">this</span>.observeArray(data)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.walk(data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">walk</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 循环对象中的每一个属性进行劫持</span></span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">            defineReactive(data,key,data[key])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对数组中的数据进行响应式处理</span></span><br><span class="line">    <span class="function"><span class="title">observeArray</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        data.forEach(<span class="function"><span class="params">item</span>=&gt;</span>observe(item))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里在 data 中定义了 <code>__ob__</code> 属性，并且值等于当前的 Observer 实例，是为了在 array.js 中拿到 Observe 实例中的 observeArray 方法，来实现对新传递进来的数据进行响应式处理</p>
<p>既然有了这个 <code>__ob__</code> 属性，我们就可以判断一下，如果 data 中有了 <code>__ob__</code> 属性，则表示这个数据已经被响应式了，则不需要进行再次响应式，所以我们可以在 observe 方法中加一个判断</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 对这个对象进行劫持，需要判断一下是否是一个对象，如果不是一个对象不能进行劫持</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data !== <span class="string">&quot;object&quot;</span> || data === <span class="literal">null</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 如果这个对象已经被代理过了，则直接返回当前示例</span></span><br><span class="line">    <span class="keyword">if</span>(data.__ob__)&#123;</span><br><span class="line">        <span class="keyword">return</span> data.__ob__</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observer(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后下面是 array.js 的实现代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取原始的数组原型链</span></span><br><span class="line"><span class="keyword">let</span> oldArrayProperty = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="comment">// 复制一份出来，到新的对象中</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> newArrayProperty = <span class="built_in">Object</span>.create(oldArrayProperty)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明数组的变异方法有哪些</span></span><br><span class="line"><span class="keyword">let</span> methods = [<span class="string">&quot;push&quot;</span>, <span class="string">&quot;pop&quot;</span>, <span class="string">&quot;unshift&quot;</span>, <span class="string">&quot;shift&quot;</span>, <span class="string">&quot;reserve&quot;</span>, <span class="string">&quot;sort&quot;</span>, <span class="string">&quot;splice&quot;</span>]</span><br><span class="line"></span><br><span class="line">methods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 调用新的方法时，接收传递进来的参数，然后再调用一下原来的</span></span><br><span class="line">    newArrayProperty[method] = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 判断如果是下面的几个方法，则要对传递进来的参数继续进行响应式处理</span></span><br><span class="line">        <span class="keyword">let</span> inserted;</span><br><span class="line">        <span class="comment">// 这里的this指向的是函数的调用者，所以这里的this指向的是data，也就是在Observer类中接收到data</span></span><br><span class="line">        <span class="comment">// 恰好我们给data的__ob__属性设置了值，等于Observe实例，</span></span><br><span class="line">        <span class="comment">// 利用这点就可以拿到Observe中的observeArray方法，来对新数据进行响应式处理</span></span><br><span class="line">        <span class="keyword">let</span> ob = <span class="built_in">this</span>.__ob__</span><br><span class="line">        <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;push&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;unshift&quot;</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;shift&quot;</span>:</span><br><span class="line">                inserted = args;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;splice&quot;</span>:</span><br><span class="line">                inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(inserted)&#123;</span><br><span class="line">            <span class="comment">// 对传递进来的参数继续进行响应式处理</span></span><br><span class="line">            ob.observeArray(inserted)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将结果返回</span></span><br><span class="line">        <span class="keyword">return</span> oldArrayProperty[method].call(<span class="built_in">this</span>, ...args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在看一下效果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231116223803895.png" alt="image-20231116223803895"></p>
<p>可以看到我们新 push 的数据也被响应式了</p>
<h2 id="解析HTML模板"><a href="#解析HTML模板" class="headerlink" title="解析HTML模板"></a>解析HTML模板</h2><p>我们可以根据option中的el来获取到根标签，然后获取对应的html，拿到html后开始解析</p>
<p>先写一些测试代码，准备一个html页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 15px;color: blue&quot;</span> <span class="attr">data-name</span> = <span class="string">&quot;123&quot;</span>&gt;</span></span><br><span class="line">            &#123;&#123;name&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span>&gt;</span></span><br><span class="line">            &#123;&#123;age&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> vm =  <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el:<span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">data</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span>&#123;</span></span><br><span class="line"><span class="javascript">                name:<span class="string">&quot;szx&quot;</span>,</span></span><br><span class="line">                age:18,</span><br><span class="line">                address:&#123;</span><br><span class="line">                    price:100,</span><br><span class="line"><span class="javascript">                    name:<span class="string">&quot;少林寺&quot;</span></span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                hobby:[<span class="string">&#x27;each&#x27;</span>,<span class="string">&#x27;write&#x27;</span>,&#123;<span class="attr">a</span>:<span class="string">&quot;tome&quot;</span>&#125;]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后来到 init.js 中的 initMixin 方法，判断一下是否有 el 这个属性，如果有则开始进行模板解析</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initStatus&#125; <span class="keyword">from</span> <span class="string">&quot;./state.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;compilerToFunction&#125; <span class="keyword">from</span> <span class="string">&quot;./compile/index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 给Vue原型添加一个初始化方法</span></span><br><span class="line">    Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">        vm.$options = options</span><br><span class="line">        <span class="comment">// 初始化状态</span></span><br><span class="line">        initStatus(vm)</span><br><span class="line">        <span class="comment">// 解析模板字符串</span></span><br><span class="line">        <span class="keyword">if</span>(vm.$options.el)&#123;</span><br><span class="line">            vm.$mount(vm.$options.el)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在原型链上添加$mount方法，用户获取页面模板</span></span><br><span class="line">    Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params">el</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> template;</span><br><span class="line">        <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">        <span class="comment">// 判断配置中是否已经存在template，如果没有，则根据el获取页面模板</span></span><br><span class="line">        <span class="keyword">if</span>(!opts.render)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!opts.template &amp;&amp; opts.el)&#123;</span><br><span class="line">                <span class="comment">// 拿到模板字符串</span></span><br><span class="line">                template = <span class="built_in">document</span>.querySelector(el).outerHTML</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(opts.template)&#123;</span><br><span class="line">                template = opts.template</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(template)&#123;</span><br><span class="line">                <span class="comment">// 这里拿到模板开始进行模板编译</span></span><br><span class="line">                <span class="keyword">const</span> render = compilerToFunction(template)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有render函数后再执行后续操作</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面就是 <code>compilerToFunction</code> 的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unicodeRegExp = <span class="regexp">/a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/</span></span><br><span class="line"><span class="keyword">const</span> ncname = <span class="string">`[a-zA-Z_][\\-\\.0-9_a-zA-Z<span class="subst">$&#123;unicodeRegExp.source&#125;</span>]*`</span></span><br><span class="line"><span class="keyword">const</span> qnameCapture = <span class="string">`((?:<span class="subst">$&#123;ncname&#125;</span>\\:)?<span class="subst">$&#123;ncname&#125;</span>)`</span></span><br><span class="line"><span class="keyword">const</span> startTagOpen = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;<span class="subst">$&#123;qnameCapture&#125;</span>`</span>)</span><br><span class="line"><span class="comment">// 匹配到的是结束标签的名字 &lt;/xxx&gt;</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;\\/<span class="subst">$&#123;qnameCapture&#125;</span>[^&gt;]*&gt;`</span>)</span><br><span class="line"><span class="comment">// 匹配属性的正则，第一个分组是key，value则是分组3/分组4/分组5</span></span><br><span class="line"><span class="keyword">const</span> attribute = <span class="regexp">/^\s*([^\s&quot;&#x27;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&#x27;([^&#x27;]*)&#x27;+|([^\s&quot;&#x27;=&lt;&gt;`]+)))?/</span></span><br><span class="line"><span class="comment">// 匹配自闭和的标签</span></span><br><span class="line"><span class="keyword">const</span> startTagClose = <span class="regexp">/^\s*(\/?)&gt;/</span></span><br><span class="line"><span class="comment">// 匹配花括号中的的内容</span></span><br><span class="line"><span class="keyword">const</span> defaultTagRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHtml</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 前进</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">advance</span>(<span class="params">n</span>)</span>&#123;</span><br><span class="line">        html = html.substring(n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parseStart</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 匹配开始标签</span></span><br><span class="line">        <span class="keyword">let</span> start = html.match(startTagOpen)</span><br><span class="line">        <span class="keyword">if</span>(start)&#123;</span><br><span class="line">            <span class="keyword">const</span> match = &#123;</span><br><span class="line">                <span class="comment">// 获取到标签名</span></span><br><span class="line">                tagName:start[<span class="number">1</span>],</span><br><span class="line">                attrs:[]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 截取已经匹配到的内容</span></span><br><span class="line">            advance(start[<span class="number">0</span>].length)</span><br><span class="line">            <span class="comment">// 循环匹配剩下的属性，如果不是开始标签的结束位置，则开始匹配属性</span></span><br><span class="line">            <span class="keyword">let</span> attr,end;</span><br><span class="line">            <span class="keyword">while</span> (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(attribute)))&#123;</span><br><span class="line">                match.attrs.push(&#123;</span><br><span class="line">                    name:attr[<span class="number">1</span>],</span><br><span class="line">                    value:attr[<span class="number">3</span>] || attr[<span class="number">4</span>] || attr[<span class="number">5</span>] || <span class="literal">true</span></span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 匹配到一点后就删除一点</span></span><br><span class="line">                advance(attr[<span class="number">0</span>].length)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(end)&#123;</span><br><span class="line">                advance(end[<span class="number">0</span>].length)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(match)</span><br><span class="line">            <span class="keyword">return</span> match</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (html)&#123;</span><br><span class="line">        <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">&#x27;&lt;&#x27;</span>);</span><br><span class="line">        <span class="comment">// 判断做尖括号的位置，如果是0表示这是一个开始标签</span></span><br><span class="line">        <span class="keyword">if</span>(textEnd === <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 匹配开始标签</span></span><br><span class="line">            <span class="keyword">const</span> startTagMatch = parseStart()</span><br><span class="line">            <span class="keyword">if</span>(startTagMatch)&#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 匹配结束标签</span></span><br><span class="line">            <span class="keyword">let</span> endTagMatch = html.match(endTag)</span><br><span class="line">            <span class="keyword">if</span>(endTagMatch)&#123;</span><br><span class="line">                advance(endTagMatch[<span class="number">0</span>].length)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进入到这里说明匹配到了文本：&#123;&#123; xxx &#125;&#125;</span></span><br><span class="line">        <span class="keyword">if</span>(textEnd &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> text = html.substring(<span class="number">0</span>,textEnd)</span><br><span class="line">            <span class="keyword">if</span>(text)&#123;</span><br><span class="line">                advance(text.length)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(html)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compilerToFunction</span>(<span class="params">template</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ast = parseHtml(template)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码在不断的解析html内容，匹配到开始标签，就会标签名称和属性放在match数组中，并且删除一已经匹配到的内容，如果匹配到文本或者结束版本则删除匹配到的内容，最终html变成空，表示解析过程就结束了。</p>
<p>我们通过打印看一下html被解析的过程</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231118161020648.png" alt="image-20231118161020648"></p>
<p>可以看到html的内容再不断减少</p>
<p>接下来，我们只需要在这些方法中添加如果匹配到开始标签，就触发一个方法处理开始标签的内容，如果匹配到文本，就处理文本内容，如果匹配到结束标签，就处理结束标签的内容。</p>
<p>在 parseHtml 方法中添加三个方法如下，分别处理开始标签，文本，结束标签</p>
<ul>
<li>onStartTag</li>
<li>onText</li>
<li>onCloseTag</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unicodeRegExp = <span class="regexp">/a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/</span></span><br><span class="line"><span class="keyword">const</span> ncname = <span class="string">`[a-zA-Z_][\\-\\.0-9_a-zA-Z<span class="subst">$&#123;unicodeRegExp.source&#125;</span>]*`</span></span><br><span class="line"><span class="keyword">const</span> qnameCapture = <span class="string">`((?:<span class="subst">$&#123;ncname&#125;</span>\\:)?<span class="subst">$&#123;ncname&#125;</span>)`</span></span><br><span class="line"><span class="keyword">const</span> startTagOpen = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;<span class="subst">$&#123;qnameCapture&#125;</span>`</span>)</span><br><span class="line"><span class="comment">// 匹配到的是结束标签的名字 &lt;/xxx&gt;</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;\\/<span class="subst">$&#123;qnameCapture&#125;</span>[^&gt;]*&gt;`</span>)</span><br><span class="line"><span class="comment">// 匹配属性的正则，第一个分组是key，value则是分组3/分组4/分组5</span></span><br><span class="line"><span class="keyword">const</span> attribute = <span class="regexp">/^\s*([^\s&quot;&#x27;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&#x27;([^&#x27;]*)&#x27;+|([^\s&quot;&#x27;=&lt;&gt;`]+)))?/</span></span><br><span class="line"><span class="comment">// 匹配自闭和的标签</span></span><br><span class="line"><span class="keyword">const</span> startTagClose = <span class="regexp">/^\s*(\/?)&gt;/</span></span><br><span class="line"><span class="comment">// 匹配花括号中的的内容</span></span><br><span class="line"><span class="keyword">const</span> defaultTagRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHtml</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理开始标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onStartTag</span>(<span class="params">tag,attrs</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(tag,attrs)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;开始标签&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理文本标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onText</span>(<span class="params">text</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(text)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;文本&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理结束标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCloseTag</span>(<span class="params">tag</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(tag)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;结束标签&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前进</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">advance</span>(<span class="params">n</span>)</span>&#123;</span><br><span class="line">        html = html.substring(n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parseStart</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 匹配开始标签</span></span><br><span class="line">        <span class="keyword">let</span> start = html.match(startTagOpen)</span><br><span class="line">        <span class="keyword">if</span>(start)&#123;</span><br><span class="line">            <span class="keyword">const</span> match = &#123;</span><br><span class="line">                <span class="comment">// 获取到标签名</span></span><br><span class="line">                tagName:start[<span class="number">1</span>],</span><br><span class="line">                attrs:[]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 截取已经匹配到的内容</span></span><br><span class="line">            advance(start[<span class="number">0</span>].length)</span><br><span class="line">            <span class="comment">// 循环匹配剩下的属性，如果不是开始标签的结束位置，则开始匹配属性</span></span><br><span class="line">            <span class="keyword">let</span> attr,end;</span><br><span class="line">            <span class="keyword">while</span> (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(attribute)))&#123;</span><br><span class="line">                match.attrs.push(&#123;</span><br><span class="line">                    name:attr[<span class="number">1</span>],</span><br><span class="line">                    value:attr[<span class="number">3</span>] || attr[<span class="number">4</span>] || attr[<span class="number">5</span>] || <span class="literal">true</span></span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 匹配到一点后就删除一点</span></span><br><span class="line">                advance(attr[<span class="number">0</span>].length)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(end)&#123;</span><br><span class="line">                advance(end[<span class="number">0</span>].length)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> match</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (html)&#123;</span><br><span class="line">        <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">&#x27;&lt;&#x27;</span>);</span><br><span class="line">        <span class="comment">// 判断做尖括号的位置，如果是0表示这是一个开始标签</span></span><br><span class="line">        <span class="keyword">if</span>(textEnd === <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 匹配开始标签</span></span><br><span class="line">            <span class="keyword">const</span> startTagMatch = parseStart()</span><br><span class="line">            <span class="keyword">if</span>(startTagMatch)&#123;</span><br><span class="line">                onStartTag(startTagMatch.tagName,startTagMatch.attrs)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 匹配结束标签</span></span><br><span class="line">            <span class="keyword">let</span> endTagMatch = html.match(endTag)</span><br><span class="line">            <span class="keyword">if</span>(endTagMatch)&#123;</span><br><span class="line">                onCloseTag(endTagMatch[<span class="number">1</span>])</span><br><span class="line">                advance(endTagMatch[<span class="number">0</span>].length)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 进入到这里说明匹配到了文本：&#123;&#123; xxx &#125;&#125;</span></span><br><span class="line">        <span class="keyword">if</span>(textEnd &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> text = html.substring(<span class="number">0</span>,textEnd)</span><br><span class="line">            <span class="keyword">if</span>(text)&#123;</span><br><span class="line">                onText(text)</span><br><span class="line">                advance(text.length)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(html)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compilerToFunction</span>(<span class="params">template</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ast = parseHtml(template)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在在相对应的代码中调用者三个方法</p>
<p>查看打印效果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231118163156963.png" alt="image-20231118163156963"></p>
<p>接下来构建语法树</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHtml</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> ELEMENT_TYPE = <span class="number">1</span> <span class="comment">// 标记这是一个元素</span></span><br><span class="line">    <span class="keyword">const</span> TEXT_TYPE = <span class="number">3</span> <span class="comment">// 标记这是一个文本</span></span><br><span class="line">    <span class="keyword">const</span> stack = [] <span class="comment">// 声明一个栈</span></span><br><span class="line">    <span class="keyword">let</span> currentParent;</span><br><span class="line">    <span class="keyword">let</span> root;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createNode</span>(<span class="params">tag,attrs</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            tag,</span><br><span class="line">            attrs,</span><br><span class="line">            type:ELEMENT_TYPE,</span><br><span class="line">            children:[],</span><br><span class="line">            parent:<span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理开始标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onStartTag</span>(<span class="params">tag,attrs</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">let</span> node = createNode(tag,attrs)</span><br><span class="line">        <span class="keyword">if</span>(!root)&#123;</span><br><span class="line">            root = node</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(currentParent)&#123;</span><br><span class="line">            node.parent = currentParent</span><br><span class="line">            currentParent.children.push(node)</span><br><span class="line">        &#125;</span><br><span class="line">        stack.push(node)</span><br><span class="line">        currentParent = node</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理文本标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onText</span>(<span class="params">text</span>)</span>&#123;</span><br><span class="line">        text = text.replace(<span class="regexp">/\s/g</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        text &amp;&amp; currentParent.children.push(&#123;</span><br><span class="line">            type:TEXT_TYPE,</span><br><span class="line">            text,</span><br><span class="line">            parent:currentParent</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理结束标签</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onCloseTag</span>(<span class="params">tag</span>)</span>&#123;</span><br><span class="line">        stack.pop()</span><br><span class="line">        currentParent = stack[stack.length -<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...省略其他代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后打印一下生成的ast语法树</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compilerToFunction</span>(<span class="params">template</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ast = parseHtml(template)</span><br><span class="line">    <span class="built_in">console</span>.log(ast)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231118171134199.png" alt="image-20231118171134199"></p>
<h2 id="代码生成的实现原理"><a href="#代码生成的实现原理" class="headerlink" title="代码生成的实现原理"></a>代码生成的实现原理</h2><p>现在我们已经得到了AST语法树，接下来我们就需要根据得到的AST语法树转化成一段cvs字符串</p>
<ul>
<li>_c 表示创建元素</li>
<li>_v 表示处理文本内容</li>
<li>_s 表示处理花括号包裹的文本</li>
</ul>
<p>这里提前吧 parseHtml 方法抽离出来放在 parse.js 文件中并导出</p>
<p>然后在 compilerToFunction 方法中添加 codegen 方法，根据 ast 语法树生成字符串代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;parseHtml,ELEMENT_TYPE&#125; <span class="keyword">from</span> <span class="string">&quot;./parse.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genProps</span>(<span class="params">attrs</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">``</span></span><br><span class="line">    attrs.forEach(<span class="function"><span class="params">attr</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// 遍历行内元素，变成 &#123;id:&quot;app&quot;,style:&#123;&quot;color&quot;:&quot;red&quot;,&quot;font-size&quot;:&quot;20px&quot;&#125;&#125; 这种效果</span></span><br><span class="line">        <span class="keyword">if</span>(attr.name === <span class="string">&quot;style&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> obj = &#123;&#125;</span><br><span class="line">            attr.value.split(<span class="string">&quot;;&quot;</span>).forEach(<span class="function"><span class="params">sItem</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> [key,value] = sItem.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">                obj[key] = value.trim()</span><br><span class="line">            &#125;)</span><br><span class="line">            attr.value = obj</span><br><span class="line">        &#125;</span><br><span class="line">        str += <span class="string">`<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(attr.name)&#125;</span>:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(attr.value)&#125;</span>,`</span></span><br><span class="line">    &#125;)</span><br><span class="line">    str = <span class="string">`&#123;<span class="subst">$&#123;str.slice(<span class="number">0</span>,-<span class="number">1</span>)&#125;</span>&#125;`</span></span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genChildren</span>(<span class="params">children</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> children.map(<span class="function"><span class="params">child</span>=&gt;</span>gen(child)).join(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配花括号中的的内容</span></span><br><span class="line"><span class="keyword">const</span> defaultTagRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen</span>(<span class="params">child</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 匹配到的是一个元素</span></span><br><span class="line">    <span class="keyword">if</span> (child.type === ELEMENT_TYPE) &#123;</span><br><span class="line">        <span class="keyword">return</span> codegen(child)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> text = child.text</span><br><span class="line">        <span class="comment">// 匹配到的是一个纯文本，不是用花括号包裹起来的文本时，会走下面的方法，返回一个 _v 函数，用于创建文本节点</span></span><br><span class="line">        <span class="keyword">if</span> (!defaultTagRE.test(text)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`_v(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(text)&#125;</span>)`</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果这个文本元素包含有花括号包裹的数据，就会走else方法</span></span><br><span class="line">            <span class="keyword">let</span> token = []</span><br><span class="line">            <span class="keyword">let</span> match;</span><br><span class="line">            <span class="keyword">let</span> lastIndex = <span class="number">0</span></span><br><span class="line">            <span class="comment">// 设置正则的lastIndex从0开始，也就是从文本的最前面开始进行匹配</span></span><br><span class="line">            defaultTagRE.lastIndex = <span class="number">0</span></span><br><span class="line">            <span class="comment">// exec方法会匹配到一个花括号数据时就会走一次循环，然后继续往后匹配剩余的花括号</span></span><br><span class="line">            <span class="comment">// 只到匹配结束，会返回null，然后退出循环</span></span><br><span class="line">            <span class="keyword">while</span> (match = defaultTagRE.exec(text)) &#123;</span><br><span class="line">                <span class="comment">// match.index返回的是当前匹配到的数据的下标</span></span><br><span class="line">                <span class="keyword">let</span> index = match.index</span><br><span class="line">                <span class="comment">// 如果出现匹配到的数据下标大于lastIndex下标，则表示如下情况</span></span><br><span class="line">                <span class="comment">// hello &#123;&#123; age &#125;&#125;,表示这个花括号前面还有文本，我们需要先把花括号前面的文本放在token中</span></span><br><span class="line">                <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">                    token.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex, index)))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 然后再吧花括号里面的变量放在token中，并且用_s函数接收这个变量</span></span><br><span class="line">                token.push(<span class="string">`_s(<span class="subst">$&#123;match[<span class="number">1</span>].trim()&#125;</span>)`</span>)</span><br><span class="line">                <span class="comment">// 更新lastIndex</span></span><br><span class="line">                lastIndex = index + match[<span class="number">0</span>].length</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当exec匹配完成后，出现lastIndex &lt; text.length的情况</span></span><br><span class="line">            <span class="comment">// 表示最后一个花括号后面还有普通文本，例如：&#123;&#123; age &#125;&#125; word,则我们需要吧后面的文本也放在token中</span></span><br><span class="line">            <span class="keyword">if</span> (lastIndex &lt; text.length) &#123;</span><br><span class="line">                token.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex)))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 最后返回一个 _v() 函数，里面的token使用+拼接返回</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">`_v(<span class="subst">$&#123;token.join(<span class="string">&quot;+&quot;</span>)&#125;</span>)`</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">codegen</span>(<span class="params">ast</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// _c(&quot;div&quot;,&#123;xxx:xxx,xxx:xxx&#125;)</span></span><br><span class="line">    <span class="comment">// 第一个参数是需要创建的元素，第二个是对应的属性</span></span><br><span class="line">    <span class="keyword">let</span> code = <span class="string">`_c(</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ast.tag)&#125;</span>,</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;ast.attrs.length ? genProps(ast.attrs) : <span class="string">&quot;null&quot;</span>&#125;</span>,</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;ast.children.length ? genChildren(ast.children) : <span class="string">&quot;null&quot;</span>&#125;</span></span></span><br><span class="line"><span class="string">    )`</span></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compilerToFunction</span>(<span class="params">template</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 解析DOM，转化成AST语法树</span></span><br><span class="line">    <span class="keyword">let</span> ast = parseHtml(template)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 根据AST语法树生成cvs字符串</span></span><br><span class="line">    <span class="keyword">let</span> cvs = codegen(ast)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(cvs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下图</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231119150538802.png" alt="image-20231119150538802"></p>
<h2 id="生成render函数"><a href="#生成render函数" class="headerlink" title="生成render函数"></a>生成render函数</h2><p>现在我们得到了一个字符串，并不是一个函数，下面就是要把这个字符串变成一个render函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compilerToFunction</span>(<span class="params">template</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 解析DOM，转化成AST语法树</span></span><br><span class="line">    <span class="keyword">let</span> ast = parseHtml(template)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 根据AST语法树生成cvs字符串</span></span><br><span class="line">    <span class="keyword">let</span> code = codegen(ast)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.根据字符串生成render方法</span></span><br><span class="line">    code = <span class="string">`with(this)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span></span><br><span class="line">    <span class="keyword">let</span> render = <span class="keyword">new</span> <span class="built_in">Function</span>(code)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(render.toString())</span><br><span class="line">    <span class="keyword">return</span> render</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 with 方法可以自动从 this 中读取变量值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> (object) &#123;</span><br><span class="line">  <span class="comment">// 在此作用域内可以直接使用 object 的属性和方法</span></span><br><span class="line">  <span class="comment">// 无需重复引用 object</span></span><br><span class="line">  <span class="comment">// 例如：</span></span><br><span class="line">  <span class="comment">// property1 // 相当于 object.property1</span></span><br><span class="line">  <span class="comment">// method1() // 相当于 object.method1()</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 注意：如果 object 中不存在某个属性或方法，会向上级作用域查找</span></span><br><span class="line">  <span class="comment">// 如果上级作用域也找不到，则会抛出 ReferenceError</span></span><br><span class="line">  <span class="comment">// 在严格模式下，不允许使用 with 语句</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> testObj = &#123;</span><br><span class="line">    name:<span class="string">&quot;Tome&quot;</span>,</span><br><span class="line">    age:<span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">with</span> (testObj) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name + age); <span class="comment">// 输出：Tome18</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在有了render函数后，将render 返回并添加到 $options 中</p>
<p>在 initMixin 方法中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initStatus&#125; <span class="keyword">from</span> <span class="string">&quot;./state.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;compilerToFunction&#125; <span class="keyword">from</span> <span class="string">&quot;./compile/index.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;mountComponent&#125; <span class="keyword">from</span> <span class="string">&quot;./lifecycle.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 给Vue原型添加一个初始化方法</span></span><br><span class="line">    Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">        vm.$options = options</span><br><span class="line">        <span class="comment">// 初始化状态</span></span><br><span class="line">        initStatus(vm)</span><br><span class="line">        <span class="comment">// 解析模板字符串</span></span><br><span class="line">        <span class="keyword">if</span>(vm.$options.el)&#123;</span><br><span class="line">            vm.$mount(vm.$options.el)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在原型链上添加$mount方法，用户获取页面模板</span></span><br><span class="line">    Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params">el</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> template;</span><br><span class="line">        <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">        <span class="comment">// 判断配置中是否已经存在template，如果没有，则根据el获取页面模板</span></span><br><span class="line">        <span class="keyword">if</span>(!opts.render)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!opts.template &amp;&amp; opts.el)&#123;</span><br><span class="line">                <span class="comment">// 拿到模板字符串</span></span><br><span class="line">                template = <span class="built_in">document</span>.querySelector(el).outerHTML</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(opts.template)&#123;</span><br><span class="line">                template = opts.template</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(template)&#123;</span><br><span class="line">                <span class="comment">// 这里拿到模板开始进行模板编译</span></span><br><span class="line">                opts.render = compilerToFunction(template)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有了render函数，开始对组件进行挂载</span></span><br><span class="line">        mountComponent(vm,el)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加 mountComponent 方法，新建一个文件，单独写个这个方法</p>
<p><code>lifecycle.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Vue 核心流程</span></span><br><span class="line"><span class="comment"> * 1.创造了响应式数据</span></span><br><span class="line"><span class="comment"> * 2.根据模板转化成ast语法树</span></span><br><span class="line"><span class="comment"> * 3.将ast语法树转化成render函数</span></span><br><span class="line"><span class="comment"> * 4.后续每次更新数据都只执行render函数，自动更新页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initLifeCycle</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载页面</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vm,el</span>)</span>&#123;</span><br><span class="line">    vm.$el = el</span><br><span class="line">    <span class="comment">// 1.调用render方法产生虚拟节点</span></span><br><span class="line">    vm._update(vm._render())</span><br><span class="line">    <span class="comment">// 2.根据虚拟DOM产生真实DOM</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.插入到el中去</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>initLifeCycle 方法需要接收一个 Vue，我们可以在 index.js 文件中添加调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initMixin&#125; <span class="keyword">from</span> <span class="string">&quot;./init&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;initLifeCycle&#125; <span class="keyword">from</span> <span class="string">&quot;./lifecycle.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">initLifeCycle(Vue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>

<h2 id="创建虚拟节点并更新视图"><a href="#创建虚拟节点并更新视图" class="headerlink" title="创建虚拟节点并更新视图"></a>创建虚拟节点并更新视图</h2><p>完善 lifecycle.js 文件的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Vue 核心流程</span></span><br><span class="line"><span class="comment"> * 1.创造了响应式数据</span></span><br><span class="line"><span class="comment"> * 2.根据模板转化成ast语法树</span></span><br><span class="line"><span class="comment"> * 3.将ast语法树转化成render函数</span></span><br><span class="line"><span class="comment"> * 4.后续每次更新数据都只执行render函数，自动更新页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;createElementVNode, createTextVNode&#125; <span class="keyword">from</span> <span class="string">&quot;./vdom/index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initLifeCycle</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// _c 的返回值就是 render 函数的返回值</span></span><br><span class="line">    Vue.prototype._c = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个虚拟DOM</span></span><br><span class="line">        <span class="keyword">return</span> createElementVNode(<span class="built_in">this</span>,...arguments)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _v 的返回值给 _c 使用</span></span><br><span class="line">    Vue.prototype._v = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTextVNode(<span class="built_in">this</span>,...arguments)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _s 的返回值给 _v 使用</span></span><br><span class="line">    Vue.prototype._s = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// _render函数的返回值会作为参数传递给 _update</span></span><br><span class="line">    Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.$options.render.call(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新视图方法</span></span><br><span class="line">    Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 获取当前的真实DOM</span></span><br><span class="line">        <span class="keyword">const</span> elm = <span class="built_in">document</span>.querySelector(<span class="built_in">this</span>.$options.el)</span><br><span class="line">        patch(elm,vnode)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVNode,newVNode</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否是一个真实元素,如果是真实DOM会返回1</span></span><br><span class="line">    <span class="keyword">const</span> isRealEle = oldVNode.nodeType;</span><br><span class="line">    <span class="keyword">if</span>(isRealEle)&#123;</span><br><span class="line">        <span class="comment">// 获取真实元素</span></span><br><span class="line">        <span class="keyword">const</span> elm = oldVNode</span><br><span class="line">        <span class="comment">// 获取真实元素的父元素</span></span><br><span class="line">        <span class="keyword">const</span> parentElm = elm.parentNode</span><br><span class="line">        <span class="comment">// 创建新的虚拟节点</span></span><br><span class="line">        <span class="keyword">let</span> newRealEl = createEle(newVNode)</span><br><span class="line">        <span class="comment">// 把新的虚拟节点插入到真实元素后面</span></span><br><span class="line">        parentElm.insertBefore(newRealEl,elm.nextSibling)</span><br><span class="line">        <span class="comment">// 然后删除之前的DOM</span></span><br><span class="line">        parentElm.removeChild(elm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEle</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">let</span> &#123;tag,data,children,text&#125; = vnode</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createElement(tag)</span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">prop</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(prop === <span class="string">&quot;style&quot;</span>)&#123;</span><br><span class="line">                <span class="built_in">Object</span>.keys(data.style).forEach(<span class="function"><span class="params">sty</span>=&gt;</span>&#123;</span><br><span class="line">                    vnode.el.style[sty] = data.style[sty]</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                vnode.el.setAttribute(prop,data[prop])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 递归处理子元素</span></span><br><span class="line">        children.forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123;</span><br><span class="line">            vnode.el.appendChild(createEle(child))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 当时一个文本元素是，tag是一个undefined，所以会走else</span></span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createTextNode(text)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode.el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载页面</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vm,el</span>)</span>&#123;</span><br><span class="line">    vm.$el = el</span><br><span class="line">    <span class="comment">// 1.调用render方法产生虚拟节点</span></span><br><span class="line">    <span class="comment">// 2.根据虚拟DOM产生真实DOM</span></span><br><span class="line">    <span class="comment">// 3.插入到el中去</span></span><br><span class="line">    vm._update(vm._render())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vnode/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建虚拟节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElementVNode</span>(<span class="params">vm,tag,prop,...children</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!prop)&#123;</span><br><span class="line">        prop = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> key = prop.key</span><br><span class="line">    <span class="keyword">if</span>(key)&#123;</span><br><span class="line">        <span class="keyword">delete</span> prop.key</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode(vm,tag,prop,key,children,<span class="literal">undefined</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建文本节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createTextVNode</span>(<span class="params">vm,text</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vnode(vm,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>,text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">vnode</span>(<span class="params">vm,tag,data,key,children,text</span>)</span>&#123;</span><br><span class="line"> children = children.filter(<span class="built_in">Boolean</span>)</span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line">     vm,</span><br><span class="line">     tag,</span><br><span class="line">     data,</span><br><span class="line">     key,</span><br><span class="line">     children,</span><br><span class="line">     text</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时我们的页面就可以正常显示数据了</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: red;font-size: 20px&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 15px;color: blue&quot;</span> <span class="attr">data-name</span> = <span class="string">&quot;123&quot;</span>&gt;</span></span><br><span class="line">            你好 &#123;&#123; name &#125;&#125; hello &#123;&#123; age &#125;&#125; word</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">            &#123;&#123; address.name &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> vm =  <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">        el:<span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="title">data</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span>&#123;</span></span><br><span class="line"><span class="javascript">                name:<span class="string">&quot;szx&quot;</span>,</span></span><br><span class="line">                age:18,</span><br><span class="line">                address:&#123;</span><br><span class="line">                    price:100,</span><br><span class="line"><span class="javascript">                    name:<span class="string">&quot;少林寺&quot;</span></span></span><br><span class="line">                &#125;,</span><br><span class="line"><span class="javascript">                hobby:[<span class="string">&#x27;each&#x27;</span>,<span class="string">&#x27;write&#x27;</span>,&#123;<span class="attr">a</span>:<span class="string">&quot;tome&quot;</span>&#125;]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231121232723039.png" alt="image-20231121232723039"></p>
<h2 id="实现依赖收集"><a href="#实现依赖收集" class="headerlink" title="实现依赖收集"></a>实现依赖收集</h2><p>现在初次渲染已经可以吧页面上绑定的数据渲染成我们定义的数据，但是当我们改变data数据时，页面不会发生更新，这里就要使用观察者模式，实现依赖收集。</p>
<p>读取某个属性时，会调用get方法，在get方法中收集watcher（观察者），然后当更新数据时，会调用set方法，通知当前这个属性绑定的观察者去完成更新视图的操作。</p>
<p>在get方法中收集watcher的同时，watcher也要收集这个属性（dept），要知道我当前的这个watcher下面有几个dept。</p>
<p>一个dept对应多个watcher，因为一个属性可能会在多个视图中使用</p>
<p>一个watcher对应多个dept，因为一个组件中会有多个属性</p>
<p>下面的代码实现逻辑</p>
<p>修改 <code>lifecycle.js</code> 文件中的 <code>mountComponent </code> 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 挂载页面</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vm,el</span>)</span>&#123;</span><br><span class="line">    vm.$el = el</span><br><span class="line">    <span class="comment">// 1.调用render方法产生虚拟节点</span></span><br><span class="line">    <span class="comment">// 2.根据虚拟DOM产生真实DOM</span></span><br><span class="line">    <span class="comment">// 3.插入到el中去</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> updateComponent = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">        vm._update(vm._render())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化渲染</span></span><br><span class="line">    <span class="keyword">new</span> Watcher(vm,updateComponent)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>新建 <code>observe/watcher.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm,fn</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id++ <span class="comment">// 唯一ID</span></span><br><span class="line">        <span class="built_in">this</span>.getter = fn <span class="comment">// 这里存放多个dep，一个Watcher对应多个deps</span></span><br><span class="line">        <span class="built_in">this</span>.depts = []</span><br><span class="line">        <span class="built_in">this</span>.deptSet = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">        <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 在调用getter之前，吧当前的Watcher实例放在Dep全局上</span></span><br><span class="line">        Dep.target = <span class="built_in">this</span></span><br><span class="line">        <span class="comment">// 调用getter就相当于调用的render函数，调用了render函数就会触发每个属性的get方法</span></span><br><span class="line">        <span class="built_in">this</span>.getter()</span><br><span class="line">        <span class="comment">//  调用完getter之后，把Dep.target置为null</span></span><br><span class="line">        Dep.target = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// watcher也要知道我自己下面有几个dept，所以这里要收集一下</span></span><br><span class="line">    <span class="function"><span class="title">addDep</span>(<span class="params">dep</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 判断dep的id不能重复</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">this</span>.deptSet.has(dep.id))&#123;</span><br><span class="line">            <span class="built_in">this</span>.depts.push(dep)</span><br><span class="line">            <span class="built_in">this</span>.deptSet.add(dep.id)</span><br><span class="line">            dep.addSubs(<span class="built_in">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新视图</span></span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Watcher</span><br></pre></td></tr></table></figure>

<p>对应的 <code>observe/dep.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id++</span><br><span class="line">        <span class="built_in">this</span>.subs = [] <span class="comment">// 存放当前这个属性对应的多个watcher</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">depend</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// Dep.target 就是当前的 watcher</span></span><br><span class="line">        <span class="comment">// 让watcher记住当前的dep</span></span><br><span class="line">        Dep.target.addDep(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当在watcher函数中添加好dep后会调用dep的addSubs方法，在dep中再保存一下watcher</span></span><br><span class="line">    <span class="function"><span class="title">addSubs</span>(<span class="params">watcher</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.push(watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新属性时更新这个属性对应的dep上的notify方法，会遍历这个dep对应的所有的watcher进行更新视图</span></span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.forEach(<span class="function"><span class="params">watcher</span> =&gt;</span> watcher.update())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Dep</span><br></pre></td></tr></table></figure>

<p>dep 就是被观察者，watcher 就是观察者，在属性的 get 和 set 方法中进行依赖收集和更新通知</p>
<p>修改 <code>observe/index.js </code>的 <code>defineReactive</code> 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">target,key,value</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 这里对当前的值进行判断，如果值还是一个对象，则递归继续进行深度劫持</span></span><br><span class="line">    observe(value)</span><br><span class="line">    <span class="comment">// Object.defineProperty 接收三个参数，第一个是对象，第二是要劫持的key，第三个是一个对象，里面有get和set方法</span></span><br><span class="line">    <span class="comment">// 当读取这个key是，会触发get方法，当设置key时，会触发set方法，并接收新值</span></span><br><span class="line">    <span class="keyword">let</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target,key,&#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 进行依赖收集，收集这个属性的观察者（watcher）</span></span><br><span class="line">            <span class="keyword">if</span>(Dep.target)&#123;</span><br><span class="line">                dep.depend()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(newValue === value) <span class="keyword">return</span></span><br><span class="line">            value = newValue</span><br><span class="line">            <span class="comment">// 通知观察者更新视图</span></span><br><span class="line">            dep.notify()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试视图更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm =  <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el:<span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            name:<span class="string">&quot;szx&quot;</span>,</span><br><span class="line">            age:<span class="number">18</span>,</span><br><span class="line">            address:&#123;</span><br><span class="line">                price:<span class="number">100</span>,</span><br><span class="line">                name:<span class="string">&quot;少林寺&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            hobby:[<span class="string">&#x27;each&#x27;</span>,<span class="string">&#x27;write&#x27;</span>,&#123;<span class="attr">a</span>:<span class="string">&quot;tome&quot;</span>&#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAge</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    vm.name = <span class="string">&quot;李四&quot;</span></span><br><span class="line">    vm.age = <span class="number">20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231122232155435.png" alt="image-20231122232155435"></p>
<p>我们发现，点击更新按钮后视图确实发生了更新。但是控制台打印了两次更新。这是因为我们在 addAge 方法中对两个属性进行了更改，所以触发了两次更新。下面我们来解决这个问题，让他只触发一次更新</p>
<h2 id="实现异步更新"><a href="#实现异步更新" class="headerlink" title="实现异步更新"></a>实现异步更新</h2><p>修改 Watch 中的 update 方法，同时新增一个 run 方法，专门用于更新视图操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm,fn</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id++ <span class="comment">// 唯一ID</span></span><br><span class="line">        <span class="built_in">this</span>.getter = fn <span class="comment">// 这里存放多个dep，一个Watcher对应多个deps</span></span><br><span class="line">        <span class="built_in">this</span>.depts = []</span><br><span class="line">        <span class="built_in">this</span>.deptSet = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">        <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 在调用getter之前，吧当前的Watcher实例放在Dep全局上</span></span><br><span class="line">        Dep.target = <span class="built_in">this</span></span><br><span class="line">        <span class="comment">// 调用getter就相当于调用的render函数，调用了render函数就会触发每个属性的get方法</span></span><br><span class="line">        <span class="built_in">this</span>.getter()</span><br><span class="line">        <span class="comment">//  调用完getter之后，把Dep.target置为null</span></span><br><span class="line">        Dep.target = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// watcher也要知道我自己下面有几个dept，所以这里要收集一下</span></span><br><span class="line">    <span class="function"><span class="title">addDep</span>(<span class="params">dep</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 判断dep的id不能重复</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">this</span>.deptSet.has(dep.id))&#123;</span><br><span class="line">            <span class="built_in">this</span>.depts.push(dep)</span><br><span class="line">            <span class="built_in">this</span>.deptSet.add(dep.id)</span><br><span class="line">            dep.addSubs(<span class="built_in">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新视图</span></span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 实现异步更新，将多个watcher放在一个队列中，然后写一个异步任务实现异步更新</span></span><br><span class="line">        queueWatcher(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="function"><span class="title">run</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;更新视图&#x27;</span>)</span><br><span class="line">        <span class="built_in">this</span>.getter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> queue = []</span><br><span class="line"><span class="keyword">let</span> watchObj = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> padding = <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueWatcher</span>(<span class="params">watcher</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!watchObj[watcher.id])&#123;</span><br><span class="line">        watchObj[watcher.id] = <span class="literal">true</span></span><br><span class="line">        queue.push(watcher)</span><br><span class="line">        <span class="comment">// 执行多次进行一个防抖</span></span><br><span class="line">        <span class="keyword">if</span>(!padding)&#123;</span><br><span class="line">            <span class="comment">// 等待同步任务执行完再执行异步更新</span></span><br><span class="line">            nextTick(flushSchedulerQueue,<span class="number">0</span>)</span><br><span class="line">            padding = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSchedulerQueue</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> flushQueue = queue.slice(<span class="number">0</span>)</span><br><span class="line">    queue = []</span><br><span class="line">    watchObj = &#123;&#125;</span><br><span class="line">    padding = <span class="literal">false</span></span><br><span class="line">    flushQueue.forEach(<span class="function"><span class="params">cb</span>=&gt;</span>cb.run())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> callbacks = []</span><br><span class="line"><span class="keyword">let</span> waiting = <span class="literal">false</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">cb</span>)</span>&#123;</span><br><span class="line">    callbacks.push(cb)</span><br><span class="line">    <span class="keyword">if</span>(!waiting)&#123;</span><br><span class="line">        <span class="comment">// setTimeout(()=&gt;&#123;</span></span><br><span class="line">        <span class="comment">//     // 依次执行回调</span></span><br><span class="line">        <span class="comment">//     flushCallback()</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 Promise.resolve进行异步更新</span></span><br><span class="line">        <span class="built_in">Promise</span>.resolve().then(flushCallback)</span><br><span class="line">        waiting = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallback</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cbs = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">    callbacks = []</span><br><span class="line">    waiting = <span class="literal">false</span></span><br><span class="line">    cbs.forEach(<span class="function"><span class="params">cb</span>=&gt;</span>cb())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Watcher</span><br></pre></td></tr></table></figure>

<p>在 <code>src/index.js</code> 中挂载全局的 $nexitTick 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initMixin&#125; <span class="keyword">from</span> <span class="string">&quot;./init&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;initLifeCycle&#125; <span class="keyword">from</span> <span class="string">&quot;./lifecycle.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;nextTick&#125; <span class="keyword">from</span> <span class="string">&quot;./observe/watcher.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.prototype.$nextTick = nextTick</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">initLifeCycle(Vue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>

<p>页面使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAge</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    vm.name = <span class="string">&quot;李四&quot;</span></span><br><span class="line">    vm.age = <span class="number">20</span></span><br><span class="line">    vm.$nextTick(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">document</span>.querySelector(<span class="string">&quot;#name&quot;</span>).innerText)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击更新按钮执行 addAge 方法，可以在控制台看到只触发了一个更新视图，并且获取的页面也是更新后的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231123223906880.png" alt="image-20231123223906880"></p>
<h2 id="实现mixin核心功能"><a href="#实现mixin核心功能" class="headerlink" title="实现mixin核心功能"></a>实现mixin核心功能</h2><p>mixin的核心是合并对象，将Vue.mixin中的对象和在Vue中定义的属性进行合并，然后再初始化状态前后调用不同的Hook即可</p>
<p>首先在 index.js 中添加方法调用</p>
<p><code>index.js</code> 文件增加 initGlobalApi，传入 Vue</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import &#123;initMixin&#125; from &quot;./init&quot;;</span><br><span class="line">import &#123;initLifeCycle&#125; from &quot;./lifecycle.js&quot;;</span><br><span class="line">import &#123;nextTick&#125; from &quot;./observe/watcher.js&quot;;</span><br><span class="line"><span class="addition">+ import &#123;initGlobalApi&#125; from &quot;./globalApi.js&quot;;</span></span><br><span class="line"></span><br><span class="line">function Vue(options)&#123;</span><br><span class="line">    this._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.prototype.$nextTick = nextTick</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">initLifeCycle(Vue)</span><br><span class="line"><span class="addition">+ initGlobalApi(Vue)</span></span><br><span class="line"></span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>

<p><code>globalApi.js</code> 内容如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;mergeOptions&#125; <span class="keyword">from</span> <span class="string">&quot;./utils.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initGlobalApi</span>(<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 添加一个静态方法 mixin</span></span><br><span class="line">    Vue.options = &#123;&#125;</span><br><span class="line">    Vue.mixin = <span class="function"><span class="keyword">function</span> (<span class="params">mixin</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.options = mergeOptions(<span class="built_in">this</span>.options, mixin)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils.js</code> 中实现 mergeOptions 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一些策略，例如 created，beforeCreated 等，不需要写大量的if判断</span></span><br><span class="line"><span class="keyword">const</span> strats = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> LIFECYCLE = [</span><br><span class="line">    <span class="string">&quot;beforeCreated&quot;</span>,</span><br><span class="line">    <span class="string">&quot;created&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">LIFECYCLE.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    strats[key] = <span class="function"><span class="keyword">function</span> (<span class="params">p, c</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p) &#123;</span><br><span class="line">                <span class="keyword">return</span> p.concat(c)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> [c]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 合并属性的方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params">parent, child</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;&#125;</span><br><span class="line">    <span class="comment">// 先获取父亲的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">        mergeField(key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> child) &#123;</span><br><span class="line">        <span class="comment">// 如果父亲里面没有这个子属性，在进行合并子的</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 示例：父亲：&#123;a:1&#125; 儿子:&#123;a:2&#125;</span></span><br><span class="line"><span class="comment">         *      儿子中也有父亲的属性a，所以不会走儿子中的合并方法，但是在取值的时候，优先取的是儿子身上的属性值</span></span><br><span class="line"><span class="comment">         *      所以合并到一个对象中时，儿子会覆盖父亲</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!parent.hasOwnProperty(key)) &#123;</span><br><span class="line">            mergeField(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strats[key]) &#123;</span><br><span class="line">            <span class="comment">// &#123;created:fn&#125; &#123;&#125;</span></span><br><span class="line">            <span class="comment">// 合并声明周期上的方法，例如：beforeCreated,created</span></span><br><span class="line">            options[key] = strats[key](parent[key], child[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 先拿到儿子的值</span></span><br><span class="line">            options[key] = child[key] || parent[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 init.js 中进行属性合并和Hook调用</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">import &#123;initStatus&#125; from &quot;./state.js&quot;;</span><br><span class="line">import &#123;compilerToFunction&#125; from &quot;./compile/index.js&quot;;</span><br><span class="line">import &#123;mountComponent&#125; from &quot;./lifecycle.js&quot;;</span><br><span class="line"><span class="addition">+import &#123;mergeOptions&#125; from &quot;./utils.js&quot;;</span></span><br><span class="line"></span><br><span class="line">export function initMixin(Vue)&#123;</span><br><span class="line">    // 给Vue原型添加一个初始化方法</span><br><span class="line">    Vue.prototype._init = function (options)&#123;</span><br><span class="line">        const vm = this</span><br><span class="line"><span class="addition">+        // this.constructor就是当前的大Vue，获取的是Vue上的静态属性</span></span><br><span class="line"><span class="addition">+        // this.constructor.options 拿到的就是mixin合并后的数据</span></span><br><span class="line"><span class="addition">+        // 然后再把用户写的options和mixin中的进行再次合并</span></span><br><span class="line"><span class="addition">+        vm.$options = mergeOptions(this.constructor.options,options)</span></span><br><span class="line"><span class="addition">+        // 初始化之前调用beforeCreated</span></span><br><span class="line"><span class="addition">+        callHook(vm,&quot;beforeCreated&quot;)</span></span><br><span class="line"><span class="addition">+        // 初始化状态</span></span><br><span class="line"><span class="addition">+        initStatus(vm)</span></span><br><span class="line"><span class="addition">+        // 初始化之后调用created</span></span><br><span class="line"><span class="addition">+        callHook(vm,&quot;created&quot;)</span></span><br><span class="line">        // 解析模板字符串</span><br><span class="line">        if(vm.$options.el)&#123;</span><br><span class="line">            vm.$mount(vm.$options.el)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 在原型链上添加$mount方法，用户获取页面模板</span><br><span class="line">    Vue.prototype.$mount = function (el)&#123;</span><br><span class="line">        let template;</span><br><span class="line">        const vm = this</span><br><span class="line">        el = document.querySelector(el)</span><br><span class="line">        const opts = vm.$options</span><br><span class="line">        // 判断配置中是否已经存在template，如果没有，则根据el获取页面模板</span><br><span class="line">        if(!opts.render)&#123;</span><br><span class="line">            if(!opts.template &amp;&amp; opts.el)&#123;</span><br><span class="line">                // 拿到模板字符串</span><br><span class="line">                template = el.outerHTML</span><br><span class="line">            &#125;</span><br><span class="line">            if(opts.template)&#123;</span><br><span class="line">                template = opts.template</span><br><span class="line">            &#125;</span><br><span class="line">            if(template)&#123;</span><br><span class="line">                // 这里拿到模板开始进行模板编译</span><br><span class="line">                opts.render = compilerToFunction(template)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 有了render函数，开始对组件进行挂载</span><br><span class="line">        mountComponent(vm,el)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+function callHook(vm,hook)&#123;</span></span><br><span class="line"><span class="addition">+    // 拿到用户传入的钩子函数</span></span><br><span class="line"><span class="addition">+    const handlers = vm.$options[hook]</span></span><br><span class="line"><span class="addition">+    if(handlers)&#123;</span></span><br><span class="line"><span class="addition">+        // 遍历钩子函数，执行钩子函数</span></span><br><span class="line"><span class="addition">+        for(let i=0;i&lt;handlers.length;i++)&#123;</span></span><br><span class="line"><span class="addition">+            handlers[i].call(vm)</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试 Vue.mixin</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue内部会把minix进行合并，如果有两个created会合并成一个created数组，里面有两个方法，然后依次执行</span></span><br><span class="line">Vue.mixin(&#123;</span><br><span class="line">    <span class="function"><span class="title">beforeCreated</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;beforeCreated&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name,<span class="string">&quot;--mixin&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">&quot;szx&quot;</span>,</span><br><span class="line">            age: <span class="number">18</span>,</span><br><span class="line">            address: &#123;</span><br><span class="line">                price: <span class="number">100</span>,</span><br><span class="line">                name: <span class="string">&quot;少林寺&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            hobby: [<span class="string">&#x27;each&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, &#123;<span class="attr">a</span>: <span class="string">&quot;tome&quot;</span>&#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name,<span class="string">&quot;--vue&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>查看控制台打印</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125151910158.png" alt="image-20231125151910158"></p>
<h2 id="实现数组更新"><a href="#实现数组更新" class="headerlink" title="实现数组更新"></a>实现数组更新</h2><p>我们之前给每一个属性都加了一个dep，实现依赖收集，但是如果这个属性值是一个对象类型的话，当我们不改变这个属性的引用地址，只是改变对象属性值，比如给数组push一个数据，不会改变原来的引用地址。这样的话页面就无法实现更新。</p>
<p>我们可以判断一下，当属性值是一个对象类型的时候，给这个对象本身也添加一个dep，当读取这个属性值的时候，进行一下依赖收集，如果是一个数组的话，当调用完push等方法时，在我们重写的方法哪里再执行一个更新就可以了。</p>
<p>下面是代码实现</p>
<p>修改 <code>observe/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;newArrayProperty&#125; <span class="keyword">from</span> <span class="string">&quot;./array.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 给对象类型的数据加一个 Dep 实例</span></span><br><span class="line">+        <span class="built_in">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">        <span class="comment">// 定义一个__ob__，值是this，不可枚举</span></span><br><span class="line">        <span class="comment">// 给数据加了一个标识，表示这个数据是一个已经被响应式了的</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data,<span class="string">&quot;__ob__&quot;</span>,&#123;</span><br><span class="line">            <span class="comment">// 定义这个属性值是当前的实例</span></span><br><span class="line">            value:<span class="built_in">this</span>,</span><br><span class="line">            <span class="comment">// 定义__ob__不能被遍历，否则会引起死循环</span></span><br><span class="line">            <span class="comment">// 原因：在walk方法中会递归遍历对象中的每一个属性进行响应式处理，因为__ob__表示的当前对象的实例</span></span><br><span class="line">            <span class="comment">// 实例本身又包含__ob__，这样就会导致递归无限往里面找，就造成了死循环，</span></span><br><span class="line">            <span class="comment">// 所以这里要设置成 enumerable：false，不能遍历 __ob__ 这个属性</span></span><br><span class="line">            enumerable:<span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 如果data中的某个值定义的是一个数组，则对数组进行劫持，进行响应式处理</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(data))&#123;</span><br><span class="line">            data.__proto__ = newArrayProperty</span><br><span class="line">            <span class="built_in">this</span>.observeArray(data)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.walk(data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">walk</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 循环对象中的每一个属性进行劫持</span></span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">            defineReactive(data,key,data[key])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对数组进行响应式处理</span></span><br><span class="line">    <span class="function"><span class="title">observeArray</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        data.forEach(<span class="function"><span class="params">item</span>=&gt;</span>observe(item))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+<span class="function"><span class="keyword">function</span> <span class="title">dependArr</span>(<span class="params">array</span>)</span>&#123;</span><br><span class="line">+    array.forEach(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">+        <span class="comment">// 数组中的普通类型的值不会有__ob__</span></span><br><span class="line">+        item.__ob__ &amp;&amp; item.__ob__.dep.depend()</span><br><span class="line">+        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(item))&#123;</span><br><span class="line">+            dependArr(item)</span><br><span class="line">+        &#125;</span><br><span class="line">+    &#125;)</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">target,key,value</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 这里对当前的值进行判断，如果值还是一个对象，则递归继续进行深度劫持</span></span><br><span class="line">+    <span class="keyword">const</span> childOb = observe(value)</span><br><span class="line">    <span class="comment">// Object.defineProperty 接收三个参数，第一个是对象，第二是要劫持的key，第三个是一个对象，里面有get和set方法</span></span><br><span class="line">    <span class="comment">// 当读取这个key是，会触发get方法，当设置key时，会触发set方法，并接收新值</span></span><br><span class="line">    <span class="keyword">let</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target,key,&#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 进行依赖收集，收集这个属性的观察者（watcher）</span></span><br><span class="line">            <span class="keyword">if</span>(Dep.target)&#123;</span><br><span class="line">                dep.depend()</span><br><span class="line">+                <span class="keyword">if</span>(childOb)&#123;</span><br><span class="line">+                    childOb.dep.depend()</span><br><span class="line">+                    <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(value))&#123;</span><br><span class="line">+                        dependArr(value)</span><br><span class="line">+                    &#125;</span><br><span class="line">+                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(newValue === value) <span class="keyword">return</span></span><br><span class="line">            value = newValue</span><br><span class="line">            <span class="comment">// 通知观察者更新视图</span></span><br><span class="line">            dep.notify()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 对这个对象进行劫持，需要判断一下是否是一个对象，如果不是一个对象不能进行劫持</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data !== <span class="string">&quot;object&quot;</span> || data === <span class="literal">null</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 如果这个对象已经被代理过了，则直接返回当前示例</span></span><br><span class="line">    <span class="keyword">if</span>(data.__ob__)&#123;</span><br><span class="line">        <span class="keyword">return</span> data.__ob__</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observer(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">&quot;szx&quot;</span>,</span><br><span class="line">            age: <span class="number">18</span>,</span><br><span class="line">            address: &#123;</span><br><span class="line">                price: <span class="number">100</span>,</span><br><span class="line">                name: <span class="string">&quot;少林寺&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            hobby: [<span class="string">&quot;爬山&quot;</span>,<span class="string">&quot;玩游戏&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name,<span class="string">&quot;--vue&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    vm.hobby.push(<span class="string">&quot;吃&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125163325570.png" alt="image-20231125163325570"></p>
<p>点击后页面会自动更新，并且控制台打印了一次更新视图</p>
<h2 id="实现计算属性"><a href="#实现计算属性" class="headerlink" title="实现计算属性"></a>实现计算属性</h2><p>首先添加computed计算属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">&quot;szx&quot;</span>,</span><br><span class="line">            age: <span class="number">18</span>,</span><br><span class="line">            address: &#123;</span><br><span class="line">                price: <span class="number">100</span>,</span><br><span class="line">                name: <span class="string">&quot;少林寺&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            hobby: [<span class="string">&quot;爬山&quot;</span>,<span class="string">&quot;玩游戏&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name,<span class="string">&quot;--vue&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    computed:&#123;</span><br><span class="line">        <span class="function"><span class="title">fullname</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;调用计算属性&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.name + <span class="built_in">this</span>.age</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>找到 state.js 文件，添加如下代码，添加针对 computed 属性的处理逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;observe&#125; <span class="keyword">from</span> <span class="string">&quot;./observe/index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initStatus</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// vm是Vue实例</span></span><br><span class="line">    <span class="keyword">const</span> opt = vm.$options</span><br><span class="line">    <span class="comment">// 处理data属性</span></span><br><span class="line">    <span class="keyword">if</span>(opt.data)&#123;</span><br><span class="line">        initData(vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理computed计算属性</span></span><br><span class="line">    <span class="keyword">if</span>(opt.computed)&#123;</span><br><span class="line">        initComputed(vm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略原有代码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initComputed</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> computed = vm.$options.computed</span><br><span class="line">    <span class="comment">// 遍历计算属性中的每一个方法，将方法名作为一个key</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(computed).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// 劫持每一个属性，将key作为一个新的属性，方法的返回值作为这个属性值添加到vm上</span></span><br><span class="line">        defineComputed(vm,key,computed)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineComputed</span>(<span class="params">target,key,computed</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> getter = <span class="keyword">typeof</span> computed[key] === <span class="string">&quot;function&quot;</span> ? computed[key] : computed[key].get</span><br><span class="line">    <span class="keyword">let</span> setter = computed[key].set || (<span class="function">()=&gt;</span>&#123;&#125;)</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target,key,&#123;</span><br><span class="line">        get:getter,</span><br><span class="line">        set:setter</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们就可以在页面上使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;&#123;fullname&#125;&#125; &#123;&#123;fullname&#125;&#125; &#123;&#123;fullname&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125204444268.png" alt="image-20231125204444268"></p>
<p>但是会发现执行了三次计算属性的方法，在真正的vue中，计算属性是带有缓存的。我们可以定义一个标识，当执行完一次计算属性方法后，把这个标识改掉，下次再次调用计算属性时，从缓存获取</p>
<p>修改 initComputed 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initComputed</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> computed = vm.$options.computed</span><br><span class="line">    <span class="keyword">const</span> computedWatchers = vm._computedWatchers = &#123;&#125;</span><br><span class="line">    <span class="comment">// 遍历计算属性中的每一个方法，将方法名作为一个key</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(computed).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> getter = <span class="keyword">typeof</span> computed[key] === <span class="string">&quot;function&quot;</span> ? computed[key] : computed[key].get</span><br><span class="line">        <span class="comment">// 给每个计算属性绑定一个watcher，并且标记状态是lazy</span></span><br><span class="line">        <span class="comment">// 然后再watcher中判断这个状态，决定是否立即执行一次和是否返回缓存的数据</span></span><br><span class="line">        computedWatchers[key] = <span class="keyword">new</span> Watcher(vm,getter,&#123;<span class="attr">lazy</span>:<span class="literal">true</span>&#125;)</span><br><span class="line">        <span class="comment">// 劫持每一个属性，将key作为一个新的属性，方法的返回值作为这个属性值添加到vm上</span></span><br><span class="line">        defineComputed(vm,key,computed)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineComputed</span>(<span class="params">target,key,computed</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> setter = computed[key].set || (<span class="function">()=&gt;</span>&#123;&#125;)</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target,key,&#123;</span><br><span class="line">        get:createComputedGetter(key),</span><br><span class="line">        set:setter</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收集计算属性watcher</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> watcher = <span class="built_in">this</span>._computedWatchers[key]</span><br><span class="line">        <span class="comment">// 这里的dirty默认是true</span></span><br><span class="line">        <span class="keyword">if</span>(watcher.dirty)&#123;</span><br><span class="line">            <span class="comment">// 调用完watcher上的evaluate方法后，会吧这个dirty改成false</span></span><br><span class="line">            <span class="comment">// 同时吧计算属性的方法返回值赋值给当前watcher的value属性上</span></span><br><span class="line">            watcher.evaluate()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这样在多次调用计算属性的get方法时，只会触发一次真正的get方法</span></span><br><span class="line">        <span class="keyword">return</span> watcher.value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Watcher.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm,fn,options = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id++ <span class="comment">// 唯一ID</span></span><br><span class="line">        <span class="built_in">this</span>.vm = vm</span><br><span class="line">        <span class="built_in">this</span>.getter = fn <span class="comment">// 这里存放多个dep，一个Watcher对应多个deps</span></span><br><span class="line">        <span class="built_in">this</span>.depts = []</span><br><span class="line">        <span class="built_in">this</span>.deptSet = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">        <span class="built_in">this</span>.lazy = options.lazy</span><br><span class="line">        <span class="comment">// 用作计算属性的缓存，标记是否需要重新计算</span></span><br><span class="line">        <span class="built_in">this</span>.dirty = <span class="built_in">this</span>.lazy</span><br><span class="line">        <span class="comment">// 由于watcher会默认执行一次get，会渲染一次页面，但是计算属性不需要一上来就执行渲染</span></span><br><span class="line">        <span class="comment">// 所以这里判断，如果dirty为true，则不执行get，只有当dirty为false的时候才执行get，渲染页面</span></span><br><span class="line">        <span class="built_in">this</span>.dirty ? <span class="literal">undefined</span> : <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">evaluate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 在这个方法中调用get方法，会去执行计算属性的方法</span></span><br><span class="line">        <span class="comment">// 这时get中的this指向的计算属性watcher，同时会这这个计算属性watch加入栈中</span></span><br><span class="line">        <span class="built_in">this</span>.value = <span class="built_in">this</span>.get()</span><br><span class="line">        <span class="built_in">this</span>.dirty = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 在调用getter之前，吧当前的Watcher实例放在Dep全局上</span></span><br><span class="line">        <span class="comment">// Dep.target = this</span></span><br><span class="line">        pushWatcher(<span class="built_in">this</span>)</span><br><span class="line">        <span class="comment">// 调用getter就相当于调用的render函数，调用了render函数就会触发每个属性的get方法</span></span><br><span class="line">        <span class="keyword">let</span> value = <span class="built_in">this</span>.getter.call(<span class="built_in">this</span>.vm)</span><br><span class="line">        <span class="comment">//  调用完getter之后，把Dep.target置为null</span></span><br><span class="line">        <span class="comment">// Dep.target = null</span></span><br><span class="line">        popWatcher()</span><br><span class="line">        <span class="comment">//  把计算属性的值赋值给value</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> stack = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushWatcher</span>(<span class="params">watcher</span>)</span>&#123;</span><br><span class="line">    stack.push(watcher)</span><br><span class="line">    Dep.target = watcher</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">popWatcher</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    stack.pop()</span><br><span class="line">    Dep.target = stack[stack.length-<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Watcher</span><br></pre></td></tr></table></figure>

<p>上面我们给每一个计算属性绑定了一个计算watcher，并且添加了一个lazy标记，然后再watcher中吧dirty的值默认等于这个标记，同时添加一个evaluate方法，专门处理计算属性的返回值</p>
<p>现在我们页面上使用三次计算属性，但是只会执行一次</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125211339957.png" alt="image-20231125211339957"></p>
<p>现在当我们更改依赖的属性时，页面不会发生变化</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125211449274.png" alt="image-20231125211449274"></p>
<p>这是为什么呢？这是因为目前计算属性中依赖的属性中的dep绑定是的计算Watcher，并不是渲染Watcher，当我们改变了计算属性依赖值时，通知的只是计算属性Watcher，所以不会引起页面的渲染。这就需要同时去触发渲染Watcher。</p>
<p>在 <code>createComputedGetter</code> 方法中增加一个判断，判断Dep.target是否还有值，有值就表示计算属性的watcher出栈后，还有一个渲染watcher，调用watcher中的depend方法，获取计算属性watcher所有的属性，也就是每一个dep，遍历这些dep，去同时吧渲染watcher添加到这些计算属性所依赖的dep的订阅者中，这样当这些依赖的值发生变化时，就会通知到渲染watcher，从而去更新页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收集计算属性watcher</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> watcher = <span class="built_in">this</span>._computedWatchers[key]</span><br><span class="line">        <span class="comment">// 这里的dirty默认是true</span></span><br><span class="line">        <span class="keyword">if</span>(watcher.dirty)&#123;</span><br><span class="line">            <span class="comment">// 调用完watcher上的evaluate方法后，会吧这个dirty改成false</span></span><br><span class="line">            <span class="comment">// 同时吧计算属性的方法返回值赋值给当前watcher的value属性上</span></span><br><span class="line">            watcher.evaluate()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断Dep.target是否还有值，有值就表示计算属性的watcher出栈后，还有一个渲染watcher</span></span><br><span class="line">        <span class="keyword">if</span>(Dep.target)&#123;</span><br><span class="line">            <span class="comment">// 调用watcher中的depend方法，获取计算属性watcher所有的属性，也就是每一个dep</span></span><br><span class="line">            <span class="comment">// 遍历这些dep，去同时吧渲染watcher添加到这些计算属性所依赖的dep的订阅者中</span></span><br><span class="line">            <span class="comment">// 这样当这些依赖的值发生变化时，就会通知到渲染watcher，从而去更新页面</span></span><br><span class="line">            watcher.depend()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这样在多次调用计算属性的get方法时，只会触发一次真正的get方法</span></span><br><span class="line">        <span class="keyword">return</span> watcher.value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再 Watcher 中添加 depend 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">vm,fn,options = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id++ <span class="comment">// 唯一ID</span></span><br><span class="line">        <span class="built_in">this</span>.vm = vm</span><br><span class="line">        <span class="built_in">this</span>.getter = fn <span class="comment">// 这里存放多个dep，一个Watcher对应多个deps</span></span><br><span class="line">        <span class="built_in">this</span>.depts = []</span><br><span class="line">        <span class="built_in">this</span>.deptSet = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">        <span class="built_in">this</span>.lazy = options.lazy</span><br><span class="line">        <span class="comment">// 用作计算属性的缓存，标记是否需要重新计算</span></span><br><span class="line">        <span class="built_in">this</span>.dirty = <span class="built_in">this</span>.lazy</span><br><span class="line">        <span class="comment">// 由于watcher会默认执行一次get，会渲染一次页面，但是计算属性不需要一上来就执行渲染</span></span><br><span class="line">        <span class="comment">// 所以这里判断，如果dirty为true，则不执行get，只有当dirty为false的时候才执行get，渲染页面</span></span><br><span class="line">        <span class="built_in">this</span>.dirty ? <span class="literal">undefined</span> : <span class="built_in">this</span>.get()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">evaluate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 在这个方法中调用get方法，会去执行计算属性的方法</span></span><br><span class="line">        <span class="comment">// 这时get中的this指向的计算属性watcher，同时会这这个计算属性watch加入栈中</span></span><br><span class="line">        <span class="built_in">this</span>.value = <span class="built_in">this</span>.get()</span><br><span class="line">        <span class="built_in">this</span>.dirty = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">depend</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> i = <span class="built_in">this</span>.depts.length</span><br><span class="line">        <span class="keyword">while</span> (i--)&#123;</span><br><span class="line">            <span class="built_in">this</span>.depts[i].depend()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Watcher</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231125221305019.png" alt="image-20231125221305019"></p>
<p>现在当修改了计算属性所依赖的属性值时，会更新视图。然后重新调用一次计算属性</p>
<h2 id="实现watch监听"><a href="#实现watch监听" class="headerlink" title="实现watch监听"></a>实现watch监听</h2><p>watch可以理解为一个自定义的观察者watcher，当观察的属性发生变化时，执行对应的回调即可</p>
<p>首先新增一个全局 $watch</p>
<p><code>src/index.js</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &#123;initMixin&#125; from &quot;./init&quot;;</span><br><span class="line">import &#123;initLifeCycle&#125; from &quot;./lifecycle.js&quot;;</span><br><span class="line">import Watcher, &#123;nextTick&#125; from &quot;./observe/watcher.js&quot;;</span><br><span class="line">import &#123;initGlobalApi&#125; from &quot;./globalApi.js&quot;;</span><br><span class="line"></span><br><span class="line">function Vue(options) &#123;</span><br><span class="line">    this._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.prototype.$nextTick = nextTick</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">initLifeCycle(Vue)</span><br><span class="line">initGlobalApi(Vue)</span><br><span class="line"></span><br><span class="line"><span class="addition">+ Vue.prototype.$watch = function (expOrFn, cb) &#123;</span></span><br><span class="line"><span class="addition">+     new Watcher(this, expOrFn, &#123;user:true&#125;,cb)</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure>

<p>然后再初始化状态，增加一个初始化watch的方法</p>
<p><code>src/state.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;observe&#125; <span class="keyword">from</span> <span class="string">&quot;./observe/index.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Watcher <span class="keyword">from</span> <span class="string">&quot;./observe/watcher.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> Dep <span class="keyword">from</span> <span class="string">&quot;./observe/dep.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initStatus</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// vm是Vue实例</span></span><br><span class="line">    <span class="keyword">const</span> opt = vm.$options</span><br><span class="line">    <span class="comment">// 处理data属性</span></span><br><span class="line">    <span class="keyword">if</span>(opt.data)&#123;</span><br><span class="line">        initData(vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理computed计算属性</span></span><br><span class="line">    <span class="keyword">if</span>(opt.computed)&#123;</span><br><span class="line">        initComputed(vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理watch方法</span></span><br><span class="line">    <span class="keyword">if</span>(opt.watch)&#123;</span><br><span class="line">        initWatch(vm)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWatch</span>(<span class="params">vm</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 从vm中获取用户定义的watch对象</span></span><br><span class="line">    <span class="keyword">let</span> watch = vm.$options.watch</span><br><span class="line">    <span class="comment">// 遍历这个对象获取每一个属性名和属性值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> watchKey <span class="keyword">in</span> watch) &#123;</span><br><span class="line">        <span class="comment">// 属性值</span></span><br><span class="line">        <span class="keyword">let</span> handle = watch[watchKey]</span><br><span class="line">        <span class="comment">// 属性值可能是一个数组</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         age:[</span></span><br><span class="line"><span class="comment">         (newVal,oldVal)=&gt;&#123;</span></span><br><span class="line"><span class="comment">                    console.log(newVal,oldVal)</span></span><br><span class="line"><span class="comment">                &#125;,</span></span><br><span class="line"><span class="comment">         (newVal,oldVal)=&gt;&#123;</span></span><br><span class="line"><span class="comment">                    console.log(newVal,oldVal)</span></span><br><span class="line"><span class="comment">                &#125;,</span></span><br><span class="line"><span class="comment">         ]</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(handle))&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> handleElement <span class="keyword">of</span> handle) &#123;</span><br><span class="line">                createWatcher(vm,watchKey,handleElement)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 如果不是数组可能是一个字符串或者是一个回调</span></span><br><span class="line">            <span class="comment">// 这里先不考虑是字符串的情况</span></span><br><span class="line">            createWatcher(vm,watchKey,handle)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWatcher</span>(<span class="params">vm,keyOrFn,handle</span>)</span>&#123;</span><br><span class="line">  vm.$watch(keyOrFn,handle)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改Watcher类，当所监听的值发生变化时触发回调</p>
<p><code>src/observe/watcher.js</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import Dep from &quot;./dep.js&quot;;</span><br><span class="line"></span><br><span class="line">let id = 0</span><br><span class="line"></span><br><span class="line">class Watcher&#123;</span><br><span class="line">    constructor(vm,keyOrFn,options = &#123;&#125;,cb) &#123;</span><br><span class="line">        this.id = id++ // 唯一ID</span><br><span class="line">        this.vm = vm</span><br><span class="line"><span class="addition">+        // 如果是一个字符串吗，则包装成一个方法</span></span><br><span class="line"><span class="addition">+        if(typeof keyOrFn === &#x27;string&#x27;)&#123;</span></span><br><span class="line"><span class="addition">+             this.getter = function ()&#123;</span></span><br><span class="line"><span class="addition">+                 return vm[keyOrFn]</span></span><br><span class="line"><span class="addition">+             &#125;</span></span><br><span class="line"><span class="addition">+         &#125;else&#123;</span></span><br><span class="line"><span class="addition">+             this.getter = keyOrFn // 这里存放多个dep，一个Watcher对应多个deps</span></span><br><span class="line"><span class="addition">+         &#125;</span></span><br><span class="line">        this.depts = []</span><br><span class="line">        this.deptSet = new Set()</span><br><span class="line">        this.lazy = options.lazy</span><br><span class="line">        // 用作计算属性的缓存，标记是否需要重新计算</span><br><span class="line">        this.dirty = this.lazy</span><br><span class="line">        // 由于watcher会默认执行一次get，会渲染一次页面，但是计算属性不需要一上来就执行渲染</span><br><span class="line">        // 所以这里判断，如果dirty为true，则不执行get，只有当dirty为false的时候才执行get，渲染页面</span><br><span class="line"><span class="addition">+        this.value = this.dirty ? undefined : this.get()</span></span><br><span class="line"><span class="addition">+        // 区分是否为用户自定义watcher</span></span><br><span class="line"><span class="addition">+        this.user = options.user</span></span><br><span class="line"><span class="addition">+        // 拿到watcher的回调</span></span><br><span class="line"><span class="addition">+        this.cb = cb</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ....省略其他代码</span><br><span class="line">    run()&#123;</span><br><span class="line">        console.log(&#x27;更新视图&#x27;)</span><br><span class="line"><span class="addition">+        let oldVal = this.value</span></span><br><span class="line"><span class="addition">+        let newVal = this.getter()</span></span><br><span class="line"><span class="addition">+        // 判断是否是用户自定义的watcher</span></span><br><span class="line"><span class="addition">+        if(this.user)&#123;</span></span><br><span class="line"><span class="addition">+            this.cb.call(this.vm,newVal,oldVal)</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ....省略其他代码</span><br><span class="line"></span><br><span class="line">export default Watcher</span><br></pre></td></tr></table></figure>

<h2 id="实现基本的diff算法"><a href="#实现基本的diff算法" class="headerlink" title="实现基本的diff算法"></a>实现基本的diff算法</h2><p>首先吧 <code>src/index.js</code> 中的 <code>$nextTick</code> 和 <code>$watch</code> 放在 <code>src/state.js</code> 文件中，并封装在 initStateMixin 方法内，并且导出</p>
<p>src/state.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Watcher, &#123;nextTick&#125; <span class="keyword">from</span> <span class="string">&quot;./observe/watcher.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initStateMixin</span>(<span class="params">Vue</span>)</span>&#123;</span><br><span class="line">    Vue.prototype.$nextTick = nextTick</span><br><span class="line">    Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params">expOrFn, cb</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Watcher(<span class="built_in">this</span>, expOrFn, &#123;<span class="attr">user</span>:<span class="literal">true</span>&#125;,cb)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>src/index.js</code> 导出并使用，并且下面添加了diff的测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;initMixin&#125; <span class="keyword">from</span> <span class="string">&quot;./init&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;initLifeCycle&#125; <span class="keyword">from</span> <span class="string">&quot;./lifecycle.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;initGlobalApi&#125; <span class="keyword">from</span> <span class="string">&quot;./globalApi.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;initStateMixin&#125; <span class="keyword">from</span> <span class="string">&quot;./state.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;compilerToFunction&#125; <span class="keyword">from</span> <span class="string">&quot;./compile/index.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createEle, patch&#125; <span class="keyword">from</span> <span class="string">&quot;./vdom/patch.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">initLifeCycle(Vue)</span><br><span class="line">initGlobalApi(Vue)</span><br><span class="line">initStateMixin(Vue)</span><br><span class="line"></span><br><span class="line"><span class="comment">//----------测试diff算法---------------</span></span><br><span class="line"><span class="keyword">let</span> render1 = compilerToFunction(<span class="string">&quot;&lt;div style=&#x27;color: red&#x27;&gt;&lt;/div&gt;&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> vm1 = <span class="keyword">new</span> Vue(&#123;<span class="attr">data</span>:&#123;<span class="attr">name</span>:<span class="string">&quot;张三&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="keyword">let</span> prevVNode = render1.call(vm1)</span><br><span class="line"><span class="keyword">let</span> el = createEle(prevVNode)</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(el)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> render2 = compilerToFunction(<span class="string">`&lt;div style=&#x27;background-color: blue;color: white&#x27;&gt;</span></span><br><span class="line"><span class="string"> &lt;h2&gt;&#123;&#123;name&#125;&#125;&lt;/h2&gt;</span></span><br><span class="line"><span class="string"> &lt;h3&gt;&#123;&#123;name&#125;&#125;&lt;/h3&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;`</span>)</span><br><span class="line"><span class="keyword">let</span> vm2 = <span class="keyword">new</span> Vue(&#123;<span class="attr">data</span>:&#123;<span class="attr">name</span>:<span class="string">&quot;李四&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="keyword">let</span> newVNode = render2.call(vm2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(prevVNode)</span><br><span class="line">    <span class="built_in">console</span>.log(newVNode)</span><br><span class="line">    patch(prevVNode,newVNode)</span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>

<p>上面代码生成了两个虚拟节点，然后倒计时1秒后进行更新</p>
<p>在 <code>src/vdom/patch.js</code> 中对节点进行比较</p>
<p>下面的代码在patchVNode完成新节点和旧节点的对比</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;isSameVNode&#125; <span class="keyword">from</span> <span class="string">&quot;./index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVNode,newVNode</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否是一个真实元素,如果是真实DOM会返回1</span></span><br><span class="line">    <span class="keyword">const</span> isRealEle = oldVNode.nodeType;</span><br><span class="line">    <span class="comment">// 初次渲染</span></span><br><span class="line">    <span class="keyword">if</span>(isRealEle)&#123;</span><br><span class="line">        <span class="comment">// 获取真实元素</span></span><br><span class="line">        <span class="keyword">const</span> elm = oldVNode</span><br><span class="line">        <span class="comment">// 获取真实元素的父元素</span></span><br><span class="line">        <span class="keyword">const</span> parentElm = elm.parentNode</span><br><span class="line">        <span class="comment">// 创建新的虚拟节点</span></span><br><span class="line">        <span class="keyword">let</span> newRealEl = createEle(newVNode)</span><br><span class="line">        <span class="comment">// 把新的虚拟节点插入到真实元素后面</span></span><br><span class="line">        parentElm.insertBefore(newRealEl,elm.nextSibling)</span><br><span class="line">        <span class="comment">// 然后删除之前的DOM</span></span><br><span class="line">        parentElm.removeChild(elm)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 对比新旧节点</span></span><br><span class="line">        patchVNode(oldVNode,newVNode)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据虚拟dom渲染真实的dom</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createEle</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;tag,data,children,text&#125; = vnode</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createElement(tag)</span><br><span class="line">        <span class="comment">// 处理节点的属性</span></span><br><span class="line">        patchProps(vnode.el,&#123;&#125;,data)</span><br><span class="line">        <span class="comment">// 递归处理子元素</span></span><br><span class="line">        children.forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123;</span><br><span class="line">            child &amp;&amp; vnode.el.appendChild(createEle(child))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createTextNode(text)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode.el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给节点添加属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchProps</span>(<span class="params">el,oldProps = &#123;&#125;,props</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> oldPropsStyle = oldProps.style</span><br><span class="line">    <span class="keyword">let</span> newPropsStyle = props.style</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断如果新节点上没有旧节点的样式，则应该吧原来的样式清空掉</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldPropsStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!newPropsStyle[key])&#123;</span><br><span class="line">            el.style[key] = <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断旧节点的属性在新节点是否存在</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!props[key])&#123;</span><br><span class="line">            el.removeAttribute(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">        <span class="keyword">if</span>(key === <span class="string">&quot;style&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Object</span>.keys(props.style).forEach(<span class="function"><span class="params">sty</span>=&gt;</span>&#123;</span><br><span class="line">                el.style[sty] = props.style[sty]</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            el.setAttribute(key,props[key])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对比新旧节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchVNode</span>(<span class="params">oldVNode,newVNode</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 进行diff算法，对比新老节点</span></span><br><span class="line">    <span class="comment">// 对比两个节点的tag和key是否一样，如果不一样，则直接吧老的替换掉，换成新的节点</span></span><br><span class="line">    <span class="keyword">if</span>(!isSameVNode(oldVNode,newVNode))&#123;</span><br><span class="line">        <span class="keyword">let</span> el = createEle(newVNode)</span><br><span class="line">        oldVNode.el.parentNode.replaceChild(el,oldVNode.el)</span><br><span class="line">        <span class="keyword">return</span> el</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 一样的情况对DOM元素进行复用</span></span><br><span class="line">    <span class="keyword">let</span> el = newVNode.el = oldVNode.el  </span><br><span class="line">    <span class="comment">// 如果一样，则还需要判断一下文本的情况</span></span><br><span class="line">    <span class="keyword">if</span>(!oldVNode.tag)&#123;</span><br><span class="line">        <span class="keyword">if</span>(oldVNode.text !== newVNode.text)&#123;</span><br><span class="line">            el.textContent = newVNode.text</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比较新节点和旧节点的属性是否一致</span></span><br><span class="line">    patchProps(el,oldVNode.data,newVNode.data)</span><br><span class="line">    <span class="comment">// 然后比较新旧节点的儿子节点</span></span><br><span class="line">    <span class="keyword">let</span> oldVNodeChildren = oldVNode.children || []</span><br><span class="line">    <span class="keyword">let</span> newVNodeChildren = newVNode.children || []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(oldVNodeChildren.length &gt; <span class="number">0</span> &amp;&amp; newVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 进行完整的diff算法</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;进行完整的diff算法&quot;</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(newVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 这里表示老节点没有儿子，但是新节点有，需要遍历新节点的每一个儿子，放在新节点中</span></span><br><span class="line">        mountChildren(el,newVNodeChildren)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(oldVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 这里表示新节点没有儿子，但是老节点有，需要吧老节点的儿子删除掉</span></span><br><span class="line">        unMountChildren(el,oldVNodeChildren)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">el,children</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> child <span class="keyword">of</span> children) &#123;</span><br><span class="line">        el.appendChild(createEle(child))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unMountChildren</span>(<span class="params">el,children</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 直接删除老节点的子元素</span></span><br><span class="line">    el.innerHTML = <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现完整的diff算法"><a href="#实现完整的diff算法" class="headerlink" title="实现完整的diff算法"></a>实现完整的diff算法</h2><p>这里我们来完成当旧节点和新节点都有子元素时，进行互相对比。</p>
<p>在Vue2中使用了双指针来进行子元素之间的对比，一个指针指向第一个节点，一个指针指向最后一个节点，比较一次后，首指针往后移动一位，当首指针大于尾指针时，比较结束</p>
<p><code>patch.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;isSameVNode&#125; <span class="keyword">from</span> <span class="string">&quot;./index.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">oldVNode,newVNode</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否是一个真实元素,如果是真实DOM会返回1</span></span><br><span class="line">    <span class="keyword">const</span> isRealEle = oldVNode.nodeType;</span><br><span class="line">    <span class="comment">// 初次渲染</span></span><br><span class="line">    <span class="keyword">if</span>(isRealEle)&#123;</span><br><span class="line">        <span class="comment">// 获取真实元素</span></span><br><span class="line">        <span class="keyword">const</span> elm = oldVNode</span><br><span class="line">        <span class="comment">// 获取真实元素的父元素</span></span><br><span class="line">        <span class="keyword">const</span> parentElm = elm.parentNode</span><br><span class="line">        <span class="comment">// 创建新的虚拟节点</span></span><br><span class="line">        <span class="keyword">let</span> newRealEl = createEle(newVNode)</span><br><span class="line">        <span class="comment">// 把新的虚拟节点插入到真实元素后面</span></span><br><span class="line">        parentElm.insertBefore(newRealEl,elm.nextSibling)</span><br><span class="line">        <span class="comment">// 然后删除之前的DOM</span></span><br><span class="line">        parentElm.removeChild(elm)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        patchVNode(oldVNode,newVNode)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createEle</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;tag,data,children,text&#125; = vnode</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createElement(tag)</span><br><span class="line">        <span class="comment">// 处理节点的属性</span></span><br><span class="line">        patchProps(vnode.el,&#123;&#125;,data)</span><br><span class="line">        <span class="comment">// 递归处理子元素</span></span><br><span class="line">        children.forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123;</span><br><span class="line">            child &amp;&amp; vnode.el.appendChild(createEle(child))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createTextNode(text)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode.el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchProps</span>(<span class="params">el,oldProps = &#123;&#125;,props = &#123;&#125;</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> oldPropsStyle = oldProps.style</span><br><span class="line">    <span class="keyword">let</span> newPropsStyle = props.style</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断如果新节点上没有旧节点的样式，则应该吧原来的样式清空掉</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldPropsStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!newPropsStyle[key])&#123;</span><br><span class="line">            el.style[key] = <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断旧节点的属性在新节点是否存在</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!props[key])&#123;</span><br><span class="line">            el.removeAttribute(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">        <span class="keyword">if</span>(key === <span class="string">&quot;style&quot;</span>)&#123;</span><br><span class="line">            <span class="built_in">Object</span>.keys(props.style).forEach(<span class="function"><span class="params">sty</span>=&gt;</span>&#123;</span><br><span class="line">                el.style[sty] = props.style[sty]</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            el.setAttribute(key,props[key])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchVNode</span>(<span class="params">oldVNode,newVNode</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 进行diff算法，对比新老节点</span></span><br><span class="line">    <span class="comment">// 对比两个节点的tag和key是否一样，如果不一样，则直接吧老的替换掉，换成新的节点</span></span><br><span class="line">    <span class="keyword">if</span>(!isSameVNode(oldVNode,newVNode))&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(oldVNode,<span class="string">&#x27;oldVNode&#x27;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(newVNode,<span class="string">&#x27;newVNode&#x27;</span>)</span><br><span class="line">        <span class="keyword">let</span> el = createEle(newVNode)</span><br><span class="line">        oldVNode.el.parentNode.replaceChild(el,oldVNode.el)</span><br><span class="line">        <span class="keyword">return</span> el</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 一样的情况对DOM元素进行复用</span></span><br><span class="line">    <span class="keyword">let</span> el = newVNode.el = oldVNode.el</span><br><span class="line">    <span class="comment">// 如果一样，则还需要判断一下文本的情况</span></span><br><span class="line">    <span class="keyword">if</span>(!oldVNode.tag)&#123;</span><br><span class="line">        <span class="keyword">if</span>(oldVNode.el.text !== newVNode.text)&#123;</span><br><span class="line">            oldVNode.el.text = newVNode.text</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比较新节点和旧节点的属性是否一致</span></span><br><span class="line">    patchProps(el,oldVNode.data,newVNode.data)</span><br><span class="line">    <span class="comment">// 然后比较新旧节点的儿子节点</span></span><br><span class="line">    <span class="keyword">let</span> oldVNodeChildren = oldVNode.children || []</span><br><span class="line">    <span class="keyword">let</span> newVNodeChildren = newVNode.children || []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(oldVNodeChildren.length &gt; <span class="number">0</span> &amp;&amp; newVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 声明两个指针，分别指向头节点和尾节点</span></span><br><span class="line">        <span class="comment">// 然后进行对比，当旧node的头节点和新node的头节点相同时，则进行头指针往后移动</span></span><br><span class="line">        <span class="comment">// 当头指针大于尾指针时停止循环</span></span><br><span class="line">        <span class="keyword">let</span> oldStartIndex = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> oldEndIndex = oldVNodeChildren.length - <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> oldStartNode = oldVNodeChildren[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">let</span> oldEndNode = oldVNodeChildren[oldEndIndex]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> newStartIndex = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> newEndIndex = newVNodeChildren.length - <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> newStartNode = newVNodeChildren[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">let</span> newEndNode = newVNodeChildren[newEndIndex]</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加一个映射表</span></span><br><span class="line">        <span class="keyword">let</span> nodeMap = &#123;&#125;</span><br><span class="line">        oldVNodeChildren.forEach(<span class="function">(<span class="params">child,index</span>)=&gt;</span>&#123;</span><br><span class="line">            nodeMap[child.key] = index</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (oldStartIndex &lt;= oldEndIndex &amp;&amp; newStartIndex &lt;= newEndIndex)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!oldStartNode)&#123;</span><br><span class="line">                oldStartNode = oldVNodeChildren[++oldStartIndex]</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!oldEndNode)&#123;</span><br><span class="line">                oldEndNode = oldVNodeChildren[--oldEndIndex]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 1.进行头头对比</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(isSameVNode(oldStartNode,newStartNode))&#123;</span><br><span class="line">                <span class="comment">// 递归更新子节点</span></span><br><span class="line">                patchVNode(oldStartNode,newStartNode)</span><br><span class="line">                oldStartNode = oldVNodeChildren[++oldStartIndex]</span><br><span class="line">                newStartNode = newVNodeChildren[++newStartIndex]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2.进行尾尾对比</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(isSameVNode(oldEndNode,newEndNode))&#123;</span><br><span class="line">                <span class="comment">// 递归更新子节点</span></span><br><span class="line">                patchVNode(oldEndNode,newEndNode)</span><br><span class="line">                oldEndNode = oldVNodeChildren[--oldEndIndex]</span><br><span class="line">                newEndNode = newVNodeChildren[--newEndIndex]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.进行尾头</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(isSameVNode(oldEndNode,newStartNode))&#123;</span><br><span class="line">                patchVNode(oldEndNode,newStartNode)</span><br><span class="line">                <span class="comment">// 如果旧节点的尾节点和新节点的头节点相同，则吧把旧节点的尾节点放在头节点之前</span></span><br><span class="line">                <span class="comment">// 然后把旧的尾指针往前移动，新节点的头指针往后移动</span></span><br><span class="line">                el.insertBefore(oldEndNode.el,oldStartNode.el)</span><br><span class="line">                oldEndNode = oldVNodeChildren[--oldEndIndex]</span><br><span class="line">                newStartNode = newVNodeChildren[++newStartIndex]</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4.进行头尾对比</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(isSameVNode(oldStartNode,newEndNode))&#123;</span><br><span class="line">                patchVNode(oldStartNode,newEndNode)</span><br><span class="line">                <span class="comment">// 如果旧节点的头和新节点的尾相同，则吧旧节点的头节点放在尾节点后</span></span><br><span class="line">                <span class="comment">// 然后把旧的头指针往后移动，新节点的尾指针往前移动</span></span><br><span class="line">                el.insertBefore(oldStartNode.el,oldEndNode.el.nextSibling)</span><br><span class="line">                oldStartNode = oldVNodeChildren[++oldStartIndex]</span><br><span class="line">                newEndNode = newVNodeChildren[--newEndIndex]</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 5.进行乱序查找</span></span><br><span class="line">                <span class="keyword">let</span> oldNodeIndex = nodeMap[newStartNode.key]</span><br><span class="line">                <span class="keyword">if</span>(oldNodeIndex !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">                    <span class="keyword">let</span> moveNode = oldVNodeChildren[oldNodeIndex]</span><br><span class="line">                    el.insertBefore(moveNode.el,oldStartNode.el)</span><br><span class="line">                    oldVNodeChildren[oldNodeIndex] = <span class="literal">undefined</span></span><br><span class="line">                    patchVNode(moveNode,newStartNode)</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    el.insertBefore(createEle(newStartNode),oldStartNode.el)</span><br><span class="line">                &#125;</span><br><span class="line">                newStartNode = newVNodeChildren[++newStartIndex]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环结束后，如果新节点的头指针小于等于新节点的尾指针</span></span><br><span class="line">        <span class="comment">// 说明新节点是有多出来的内容，则要把新节点多出来的push到现有节点的后面</span></span><br><span class="line">        <span class="keyword">if</span>(newStartIndex &lt;= newEndIndex)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = newStartIndex; i &lt;= newEndIndex; i++) &#123;</span><br><span class="line">                <span class="comment">// 如果尾指针的下一个节点有值，说明是新节点的前面有多出来的节点</span></span><br><span class="line">                <span class="comment">// 需要吧新的节点插入到前面去</span></span><br><span class="line">                <span class="keyword">let</span> anchor = newVNodeChildren[newEndIndex + <span class="number">1</span>] ? newVNodeChildren[newEndIndex + <span class="number">1</span>].el : <span class="literal">null</span></span><br><span class="line">                <span class="comment">// 吧新节点插入到anchor的前面</span></span><br><span class="line">                el.insertBefore(createEle(newVNodeChildren[i]),anchor)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果旧节点的头指针小于等于旧节点的尾指针，则说明旧的有多的节点，需要删除掉</span></span><br><span class="line">        <span class="keyword">if</span>(oldStartIndex &lt;= oldEndIndex)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = oldStartIndex; i &lt;= oldEndIndex; i++) &#123;</span><br><span class="line">               <span class="keyword">let</span> chilEl = oldVNodeChildren[i]</span><br><span class="line">               chilEl &amp;&amp; el.removeChild(chilEl.el)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(newVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 这里表示老节点没有儿子，但是新节点有，需要遍历新节点的每一个儿子，放在新节点中</span></span><br><span class="line">        mountChildren(el,newVNodeChildren)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(oldVNodeChildren.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 这里表示新节点没有儿子，但是老节点有，需要吧老节点的儿子删除掉</span></span><br><span class="line">        unMountChildren(el,oldVNodeChildren)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">el,children</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> child <span class="keyword">of</span> children) &#123;</span><br><span class="line">        el.appendChild(createEle(child))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unMountChildren</span>(<span class="params">el,children</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 直接删除老节点的子元素</span></span><br><span class="line">    el.innerHTML = <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下，手动的编写两个虚拟节点进行比对</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//----------测试diff算法---------------</span></span><br><span class="line"><span class="keyword">let</span> render1 = compilerToFunction(<span class="string">`&lt;div style=&#x27;color: red&#x27;&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;a&quot;&gt;a&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;b&quot;&gt;b&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;c&quot;&gt;c&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;d&quot;&gt;d&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;`</span>)</span><br><span class="line"><span class="keyword">let</span> vm1 = <span class="keyword">new</span> Vue(&#123;<span class="attr">data</span>:&#123;<span class="attr">name</span>:<span class="string">&quot;张三&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="keyword">let</span> prevVNode = render1.call(vm1)</span><br><span class="line"><span class="keyword">let</span> el = createEle(prevVNode)</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(el)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> render2 = compilerToFunction(<span class="string">`&lt;div style=&#x27;background-color: blue;color: white&#x27;&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;f&quot;&gt;f&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;e&quot;&gt;e&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;c&quot;&gt;c&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;n&quot;&gt;n&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;a&quot;&gt;a&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;m&quot;&gt;m&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li key=&quot;j&quot;&gt;j&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;`</span>)</span><br><span class="line"><span class="keyword">let</span> vm2 = <span class="keyword">new</span> Vue(&#123;<span class="attr">data</span>:&#123;<span class="attr">name</span>:<span class="string">&quot;李四&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="keyword">let</span> newVNode = render2.call(vm2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(prevVNode)</span><br><span class="line">    <span class="built_in">console</span>.log(newVNode)</span><br><span class="line">    patch(prevVNode,newVNode)</span><br><span class="line">&#125;,<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231209155828082.png" alt="image-20231209155828082"></p>
<p>倒计时一秒后会自动变成新的</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231209155858400.png" alt="image-20231209155858400"></p>
<p>但是我们肯定不能使用这种方式来实现页面的更新和diff，需要在修改完数据后，在update中进行新旧节点的diff</p>
<p>修改 <code>lifecycle.js</code>  文件中的 update 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新视图方法</span></span><br><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="built_in">this</span></span><br><span class="line">    <span class="keyword">const</span> el = vm.$el</span><br><span class="line">    <span class="keyword">const</span> preVNode = vm._vnode</span><br><span class="line">    vm._vnode = vnode</span><br><span class="line">    <span class="keyword">if</span>(preVNode)&#123;</span><br><span class="line">        <span class="comment">// 第二个渲染，用两个虚拟节点进行diff</span></span><br><span class="line">        vm.$el = patch(preVNode,vnode)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 第一次渲染页面，用虚拟节点直接覆盖真实DOM</span></span><br><span class="line">        vm.$el = patch(el,vnode)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看效果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/diff.gif"></p>
<p>通过动画我们可以看到每次更新时只有里面的文字变化，其他元素并不会重新渲染</p>
<h2 id="自定义组件实现原理"><a href="#自定义组件实现原理" class="headerlink" title="自定义组件实现原理"></a>自定义组件实现原理</h2><p>vue中可以声明自定义组件和全局组件，当自定义组件和全局组件重名时，会优先使用自定义组件。</p>
<p>在源码中，主要靠 Vue.extend 方法来实现</p>
<p>例如如下写法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&quot;my-button&quot;</span>,&#123;</span><br><span class="line">    template:<span class="string">&quot;&lt;button&gt;全局的组件&lt;/button&gt;&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Sub = Vue.extend(&#123;</span><br><span class="line">    template:<span class="string">&quot;&lt;button&gt;子组件 &lt;my-button&gt;&lt;/my-button&gt;&lt;/button&gt;&quot;</span>,</span><br><span class="line">    components:&#123;</span><br><span class="line">        <span class="string">&quot;my-button&quot;</span>:&#123;</span><br><span class="line">            template:<span class="string">&quot;&lt;button&gt;子组件自己声明的button&lt;/button&gt;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Sub().$mount(<span class="string">&quot;#app&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>页面展示的效果</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231209232538794.png" alt="image-20231209232538794"></p>
<p>我们来实现这个源码</p>
<p>在 <code>globalApi.js</code>  文件中添加方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;mergeOptions&#125; <span class="keyword">from</span> <span class="string">&quot;./utils.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initGlobalApi</span>(<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 添加一个静态方法 mixin</span></span><br><span class="line">    Vue.options = &#123;</span><br><span class="line">        <span class="comment">// 添加一个属性，记录Vue实例</span></span><br><span class="line">        _base:Vue</span><br><span class="line">    &#125;</span><br><span class="line">    Vue.mixin = <span class="function"><span class="keyword">function</span> (<span class="params">mixin</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.options = mergeOptions(<span class="built_in">this</span>.options, mixin)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vue.extend = <span class="function"><span class="keyword">function</span> (<span class="params">options</span>)</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">Sub</span>(<span class="params">options = &#123;&#125;</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>._init(options)</span><br><span class="line">        &#125;</span><br><span class="line">        Sub.prototype = <span class="built_in">Object</span>.create(Vue.prototype)</span><br><span class="line">        Sub.prototype.constructor = Sub</span><br><span class="line">        Sub.options = mergeOptions(Vue.options,options)</span><br><span class="line">        <span class="keyword">return</span> Sub</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vue.options.components = &#123;&#125;</span><br><span class="line">    Vue.component = <span class="function"><span class="keyword">function</span> (<span class="params">id,options</span>)</span>&#123;</span><br><span class="line">        options = <span class="keyword">typeof</span> options === <span class="string">&quot;function&quot;</span> ? options : Vue.extend(options)</span><br><span class="line">        Vue.options.components[id] = options</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>utils.js</code> 文件中添加组件合并策略，实现先找自身声明的组件，找不到再去原型链上找全局声明的组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一些策略，例如 created，beforeCreated 等，不需要写大量的if判断</span></span><br><span class="line"><span class="keyword">const</span> strats = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> LIFECYCLE = [</span><br><span class="line">    <span class="string">&quot;beforeCreated&quot;</span>,</span><br><span class="line">    <span class="string">&quot;created&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">LIFECYCLE.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    strats[key] = <span class="function"><span class="keyword">function</span> (<span class="params">p, c</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p) &#123;</span><br><span class="line">                <span class="keyword">return</span> p.concat(c)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> [c]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> p</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加组件合并策略</span></span><br><span class="line">strats.components = <span class="function"><span class="keyword">function</span> (<span class="params">parentVal, childVal</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Object</span>.create(parentVal)</span><br><span class="line">    <span class="keyword">if</span>(childVal)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> childVal) &#123;</span><br><span class="line">            res[key] = childVal[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并属性的方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params">parent, child</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;&#125;</span><br><span class="line">    <span class="comment">// 先获取父亲的值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">        mergeField(key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> child) &#123;</span><br><span class="line">        <span class="comment">// 如果父亲里面没有这个子属性，在进行合并子的</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 示例：父亲：&#123;a:1&#125; 儿子:&#123;a:2&#125;</span></span><br><span class="line"><span class="comment">         *      儿子中也有父亲的属性a，所以不会走儿子中的合并方法，但是在取值的时候，优先取的是儿子身上的属性值</span></span><br><span class="line"><span class="comment">         *      所以合并到一个对象中时，儿子会覆盖父亲</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!parent.hasOwnProperty(key)) &#123;</span><br><span class="line">            mergeField(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strats[key]) &#123;</span><br><span class="line">            <span class="comment">// &#123;created:fn&#125; &#123;&#125;</span></span><br><span class="line">            <span class="comment">// 合并声明周期上的方法，例如：beforeCreated,created</span></span><br><span class="line">            options[key] = strats[key](parent[key], child[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 先拿到儿子的值</span></span><br><span class="line">            options[key] = child[key] || parent[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步实现了组件按照原型链查找，通过打断点可以看到</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231209233451718.png" alt="image-20231209233451718"></p>
<p>接着修改 <code>src/vdom/index.js</code>  文件，增加创建自定义组件的虚拟节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是原生标签</span></span><br><span class="line"><span class="keyword">let</span> isReservedTag = <span class="function">(<span class="params">tag</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;div&quot;</span>, <span class="string">&quot;span&quot;</span>, <span class="string">&quot;button&quot;</span>, <span class="string">&quot;ul&quot;</span>, <span class="string">&quot;li&quot;</span>, <span class="string">&quot;h1&quot;</span>, <span class="string">&quot;h2&quot;</span>, <span class="string">&quot;h3&quot;</span>, <span class="string">&quot;h4&quot;</span>, <span class="string">&quot;h5&quot;</span>, <span class="string">&quot;h6&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;input&quot;</span>, <span class="string">&quot;img&quot;</span>].includes(tag)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建虚拟节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElementVNode</span>(<span class="params">vm, tag, prop, ...children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!prop) &#123;</span><br><span class="line">        prop = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> key = prop.key</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        <span class="keyword">delete</span> prop.key</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isReservedTag(tag)) &#123;</span><br><span class="line">        <span class="keyword">return</span> vnode(vm, tag, prop, key, children, <span class="literal">undefined</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建组件的虚拟节点</span></span><br><span class="line">        <span class="keyword">return</span> createTemplateVNode(vm, tag, prop, key, children)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTemplateVNode</span>(<span class="params">vm, tag, data, key, children</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> Core = vm.$options.components[tag]</span><br><span class="line">    <span class="comment">// 这里有两种情况，如果是自己组件本身定义的一个子组件，则拿到的直接是一个对象，里面有一个template</span></span><br><span class="line">    <span class="comment">// 否则会往原型链上找，找到的是通过 Vue.component 定义的组件，拿到的是一个Sub构造函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> Core === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 需要将对象变成Sub构造函数</span></span><br><span class="line">        Core = vm.$options._base.extend(Core)</span><br><span class="line">    &#125;</span><br><span class="line">    data.hook = &#123;</span><br><span class="line">        <span class="function"><span class="title">init</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode(vm, tag, data, key, children = [], <span class="literal">undefined</span>, Core)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建文本节点</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createTextVNode</span>(<span class="params">vm, text</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vnode(vm, <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">vnode</span>(<span class="params">vm, tag, data, key, children = [], text, componentsOptions</span>) </span>&#123;</span><br><span class="line">    children = children.filter(<span class="built_in">Boolean</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        vm,</span><br><span class="line">        tag,</span><br><span class="line">        data,</span><br><span class="line">        key,</span><br><span class="line">        children,</span><br><span class="line">        text,</span><br><span class="line">        componentsOptions</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断两个节点是否一致</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isSameVNode</span>(<span class="params">oldVNode, newVNode</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 对比两个节点的tag和key是否都一样，如果都一样，就认为这两个节点是一样的</span></span><br><span class="line">    <span class="keyword">return</span> oldVNode.tag === newVNode.tag &amp;&amp; oldVNode.key === newVNode.key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现组件渲染功能"><a href="#实现组件渲染功能" class="headerlink" title="实现组件渲染功能"></a>实现组件渲染功能</h2><p>上面我们根据tag判断是否是一个组件，并且添加了一个 createTemplateVNode 方法，返回组件的虚拟节点vnode。</p>
<p>然后需要在 <code>src/vdom/patch.js</code> 文件的 createEle 生成真实节点的方法中添加判断，是否是虚拟节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComponent</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i = vnode.data</span><br><span class="line">    <span class="keyword">if</span>((i=i.hook) &amp;&amp; (i=i.init))&#123;</span><br><span class="line">        i(vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(vnode.componentsInstance)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createEle</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;tag,data,children,text&#125; = vnode</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&quot;string&quot;</span>)&#123;</span><br><span class="line">        <span class="comment">// 判断是否是组件</span></span><br><span class="line">        <span class="keyword">if</span>(createComponent(vnode))&#123;</span><br><span class="line">            <span class="keyword">return</span> vnode.componentsInstance.$el</span><br><span class="line">        &#125;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createElement(tag)</span><br><span class="line">        <span class="comment">// 处理节点的属性</span></span><br><span class="line">        patchProps(vnode.el,&#123;&#125;,data)</span><br><span class="line">        <span class="comment">// 递归处理子元素</span></span><br><span class="line">        children.forEach(<span class="function"><span class="params">child</span>=&gt;</span>&#123;</span><br><span class="line">            child &amp;&amp; vnode.el.appendChild(createEle(child))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        vnode.el = <span class="built_in">document</span>.createTextNode(text)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode.el</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 createComponent 方法中就会去调用在上面 createTemplateVNode 方法中定义的 init 方法，并把当前的 vnode 传递过去</p>
<p>这时需要在init方法中接收这个vnode，并去new 这个 vnode 的 componentsOptions 中的 Core，这里的Core也就是 Vue.extend</p>
<p>修改 <code>src/vdom/index.js</code> 中的 createTemplateVNode 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTemplateVNode</span>(<span class="params">vm, tag, data, key, children</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从全局中的component中获取对应的组件，应为之前已经合并过了，所以这里可以直接获取</span></span><br><span class="line">    <span class="keyword">let</span> Core = vm.$options.components[tag]</span><br><span class="line">    <span class="comment">// 这里有两种情况，如果是自己组件本身定义的一个子组件，则拿到的直接是一个对象，里面有一个template</span></span><br><span class="line">    <span class="comment">// 否则会往原型链上找，找到的是通过 Vue.component 定义的组件，拿到的是一个Sub构造函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> Core === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 需要将对象变成Sub构造函数</span></span><br><span class="line">        Core = vm.$options._base.extend(Core)</span><br><span class="line">    &#125;</span><br><span class="line">    data.hook = &#123;</span><br><span class="line">        <span class="function"><span class="title">init</span>(<span class="params">vnode</span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 从返回的vnode上获取componentsOptions中的Core</span></span><br><span class="line">            <span class="keyword">let</span> instance = vnode.componentsInstance = <span class="keyword">new</span> vnode.componentsOptions.Core</span><br><span class="line">            instance.$mount()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode(vm, tag, data, key, children = [], <span class="literal">undefined</span>, &#123;Core&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>new 完 Core 后返回的实例同时赋值给当前vnode的componentsInstance上和局部变量instance</p>
<p>然后使用 instance 再去调用 $mount 方法，会触发 patch 方法，但是这里并没有传递参数，所以就需要在 patch 方法中添加一个判断，如果没有旧节点，直接创建新的节点并返回</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">export function patch(oldVNode,newVNode)&#123;</span><br><span class="line"><span class="addition">+    if(!oldVNode)&#123;</span></span><br><span class="line"><span class="addition">+        return createEle(newVNode)</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line">    // 判断是否是一个真实元素,如果是真实DOM会返回1</span><br><span class="line">    const isRealEle = oldVNode.nodeType;</span><br><span class="line">    // 初次渲染</span><br><span class="line">    if(isRealEle)&#123;</span><br><span class="line">        // 获取真实元素</span><br><span class="line">        const elm = oldVNode</span><br><span class="line">        // 获取真实元素的父元素</span><br><span class="line">        const parentElm = elm.parentNode</span><br><span class="line">        // 创建新的虚拟节点</span><br><span class="line">        let newRealEl = createEle(newVNode)</span><br><span class="line">        // 把新的虚拟节点插入到真实元素后面</span><br><span class="line">        parentElm.insertBefore(newRealEl,elm.nextSibling)</span><br><span class="line">        // 然后删除之前的DOM</span><br><span class="line">        parentElm.removeChild(elm)</span><br><span class="line">        // 返回渲染后的虚拟节点</span><br><span class="line">        return newRealEl</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return patchVNode(oldVNode,newVNode)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是用我们自己的vue.js来看一下实现的效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;updateAge()&quot;</span>&gt;</span>更新<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&quot;my-button&quot;</span>,&#123;</span><br><span class="line">    template:<span class="string">&quot;&lt;button&gt;全局的组件&lt;/button&gt;&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Sub = Vue.extend(&#123;</span><br><span class="line">    template:<span class="string">&quot;&lt;button&gt;子组件 &lt;my-button&gt;&lt;/my-button&gt;&lt;/button&gt;&quot;</span>,</span><br><span class="line">    components:&#123;</span><br><span class="line">        <span class="string">&quot;my-button&quot;</span>:&#123;</span><br><span class="line">            template:<span class="string">&quot;&lt;button&gt;子组件自己声明的button&lt;/button&gt;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Sub().$mount(<span class="string">&quot;#app&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/picgo/image-20231213221850414.png" alt="image-20231213221850414"></p>
<p>总结：</p>
<ul>
<li>创建子类构造函数的时候，会将全局的组件和自己身上定义的组件进行合并。（组件的合并，会优先查找自己身上的，找不到再去找全局的）</li>
<li>组件的渲染：开始渲染的时候组件会编译组件的模板（template 属性对应的 html）变成render函数，然后调用 render函数</li>
<li>createrElementVnode 会根据 tag 类型判断是否是自定义组件，如果是组件会创造出组件对应的虚拟节点（给组件增加一个初始化钩子，增加componentOptions选项 { Core }）</li>
<li>然后再创建组件的真实节点时。需要 new Core，然后使用返回的实例在去调用 $mount() 方法就可以完成组件的挂载</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">SZX</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://songzx0106.github.io/Vue/20231224/">https://songzx0106.github.io/Vue/20231224/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://SongZX0106.github.io" target="_blank">SZX的开发笔记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vue/">Vue</a></div><div class="post_share"><div class="social-share" data-image="/images/ys10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/share.min.css" media="print" onload="this.media='all'"><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.png" target="_blank"><img class="post-qr-code-img" data-lazy-src="/images/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="/images/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/JavaScript/%E4%BB%BFChatGPT%E5%85%89%E6%A0%87%E8%B7%9F%E9%9A%8F%E6%95%88%E6%9E%9C/"><img class="prev-cover" data-lazy-src="/images/ys07.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">仿ChatGPT光标跟随效果</div></div></a></div><div class="next-post pull-right"><a href="/NodeJs/231105/"><img class="next-cover" data-lazy-src="/images/ys18.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">网络请求</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/Vue/20221209160521/" title="ElementUI实现跨页多选表格"><img class="cover" data-lazy-src="/images/ys03.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-09</div><div class="title">ElementUI实现跨页多选表格</div></div></a></div><div><a href="/Vue/20230608/" title="实现网站自动监听更新"><img class="cover" data-lazy-src="/images/ys05.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-08</div><div class="title">实现网站自动监听更新</div></div></a></div><div><a href="/Vue/20230823/" title="Vue自定义好用的指令"><img class="cover" data-lazy-src="/images/ys02.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-23</div><div class="title">Vue自定义好用的指令</div></div></a></div><div><a href="/Vue/20230915/" title="实现瀑布流布局"><img class="cover" data-lazy-src="/images/ys10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-15</div><div class="title">实现瀑布流布局</div></div></a></div><div><a href="/Vue/20230925/" title="封装v-resize并发布到NPM"><img class="cover" data-lazy-src="/images/ys08.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-25</div><div class="title">封装v-resize并发布到NPM</div></div></a></div><div><a href="/Vue/202309251756/" title="自定义插件之全局Loading"><img class="cover" data-lazy-src="/images/ys12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-25</div><div class="title">自定义插件之全局Loading</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/images/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">SZX</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">157</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/szxio"><i class="iconfont icon-gitee-fill-round"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">welcome to my blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8rollup%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">使用rollup搭建开发环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">初始化数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">实现对象的响应式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%B0%E7%BB%84%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">实现数组的响应式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90HTML%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.</span> <span class="toc-text">解析HTML模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">代码生成的实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90render%E5%87%BD%E6%95%B0"><span class="toc-number">7.</span> <span class="toc-text">生成render函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%B9%B6%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE"><span class="toc-number">8.</span> <span class="toc-text">创建虚拟节点并更新视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86"><span class="toc-number">9.</span> <span class="toc-text">实现依赖收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0"><span class="toc-number">10.</span> <span class="toc-text">实现异步更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0mixin%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">11.</span> <span class="toc-text">实现mixin核心功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0"><span class="toc-number">12.</span> <span class="toc-text">实现数组更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7"><span class="toc-number">13.</span> <span class="toc-text">实现计算属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0watch%E7%9B%91%E5%90%AC"><span class="toc-number">14.</span> <span class="toc-text">实现watch监听</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E7%9A%84diff%E7%AE%97%E6%B3%95"><span class="toc-number">15.</span> <span class="toc-text">实现基本的diff算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%AE%8C%E6%95%B4%E7%9A%84diff%E7%AE%97%E6%B3%95"><span class="toc-number">16.</span> <span class="toc-text">实现完整的diff算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">17.</span> <span class="toc-text">自定义组件实现原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%8A%9F%E8%83%BD"><span class="toc-number">18.</span> <span class="toc-text">实现组件渲染功能</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Echarts/%E4%B8%96%E7%95%8C%E5%9C%B0%E5%9B%BE/" title="Echarts实现世界地图"><img data-lazy-src="/images/ys11.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Echarts实现世界地图"/></a><div class="content"><a class="title" href="/Echarts/%E4%B8%96%E7%95%8C%E5%9C%B0%E5%9B%BE/" title="Echarts实现世界地图">Echarts实现世界地图</a><time datetime="2025-02-11T01:32:03.000Z" title="发表于 2025-02-11 09:32:03">2025-02-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Vue/%E6%97%A0%E7%95%8C%E5%BE%AE%E5%89%8D%E7%AB%AF/" title="【无界】微前端技术应用"><img data-lazy-src="/images/ys10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【无界】微前端技术应用"/></a><div class="content"><a class="title" href="/Vue/%E6%97%A0%E7%95%8C%E5%BE%AE%E5%89%8D%E7%AB%AF/" title="【无界】微前端技术应用">【无界】微前端技术应用</a><time datetime="2025-01-17T06:31:13.000Z" title="发表于 2025-01-17 14:31:13">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/JavaScript/%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88HTML%E6%96%87%E4%BB%B6/" title="JS实现在线预览HTML文件"><img data-lazy-src="/images/ys20.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JS实现在线预览HTML文件"/></a><div class="content"><a class="title" href="/JavaScript/%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88HTML%E6%96%87%E4%BB%B6/" title="JS实现在线预览HTML文件">JS实现在线预览HTML文件</a><time datetime="2024-12-20T05:16:19.000Z" title="发表于 2024-12-20 13:16:19">2024-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Java/springboot/aop_log/" title="利用 Spring AOP 实现日志记录"><img data-lazy-src="/images/ys20.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用 Spring AOP 实现日志记录"/></a><div class="content"><a class="title" href="/Java/springboot/aop_log/" title="利用 Spring AOP 实现日志记录">利用 Spring AOP 实现日志记录</a><time datetime="2024-12-02T05:14:27.000Z" title="发表于 2024-12-02 13:14:27">2024-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Vue/ElementPlus%E5%AE%98%E7%BD%91%E7%9A%84%E9%BB%91%E7%99%BD%E5%88%87%E6%8D%A2%E6%95%88%E6%9E%9C/" title="使用vue3实现element-plus的主题切换特效"><img data-lazy-src="/images/ys16.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用vue3实现element-plus的主题切换特效"/></a><div class="content"><a class="title" href="/Vue/ElementPlus%E5%AE%98%E7%BD%91%E7%9A%84%E9%BB%91%E7%99%BD%E5%88%87%E6%8D%A2%E6%95%88%E6%9E%9C/" title="使用vue3实现element-plus的主题切换特效">使用vue3实现element-plus的主题切换特效</a><time datetime="2024-11-29T02:21:25.000Z" title="发表于 2024-11-29 10:21:25">2024-11-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/images/ys10.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By SZX</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">少年辛苦终身事，莫向光阴惰寸功。<a target="_blank" rel="noopener" href="https://gitee.com/szxio">My Gitee</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/instantpage.min.js" type="module"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'iJzt0X9OdhFCcdn4N0dJ86fY-gzGzoHsz',
      appKey: '8vtaRafgQSvU5ntYgszJfRW5',
      placeholder: '留下你的精彩评论',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/canvas-fluttering-ribbon.min.js"></script><script src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://szx-bucket1.oss-cn-hangzhou.aliyuncs.com/js/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,自由,平等,公正,法制,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>